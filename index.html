<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workbase - Enhanced Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary: #111827;
            --primary-dark: #0f172a;
            --surface: #ffffff;
            --muted-surface: #f4f5f7;
            --border: #e5e7eb;
            --border-strong: #0f172a;
            --text: #0b1324;
            --text-secondary: #4b5563;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 64px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            background: var(--muted-surface);
            color: var(--text);
        }

        i.ph {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* LAYOUT */
        .app-container {
            display: grid;
            grid-template-areas: "sidebar header" "sidebar main";
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease;
            background: var(--muted-surface);
        }
        .app-container.sidebar-collapsed { grid-template-columns: var(--sidebar-collapsed-width) 1fr; }
        .app-sidebar {
            grid-area: sidebar;
            background: #0f172a;
            color: white;
            border-right: 1px solid #111827;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .app-header {
            grid-area: header;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .app-main { grid-area: main; overflow: auto; background: var(--muted-surface); }
        
        /* SIDEBAR */
        .sidebar-header {
            padding: 18px 16px 18px 20px;
            border-bottom: 1px solid #2a2e38;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .sidebar-collapsed .sidebar-header { padding: 18px 10px; justify-content: center; }
        .sidebar-brand { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; transition: opacity 0.2s; }
        .sidebar-collapsed .sidebar-brand { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-toggle {
            background: transparent;
            border: 1px solid #2f343d;
            color: #e5e7eb;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-toggle:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #fff; }
        .sidebar-section { padding: 16px 12px 12px 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
            padding: 8px 12px 6px;
            margin-bottom: 6px;
            transition: opacity 0.2s;
        }
        .sidebar-collapsed .sidebar-section-title { opacity: 0; height: 0; overflow: hidden; margin: 0; }
        
        .set-item {
            margin-bottom: 4px;
        }
        
        .set-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            color: #cbd5e1;
            border: 1px solid transparent;
        }
        .set-header:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: #fff; }
        .set-header.active { background: #111827; color: #ffffff; border-color: #111827; box-shadow: none; }
        .set-icon { font-size: 18px; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; }
        .set-icon i, .view-item-icon i { font-size: 18px; }
        .set-name { flex: 1; transition: opacity 0.2s; font-weight: 600; letter-spacing: -0.01em; }
        .set-expand-icon { 
            font-size: 12px; 
            transition: transform 0.2s;
            opacity: 0.7;
        }
        .set-item.expanded .set-expand-icon { transform: rotate(90deg); }
        .sidebar-collapsed .set-name { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-collapsed .set-expand-icon { display: none; }
        .sidebar-collapsed .set-header { justify-content: center; padding: 10px; }
        
        .views-list {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            margin-left: 32px;
            margin-top: 6px;
        }
        .set-item.expanded .views-list {
            max-height: 500px;
            opacity: 1;
        }
        .sidebar-collapsed .views-list { display: none; }
        
        .view-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            position: relative;
        }
        .view-item:hover { background: #252931; color: #e5e7eb; }
        .view-item.active { background: #2f343d; color: #ffffff; font-weight: 600; }
        .view-item-icon { font-size: 16px; opacity: 0.9; }
        
        .add-view-btn {
            padding: 6px 12px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
            margin-top: 6px;
        }
        .add-view-btn:hover { background: #252931; color: #e5e7eb; }

        .new-set-btn {
            margin-top: auto;
            padding: 14px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: color 0.15s ease;
        }
        .new-set-btn:hover { color: #9ca3af; }
        
        /* TOOLBAR */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .toolbar .sort-sequence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            background: #f3f4f6;
            color: #4b5563;
            font-size: 13px;
        }
        
        .view-type-switcher {
            display: flex;
            gap: 8px;
        }

        .view-type-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: none;
        }

        .view-type-btn:hover { background: var(--muted-surface); border-color: var(--text); color: var(--text); }
        .view-type-btn.active { background: var(--primary); color: #ffffff; border-color: var(--primary); }
        
        /* CELLS */
        .cell-editable {
            min-height: 36px;
            padding: 12px 16px;
            cursor: text;
            border-right: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            position: relative;
        }
        .cell-editable:hover {
            background: linear-gradient(to right, transparent, rgba(59, 130, 246, 0.03), transparent);
            border-left: 2px solid rgba(59, 130, 246, 0.2);
        }
        .cell-editable:focus {
            outline: none;
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            border-radius: 4px;
        }
        .cell-recently-changed { animation: flash-yellow 0.5s ease-out; }
        @keyframes flash-yellow { 0% { background-color: #fef3c7; } 100% { background-color: transparent; } }
        
        /* TABLE HEADERS */
        .column-header {
            background: var(--surface);
            padding: 12px 16px;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
            user-select: none;
            position: relative;
        }
        .column-resizer {
            position: absolute;
            top: 0;
            right: -4px;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            z-index: 5;
        }
        body.resizing {
            cursor: col-resize;
        }
        .column-header:hover { background: var(--muted-surface); }

        body.column-dragging { cursor: grabbing; }
        .column-being-dragged { opacity: 0.5; }

        .column-drag-ghost {
            position: fixed;
            pointer-events: none;
            background: white;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            padding: 10px 14px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
            opacity: 0.95;
            z-index: 1200;
            transform: translate3d(0, 0, 0);
        }

        .column-drop-before::before,
        .column-drop-after::after {
            content: '';
            position: absolute;
            top: 6px;
            bottom: 6px;
            width: 3px;
            background: #cbd5e1;
            border-radius: 999px;
        }
        .column-drop-before::before { left: -2px; }
        .column-drop-after::after { right: -2px; }

        table { width: auto; border-collapse: collapse; table-layout: fixed; }
        thead { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
            min-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        th .sort-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 12px;
        }

        th .sort-indicator .order-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            border-radius: 999px;
            background: #e5e7eb;
            color: #111827;
            font-size: 11px;
            font-weight: 700;
        }

        th .sort-indicator .direction-icon { font-size: 10px; }

        th .sort-indicator.muted { opacity: 0.5; }
        tbody tr { border-bottom: 1px solid #f3f4f6; transition: background-color 0.1s ease; }
        tbody tr:hover { background: #f9fafb; }
        tbody tr:last-child { border-bottom: none; }
        td {
            padding: 16px;
            font-size: 14px;
            color: #1f2937;
            vertical-align: middle;
            min-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        td:first-child {
            color: #9ca3af;
            font-weight: 600;
            font-size: 13px;
            min-width: 60px;
        }
        tr:hover { background-color: #fafafa; }

        #dataTable thead th,
        #dataTable tbody td { background-clip: padding-box; transition: background-color 0.2s ease; }
        #dataTable thead th:nth-child(odd),
        #dataTable tbody td:nth-child(odd) { box-shadow: inset 0 0 0 9999px rgba(15, 23, 42, 0.012); }
        #dataTable thead th:nth-child(even),
        #dataTable tbody td:nth-child(even) { box-shadow: inset 0 0 0 9999px rgba(15, 23, 42, 0.024); }
        #dataTable tbody tr:nth-child(odd) { background-color: rgba(15, 23, 42, 0.02); }
        #dataTable tbody tr:nth-child(even) { background-color: rgba(15, 23, 42, 0.03); }
        #dataTable tbody tr:hover td { background: #f4f6fb; }
        #dataTable th:not(:last-child), #dataTable td:not(:last-child) { border-right: 1px solid #eef2f7; }
        .table-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            color: #4b5563;
            font-size: 13px;
        }
        .record-counter {
            font-weight: 700;
            color: #111827;
        }

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* CARD VIEW */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: none;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--border-strong);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .card-field {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .card-field-label {
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .card-field-value {
            color: #111827;
        }
        
        /* KANBAN VIEW */
        .kanban-board {
            display: flex;
            gap: 16px;
            padding: 20px;
            overflow-x: auto;
            min-height: calc(100vh - 200px);
        }
        
        .kanban-column {
            min-width: 300px;
            background: var(--muted-surface);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        
        .kanban-column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
        }
        
        .kanban-column-title {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }
        
        .kanban-column-count {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .kanban-cards {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 100px;
        }
        
        .kanban-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: move;
            transition: all 0.15s ease;
        }

        .kanban-card:hover {
            border-color: var(--border-strong);
        }
        
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .kanban-column.drag-over {
            background: #e0f2fe;
        }
        
        .kanban-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-size: 14px;
        }
        
        /* CONTEXT MENU */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }
        .context-menu-item {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover { background: #f3f4f6; }
        .context-menu-item.danger:hover { background: #fee2e2; color: #dc2626; }
        .context-menu-separator { height: 1px; background: #e5e7eb; margin: 4px 0; }
        
        /* MODALS */
        .modal-overlay { backdrop-filter: blur(2px); animation: fadeIn 0.2s ease; }
        .modal-container { border-radius: 8px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        #expandedRecordModal .modal-container { height: 90vh; }
        #addFieldModal .modal-container { max-width: 540px; width: 100%; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 24px 24px 16px 24px; border-bottom: 1px solid #f0f0f0; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f0f0f0; background: #fafafa; }
        #addFieldModal .modal-header { padding: 16px 18px 10px 18px; }
        #addFieldModal .modal-body { padding: 16px 18px 18px 18px; }
        #addFieldModal .modal-footer { padding: 14px 18px; background: #f8fafc; }
        .icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
        .icon-option { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; background: #ffffff; cursor: pointer; transition: all 0.15s ease; }
        .icon-option:hover { border-color: #d1d5db; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
        .icon-option.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
        .config-section { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease; margin-top: 0; }
        .config-section.visible { max-height: 500px; opacity: 1; margin-top: 16px; }

        /* POPUP CONFIGURATOR */
        .popup-config-shell { max-width: 1200px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 20px 24px; }
        .popup-config-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; padding: 0 0 12px 0; border-bottom: 1px solid #e2e8f0; background: transparent; }
        .popup-config-tabs { display: flex; gap: 4px; padding: 12px 0; border-bottom: 1px solid #e2e8f0; background: transparent; }
        .popup-config-tab { padding: 10px 14px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; display: inline-flex; gap: 8px; align-items: center; border-radius: 8px 8px 0 0; transition: all 0.2s ease; }
        .popup-config-tab:hover { color: #0f172a; background: #f8fafc; }
        .popup-config-tab.active { color: #1d4ed8; border-bottom-color: #1d4ed8; background: #eff6ff; }
        .popup-config-body { display: grid; grid-template-columns: 1fr 320px; gap: 20px; padding: 16px 0 0 0; background: #fff; flex: 1; overflow: hidden; }
        .popup-tab-panel { display: none; height: 100%; overflow: hidden; }
        .popup-tab-panel.active { display: block; }
        .popup-panel-scroll { height: 100%; overflow: auto; padding-right: 6px; }
        .popup-quick-filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
        .popup-filter { padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; color: #475569; font-weight: 600; transition: all 0.15s ease; }
        .popup-filter:hover { border-color: #cbd5e1; background: #f8fafc; }
        .popup-filter.active { background: #eef2ff; border-color: #1d4ed8; color: #1d4ed8; }
        .popup-info { display: flex; gap: 10px; padding: 12px; background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 8px; color: #1e3a8a; margin-bottom: 14px; font-size: 14px; }
        .popup-field-card { border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; background: #fff; transition: all 0.2s ease; }
        .popup-field-card:hover { border-color: #cbd5e1; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); }
        .popup-field-card.dragging { opacity: 0.6; }
        .popup-field-card.drag-over { border-color: #1d4ed8; background: #eef2ff; }
        .popup-field-card .drag-handle { cursor: grab; color: #94a3b8; font-size: 18px; }
        .popup-field-meta { flex: 1; min-width: 0; }
        .popup-field-name { font-weight: 700; color: #0f172a; display: flex; gap: 6px; align-items: center; }
        .popup-field-type { font-size: 13px; color: #64748b; }
        .field-type { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 500; }
        .popup-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 999px; background: #f8fafc; border: 1px solid #e2e8f0; font-size: 12px; color: #475569; font-weight: 600; }
        .popup-badge.warn { background: #fef3c7; border-color: #fde68a; color: #b45309; }
        .popup-toggle { width: 46px; height: 26px; border-radius: 999px; background: #e5e7eb; position: relative; cursor: pointer; transition: all 0.2s ease; }
        .popup-toggle::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #fff; top: 3px; left: 3px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); transition: all 0.2s ease; }
        .popup-toggle.active { background: #1d4ed8; }
        .popup-toggle.active::after { transform: translateX(20px); }
        .popup-side { display: flex; flex-direction: column; gap: 16px; height: 100%; }
        .popup-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; }
        .popup-card h4 { margin: 0 0 8px 0; font-size: 14px; color: #0f172a; font-weight: 700; }
        .popup-stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .popup-stat { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; }
        .popup-stat .value { font-size: 24px; font-weight: 800; color: #0f172a; }
        .popup-stat .label { font-size: 12px; color: #6b7280; }
        .popup-preview { border: 1px solid #e2e8f0; border-radius: 8px; background: #fafafa; padding: 14px; }
        .popup-preview-header { font-weight: 700; margin-bottom: 10px; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        .popup-preview-fields { display: grid; gap: 10px; }
        .popup-preview-fields.cols-1 { grid-template-columns: 1fr; }
        .popup-preview-fields.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .popup-preview-fields.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .popup-preview-field { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
        .popup-preview-field .label { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
        .popup-preview-field .value { font-size: 13px; color: #0f172a; }
        .popup-layout-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .popup-layout-option { border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; cursor: pointer; text-align: center; transition: all 0.15s ease; background: #fff; }
        .popup-layout-option.active { border-color: #1d4ed8; background: #eef2ff; color: #1d4ed8; }
        .popup-event-stream { display: flex; flex-direction: column; gap: 10px; }
        .popup-event { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #fff; }
        .popup-event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; color: #0f172a; font-weight: 700; font-size: 14px; }
        .popup-event-time { color: #94a3b8; font-size: 12px; font-weight: 600; }
        .popup-conditions { display: grid; gap: 10px; }
        .popup-condition-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #fff; }
        .popup-condition-title { font-weight: 700; color: #0f172a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .popup-condition-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 10px; }
        .popup-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #f3f4f6; color: #475569; font-weight: 600; font-size: 12px; }
        .popup-template-buttons { display: flex; flex-direction: column; gap: 8px; }
        @media (max-width: 1100px) { .popup-config-body { grid-template-columns: 1fr; } .popup-side { order: -1; flex-direction: row; overflow-x: auto; } .popup-side .popup-card { min-width: 240px; } }
        
        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            border: 1px solid var(--border);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: none;
        }
        .btn-primary:hover { background: transparent; color: var(--text); border-color: var(--text); box-shadow: none; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); box-shadow: none; }
        .btn-secondary:hover { background: var(--muted-surface); border-color: var(--text); color: var(--text); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-green { background-color: #d1fae5; color: #065f46; }
        .badge-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-purple { background-color: #e9d5ff; color: #6b21a8; }
        .badge-gray { background-color: #f3f4f6; color: #374151; }
        .badge-cyan { background-color: #cffafe; color: #155e75; }
        .badge-pink { background-color: #fce7f3; color: #9f1239; }
        
        /* FIELD TYPE GRID */
        .field-type-grid {
            display: grid;
            grid-template-columns: 1fr;
            grid-auto-rows: 1fr;
            gap: 10px;
            max-height: 360px;
            overflow-y: auto;
            align-items: stretch;
        }
        .field-type-option {
            padding: 12px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            min-height: 64px;
            height: 100%;
        }
        .field-type-option:hover { border-color: #d1d5db; box-shadow: 0 6px 16px rgba(0,0,0,0.05); }
        .field-type-option.selected { border-color: var(--border-strong); background: #f8fafc; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
        .field-type-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
            flex-shrink: 0;
            font-size: 18px;
        }
        .field-type-option.selected .field-type-icon { background: #3b82f6; color: white; }
        .field-type-content { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .field-type-name { font-weight: 600; font-size: 14px; color: #111827; }
        .field-type-id { font-size: 12px; text-transform: uppercase; letter-spacing: 0.03em; color: #6b7280; }
        
        /* FILTER BUILDER */
        .filter-group { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .filter-group-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .filter-operator-toggle { display: flex; background: white; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; }
        .filter-operator-toggle button {
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-operator-toggle button.active { background: #3b82f6; color: white; }
        .filter-rule { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px; }
        
        /* UTILITIES */
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="url"], select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.15s ease;
            background: white;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            animation: slideInToast 0.3s ease;
        }
        @keyframes slideInToast { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 420px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .side-panel.open { transform: translateX(0); }
        
        .option-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .option-row input { flex: 1; }
        .color-picker { display: flex; gap: 4px; flex-wrap: wrap; }
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #1e293b; }
        
        .field-editor { border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; transition: all 0.15s; }
        .field-editor:hover { border-color: #d1d5db; background: #fafafa; }
        .field-editor:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .field-editor input, .field-editor textarea, .field-editor select { width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 14px; }
        
        .record-tabs { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 24px; background: #fafafa; }
        .record-tab {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }
        .record-tab:hover { color: #374151; }
        .record-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        
        .json-tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            background: transparent;
            border: none;
            transition: all 0.15s ease;
        }
        .json-tab:hover { color: #374151; background: #f9fafb; }
        .json-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        
        .json-key { color: #b45309; font-weight: 600; }
        .json-string { color: #15803d; }
        .json-number { color: #1e40af; }
        .json-boolean { color: #7c2d12; }
        .json-null { color: #991b1b; font-style: italic; }
        
        #jsonContent {
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .profile-selector { display: flex; gap: 8px; padding: 12px 0; overflow-x: auto; }
        .profile-tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid #e5e7eb;
            background: white;
            white-space: nowrap;
        }
        .profile-tab:hover { background: #f3f4f6; }
        .profile-tab.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        
        .history-entry {
            border-left: 3px solid #e5e7eb;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.15s ease;
            cursor: pointer;
            border-radius: 4px;
        }
        .history-entry:hover { border-left-color: #3b82f6; background-color: #f9fafb; }

        .mobile-sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 30;
        }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 240px; }
            .app-container { grid-template-areas: "header" "main"; grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .app-sidebar {
                position: fixed;
                inset: 0 auto 0 0;
                width: var(--sidebar-width);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 40;
            }
            .mobile-sidebar-overlay { display: none; }
            .mobile-layout.sidebar-open-mobile .app-sidebar { transform: translateX(0); box-shadow: 8px 0 24px rgba(0,0,0,0.18); }
            .mobile-layout.sidebar-open-mobile .mobile-sidebar-overlay { display: block; }
            .app-header { position: sticky; top: 0; z-index: 20; }
            .toolbar { flex-direction: column; align-items: flex-start; gap: 12px; }
            .toolbar .view-type-switcher { width: 100%; overflow-x: auto; padding-bottom: 4px; }
            .toolbar-actions { width: 100%; flex-wrap: wrap; }
            .toolbar-actions button { flex: 1 1 calc(50% - 8px); min-width: 140px; }
            .cards-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
            .kanban-board { min-height: auto; }
        }

        @media (max-width: 640px) {
            .toolbar-actions button { flex: 1 1 100%; }
            .cards-grid { grid-template-columns: 1fr; }
            .kanban-column { min-width: 260px; }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">Workbase</div>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="ph ph-list text-lg"></i>
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Sets</div>
                <div id="setsList"></div>
                <button onclick="openAddSetModal()" class="new-set-btn">
                    <span class="set-icon"><i class="ph ph-plus"></i></span>
                    <span class="set-name">New Set</span>
                </button>
            </div>
        </div>

        <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay" onclick="closeMobileSidebar()"></div>

        <!-- Header -->
        <div class="app-header">
            <div class="toolbar">
                <div class="flex items-center gap-3">
                    <div class="view-type-switcher">
                        <button class="view-type-btn active" data-type="grid" onclick="switchViewType('grid')">
                            <i class="ph ph-table"></i>
                            <span>Grid</span>
                        </button>
                        <button class="view-type-btn" data-type="card" onclick="switchViewType('card')">
                            <i class="ph ph-cards-three"></i>
                            <span>Card</span>
                        </button>
                        <button class="view-type-btn" data-type="kanban" onclick="switchViewType('kanban')">
                            <i class="ph ph-kanban"></i>
                            <span>Kanban</span>
                        </button>
                    </div>
                    <button id="filterBtn" class="btn btn-secondary btn-sm">
                        <i class="ph ph-funnel-simple"></i>
                        Filter
                    </button>
                    <button id="sortBtn" class="btn btn-secondary btn-sm">
                        <i class="ph ph-arrows-down-up"></i>
                        Sort
                    </button>
                    <button id="popupSettingsBtn" class="btn btn-secondary btn-sm">
                        <i class="ph ph-popcorn"></i>
                        Popup Fields
                    </button>
                    <button id="historyBtn" class="btn btn-secondary btn-sm">
                        <i class="ph ph-clock-counter-clockwise"></i>
                        History
                    </button>
                </div>
                <div class="flex items-center gap-2 toolbar-actions">
                    <button id="addRecordBtn" class="btn btn-primary btn-sm">+ Add Record</button>
                    <button id="addFieldBtn" class="btn btn-secondary btn-sm">+ Add Field</button>
                    <button id="viewJsonBtn" class="btn btn-secondary btn-sm">View JSON</button>
                    <button id="exportBtn" class="btn btn-secondary btn-sm">Export</button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="app-main">
            <div id="viewContainer"></div>
        </div>
    </div>

    <!-- All Modals from previous version -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Confirm Action</h2>
            </div>
            <div class="modal-body">
                <p class="text-gray-700" id="confirmMessage"></p>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmOkBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="expandedRecordModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-4 flex-1">
                    <h2 class="text-2xl font-bold text-gray-900" id="expandedRecordTitle">Record Details</h2>
                    <div class="profile-selector" id="recordProfileSelector"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="toggleHistorySidebarBtn" class="btn btn-secondary btn-sm">Hide History</button>
                    <button id="closeExpandedRecordBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    <div id="expandedRecordMainWrapper" class="md:col-span-2 p-6 overflow-y-auto border-r border-gray-200">
                        <div id="expandedRecordMain"></div>
                    </div>
                    <div id="expandedRecordHistoryColumn" class="overflow-hidden bg-gray-50 flex flex-col">
                        <div class="record-tabs">
                            <div class="record-tab active" data-tab="history" onclick="switchRecordTab('history')">History</div>
                            <div class="record-tab" data-tab="connections" onclick="switchRecordTab('connections')">Connections</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6" id="expandedRecordSidebar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Filter View</h2>
                    <p class="text-sm text-gray-500 mt-1">Create advanced filter conditions</p>
                </div>
                <button id="closeFilterBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body">
                <div id="filterGroupsContainer"></div>
                <button id="addFilterGroupBtn" class="btn btn-secondary btn-sm mt-4">+ Add Filter Group</button>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="clearFiltersBtn" class="btn btn-secondary">Clear All</button>
                <button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button>
            </div>
        </div>
    </div>

    <div id="sortModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Sort View</h2>
                    <p class="text-sm text-gray-500 mt-1">Create a sorting sequence for this view</p>
                </div>
                <button id="closeSortBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body space-y-3">
                <div id="sortRulesContainer" class="space-y-3"></div>
                <button id="addSortRuleBtn" class="btn btn-secondary btn-sm">+ Add Sort</button>
            </div>
            <div class="modal-footer flex justify-between gap-2">
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <span class="sort-sequence-badge"><i class="ph ph-arrow-line-up"></i>Earlier sorts run first</span>
                </div>
                <div class="flex gap-2">
                    <button id="clearSortsBtn" class="btn btn-secondary">Clear All</button>
                    <button id="applySortsBtn" class="btn btn-primary">Apply Sorts</button>
                </div>
            </div>
        </div>
    </div>

    <div id="popupSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white popup-config-shell">
            <div class="popup-config-header">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Popup Configuration</h2>
                    <p class="text-sm text-gray-600 mt-1">Curate which fields show in record popups, define conditional visibility, and preview layouts.</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="resetPopupLayout()">Reset</button>
                    <button id="closePopupSettingsBtn" class="btn btn-secondary btn-sm">Close</button>
                </div>
            </div>

            <div class="popup-config-tabs">
                <button class="popup-config-tab active" data-tab="popupFields" onclick="setPopupTab('popupFields')">üéØ Fields <span class="popup-badge" id="popupFieldCountBadge">0</span></button>
                <button class="popup-config-tab" data-tab="popupLayout" onclick="setPopupTab('popupLayout')">üìê Layout</button>
                <button class="popup-config-tab" data-tab="popupConditions" onclick="setPopupTab('popupConditions')">‚ö° Conditions</button>
                <button class="popup-config-tab" data-tab="popupEvents" onclick="setPopupTab('popupEvents')">üìä Event Stream</button>
            </div>

            <div class="popup-config-body">
                <div class="popup-tab-panel active" id="popupFields">
                    <div class="popup-panel-scroll">
                        <div class="popup-quick-filters" id="popupFilters"></div>
                        <div class="popup-info"><span>üí°</span><span><strong>Drag to reorder</strong> and toggle visibility. Click the gear to set conditional rules per field.</span></div>
                        <div id="popupFieldList"></div>
                    </div>
                </div>

                <div class="popup-tab-panel" id="popupLayout">
                    <div class="popup-panel-scroll space-y-4">
                        <div class="popup-card">
                            <h4>Popup Size</h4>
                            <div class="popup-layout-options" id="popupSizeOptions"></div>
                        </div>
                        <div class="popup-card">
                            <h4>Column Layout</h4>
                            <div class="popup-layout-options" id="popupColumnOptions"></div>
                        </div>
                        <div class="popup-card">
                            <h4>Preview</h4>
                            <div id="popupPreview" class="popup-preview"></div>
                        </div>
                    </div>
                </div>

                <div class="popup-tab-panel" id="popupConditions">
                    <div class="popup-panel-scroll">
                        <div class="popup-info"><span>‚ö°</span><span><strong>Conditional visibility</strong> lets you keep popups focused and contextual.</span></div>
                        <div id="popupConditionsList" class="popup-conditions"></div>
                    </div>
                </div>

                <div class="popup-tab-panel" id="popupEvents">
                    <div class="popup-panel-scroll">
                        <div class="popup-event-stream" id="popupEventStream"></div>
                    </div>
                </div>

                <div class="popup-side">
                    <div class="popup-card">
                        <h4>Quick Stats</h4>
                        <div class="popup-stat-grid">
                            <div class="popup-stat">
                                <div class="value" id="popupVisibleCount">0</div>
                                <div class="label">Visible Fields</div>
                            </div>
                            <div class="popup-stat">
                                <div class="value" id="popupConditionalCount">0</div>
                                <div class="label">Conditional Rules</div>
                            </div>
                        </div>
                    </div>
                    <div class="popup-card">
                        <h4>Templates</h4>
                        <div class="popup-template-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="applyPopupTemplate('minimal')">üìã Minimal View</button>
                            <button class="btn btn-secondary btn-sm" onclick="applyPopupTemplate('detailed')">üìù Detailed View</button>
                            <button class="btn btn-secondary btn-sm" onclick="applyPopupTemplate('compact')">‚ö° Compact View</button>
                        </div>
                    </div>
                    <div class="popup-card">
                        <h4>Recent Changes</h4>
                        <div id="popupRecentChanges" class="text-sm text-gray-600 space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addFieldModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Add Field</h2>
                    <p class="text-sm text-gray-500 mt-1">Create a new field for your set</p>
                </div>
                <button id="closeAddFieldBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body space-y-5">
                <div>
                    <label class="form-label">Field Name</label>
                    <input type="text" id="newFieldName" placeholder="e.g., Status, Amount, Contact Person" autofocus>
                    <p class="form-hint">A descriptive name for your field</p>
                </div>
                <div>
                    <label class="form-label">Field Type</label>
                    <div id="fieldTypeGrid" class="field-type-grid"></div>
                    <input type="hidden" id="newFieldType" value="TEXT">
                </div>
                <div id="singleSelectConfig" class="config-section">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <label class="form-label">Options</label>
                        <div id="selectOptionsList" class="space-y-2 mb-3"></div>
                        <button onclick="addSelectOption()" class="btn btn-secondary btn-sm">+ Add Option</button>
                    </div>
                </div>
                <div id="linkToRecordConfig" class="config-section">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <label class="form-label">Link to Set</label>
                        <select id="linkToSet"></select>
                        <p class="form-hint">Select which set to link to</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddFieldBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddFieldBtn" class="btn btn-primary">Add Field</button>
            </div>
        </div>
    </div>

    <div id="addSetModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 id="addSetModalTitle" class="text-xl font-bold text-gray-900">Create Set</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">Set Name</label>
                    <input type="text" id="newSetName" placeholder="e.g., Projects, Contacts">
                </div>
                <div>
                    <label class="form-label">Icon (Phosphor token or emoji)</label>
                    <div class="flex gap-2">
                        <input type="text" id="newSetIcon" placeholder="ph-squares-four" class="flex-1">
                        <button id="openSetIconPickerBtn" class="btn btn-secondary btn-sm" type="button">Choose Icon</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddSetBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddSetBtn" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <div id="addViewModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 id="addViewModalTitle" class="text-xl font-bold text-gray-900">Create View</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">View Name</label>
                    <input type="text" id="newViewName" placeholder="e.g., Active Items">
                </div>
                <div>
                    <label class="form-label">View Icon (Phosphor token or emoji)</label>
                    <div class="flex gap-2">
                        <input type="text" id="newViewIcon" placeholder="ph-table" class="flex-1">
                        <button id="openViewIconPickerBtn" class="btn btn-secondary btn-sm" type="button">Choose Icon</button>
                    </div>
                </div>
                <div>
                    <label class="form-label">Nest Under</label>
                    <select id="newViewParent"></select>
                    <p class="form-hint">Optionally place this view under another view</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddViewBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddViewBtn" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <div id="iconPickerModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-2xl">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Select an Icon</h2>
                    <p class="form-hint mt-1">Choose from common Phosphor icons or enter a custom emoji/token.</p>
                </div>
                <button id="closeIconPickerBtn" class="btn btn-secondary btn-sm">Close</button>
            </div>
            <div class="modal-body space-y-4">
                <input type="text" id="iconPickerSearch" placeholder="Search icons (e.g., table, folder)" class="w-full">
                <div id="iconPickerOptions" class="icon-picker-grid"></div>
            </div>
        </div>
    </div>

    <div id="kanbanConfigModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Configure Kanban</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">Group By Field</label>
                    <select id="kanbanGroupField"></select>
                    <p class="form-hint">Select a single-select field to group records by</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelKanbanConfigBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveKanbanConfigBtn" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <div id="historyPanel" class="side-panel">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold">Edit History</h3>
                    <p class="text-sm opacity-90 mt-1">Full audit trail</p>
                </div>
                <button id="closeHistoryBtn" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <input type="text" id="historySearch" class="w-full text-gray-900 rounded-lg" placeholder="Search history...">
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="historyContent"></div>
    </div>

    <!-- Cell History Modal -->
    <div id="cellHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900" id="cellHistoryTitle">Cell History</h2>
                    <p class="text-sm text-gray-500 mt-1" id="cellHistorySubtitle"></p>
                </div>
                <button class="text-gray-400 hover:text-gray-600 transition p-2" onclick="closeModal('cellHistoryModal')">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-auto" id="cellHistoryContent"></div>
        </div>
    </div>

    <!-- JSON Viewer Modal -->
    <div id="jsonViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-6xl h-[90vh] max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">JSON Data</h2>
                    <p class="text-sm text-gray-500 mt-1">View the complete data structure</p>
                </div>
                <button id="closeJsonViewerBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex border-b border-gray-200">
                <button class="json-tab active" data-tab="all" onclick="switchJsonTab('all')">All Data</button>
                <button class="json-tab" data-tab="sets" onclick="switchJsonTab('sets')">Sets</button>
                <button class="json-tab" data-tab="current" onclick="switchJsonTab('current')">Current Set</button>
                <button class="json-tab" data-tab="events" onclick="switchJsonTab('events')">Event Stream</button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <pre id="jsonContent" class="p-6 overflow-auto h-full text-sm bg-gray-50 font-mono"></pre>
                <button id="copyJsonBtn" class="absolute top-4 right-4 btn btn-secondary btn-sm">
                    <i class="ph ph-clipboard-text"></i>
                    Copy
                </button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        const state = {
            sets: new Map(),
            currentSetId: null,
            currentViewId: null,
            currentProfileId: 'default',
            eventStream: [],
            eventIdCounter: 1,
            currentUser: { type: 'Person', id: 'user_1', name: 'User' },
            operatorSet: {},
            interpretationRules: [],
            connections: new Map(),
            connectionBuilder: { targetSetId: null, targetRecordId: '', metadataJson: '' },
            sidebarCollapsed: false,
            sidebarOpenMobile: false,
            modalStack: [],
            currentRecordTab: 'history',
            recordHistoryVisible: true,
            confirmCallback: null,
            selectOptions: [{ value: 'Option 1', color: 'blue' }],
            expandedSets: new Set(),
            draggedRecord: null,
            cellHistoryContext: null,
            setEditorContext: null,
            viewEditorContext: null,
            iconPickerTarget: null,
            iconPickerQuery: '',
            popupUi: { filter: 'all', activeTab: 'popupFields' },
            popupEventStream: [],
            popupDraggedField: null
        };

        const columnDragState = {
            timer: null,
            draggedFieldId: null,
            dropFieldId: null,
            dropPosition: null,
            ghost: null,
            offsetX: 0,
            offsetY: 0,
            sourceElement: null
        };

        const COLUMN_WIDTH_MIN = 60;
        const COLUMN_WIDTH_MAX = 600;

        function clampColumnWidth(width) {
            if (isNaN(width)) return 150;
            return Math.min(COLUMN_WIDTH_MAX, Math.max(COLUMN_WIDTH_MIN, width));
        }

        function getFieldWidth(field) {
            const numericWidth = parseInt(field?.width || '150', 10);
            return clampColumnWidth(numericWidth);
        }

        const FIELD_TYPES = {
            TEXT: { id: 'TEXT', name: 'Single Line Text', defaultValue: '', icon: 'ph-text-t' },
            LONG_TEXT: { id: 'LONG_TEXT', name: 'Long Text', defaultValue: '', icon: 'ph-article' },
            NUMBER: { id: 'NUMBER', name: 'Number', defaultValue: 0, icon: 'ph-hash' },
            CURRENCY: { id: 'CURRENCY', name: 'Currency', defaultValue: 0, icon: 'ph-currency-dollar' },
            DATE: { id: 'DATE', name: 'Date', defaultValue: '', icon: 'ph-calendar-blank' },
            EMAIL: { id: 'EMAIL', name: 'Email', defaultValue: '', icon: 'ph-envelope-simple' },
            URL: { id: 'URL', name: 'URL', defaultValue: '', icon: 'ph-link-simple' },
            PHONE: { id: 'PHONE', name: 'Phone', defaultValue: '', icon: 'ph-phone' },
            LINK_RECORD: { id: 'LINK_RECORD', name: 'Link to Record', defaultValue: '', icon: 'ph-link-simple-horizontal', needsConfig: true },
            SINGLE_SELECT: { id: 'SINGLE_SELECT', name: 'Single Select', defaultValue: '', icon: 'ph-list-bullets', needsConfig: true },
            CHECKBOX: { id: 'CHECKBOX', name: 'Checkbox', defaultValue: false, icon: 'ph-check-square' }
        };

        const VIEW_TYPE_ICONS = { grid: 'ph-table', card: 'ph-cards-three', kanban: 'ph-kanban' };

        const ICON_OPTIONS = [
            { token: 'ph-squares-four', label: 'Grid' },
            { token: 'ph-table', label: 'Table' },
            { token: 'ph-cards-three', label: 'Cards' },
            { token: 'ph-kanban', label: 'Kanban' },
            { token: 'ph-list-bullets', label: 'List' },
            { token: 'ph-folders', label: 'Folders' },
            { token: 'ph-notebook', label: 'Notebook' },
            { token: 'ph-clipboard-text', label: 'Notes' },
            { token: 'ph-calendar-blank', label: 'Calendar' },
            { token: 'ph-users-three', label: 'Team' },
            { token: 'ph-tag', label: 'Tags' },
            { token: 'ph-chart-line', label: 'Analytics' },
            { token: 'ph-lightbulb', label: 'Ideas' },
            { token: 'ph-rocket', label: 'Launch' },
            { token: 'ph-briefcase', label: 'Work' },
            { token: 'ph-shopping-cart', label: 'Commerce' },
            { token: 'ph-house-line', label: 'Home' },
            { token: 'ph-map-trifold', label: 'Map' },
            { token: 'ph-phone', label: 'Phone' },
            { token: 'ph-link-simple', label: 'Link' }
        ];

        function renderIcon(icon) {
            if (!icon) return '';
            const trimmed = icon.toString().trim();
            if (trimmed.startsWith('<')) return trimmed;
            if (trimmed.startsWith('ph ')) return `<i class="${trimmed}"></i>`;
            if (trimmed.startsWith('ph-')) return `<i class="ph ${trimmed}"></i>`;
            return trimmed;
        }

        function extractIconToken(icon) {
            if (!icon) return '';
            const trimmed = icon.toString().trim();
            const match = trimmed.match(/ph-[\w-]+/);
            if (match) return match[0];
            return trimmed;
        }

        function openIconPicker(targetInputId) {
            state.iconPickerTarget = targetInputId;
            state.iconPickerQuery = '';
            const searchInput = document.getElementById('iconPickerSearch');
            if (searchInput) searchInput.value = '';
            renderIconPickerOptions();
            openModal('iconPickerModal');
        }

        function renderIconPickerOptions() {
            const container = document.getElementById('iconPickerOptions');
            if (!container) return;
            const search = (state.iconPickerQuery || '').toLowerCase();
            const currentValue = state.iconPickerTarget ? extractIconToken(document.getElementById(state.iconPickerTarget)?.value || '') : '';

            container.innerHTML = '';

            const filtered = ICON_OPTIONS.filter(opt =>
                opt.token.toLowerCase().includes(search) ||
                opt.label.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No icons match your search.</p>';
                return;
            }

            filtered.forEach(opt => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `icon-option${opt.token === currentValue ? ' active' : ''}`;
                btn.innerHTML = `
                    <span class="text-2xl">${renderIcon(opt.token)}</span>
                    <span class="text-sm font-medium">${opt.label}</span>
                    <span class="text-xs text-gray-500">${opt.token}</span>
                `;
                btn.onclick = () => selectIconFromPicker(opt.token);
                container.appendChild(btn);
            });
        }

        function selectIconFromPicker(token) {
            if (state.iconPickerTarget) {
                const input = document.getElementById(state.iconPickerTarget);
                if (input) input.value = token;
            }
            closeModal('iconPickerModal');
        }

        const EO_OPERATOR_SET = {
            INS: { id: 'INS', name: 'Instantiate', description: 'Create a new object that did not exist before.' },
            DES: { id: 'DES', name: 'Designate', description: 'Assign a name, ID, label, alias, or classification.' },
            SEG: { id: 'SEG', name: 'Segment', description: 'Change boundaries, structure, or partition membership.' },
            CON: { id: 'CON', name: 'Connect', description: 'Create or remove a connection between objects.' },
            ALT: { id: 'ALT', name: 'Alternate', description: 'Toggle or switch between mutually exclusive states.' },
            SYN: { id: 'SYN', name: 'Synthesize', description: 'Combine two or more objects into a new unified whole.' },
            SUP: { id: 'SUP', name: 'Superposition', description: 'Hold contradictory states as simultaneously true without resolving them.' },
            REC: { id: 'REC', name: 'Recurse', description: 'Introduce a new layer of logic, rules, or self-reference.' },
            NUL: { id: 'NUL', name: 'Nullify', description: 'Declare absence, deletion, or erasure.' }
        };

        // INITIALIZATION
        function initializeApp() {
            state.operatorSet = EO_OPERATOR_SET;
            initializeOperatorRules();
            createSampleData();
            renderSidebar();
            if (state.currentSetId) switchSet(state.currentSetId, state.currentViewId);
            setupEventListeners();
            setupKeyboardShortcuts();
            applyResponsiveLayout();
            window.addEventListener('resize', applyResponsiveLayout);
        }

        function applyResponsiveLayout() {
            const appContainer = document.getElementById('appContainer');
            const isMobile = window.matchMedia('(max-width: 1024px)').matches;

            if (isMobile) {
                appContainer.classList.add('mobile-layout');
                appContainer.classList.toggle('sidebar-open-mobile', state.sidebarOpenMobile);
                appContainer.classList.remove('sidebar-collapsed');
            } else {
                appContainer.classList.remove('mobile-layout');
                appContainer.classList.remove('sidebar-open-mobile');
                appContainer.classList.toggle('sidebar-collapsed', state.sidebarCollapsed);
            }
        }

        function initializeOperatorRules() {
            const defaultRules = [
                {
                    rule_id: 'rule_ins_requires_object',
                    applies_to_op: 'INS',
                    description: 'Instantiation must target an identifiable object.',
                    effect: 'require_object_id'
                },
                {
                    rule_id: 'rule_events_require_actor',
                    description: 'All events must be attributable to an actor.',
                    effect: 'require_actor'
                },
                {
                    rule_id: 'rule_con_requires_object',
                    applies_to_op: 'CON',
                    description: 'Connections must reference a concrete edge object.',
                    effect: 'require_object_id'
                },
                {
                    rule_id: 'rule_con_requires_endpoints',
                    applies_to_op: 'CON',
                    description: 'Connections must include both source and target references.',
                    effect: 'require_connection_endpoints'
                },
                {
                    rule_id: 'rule_nullify_marks_deleted',
                    applies_to_op: 'NUL',
                    description: 'Nullify operations explicitly mark the object as deleted in the payload.',
                    effect: 'mark_deleted'
                }
            ];

            defaultRules.forEach(rule => registerInterpretationRule(rule, { skipEvent: true }));
        }

        function createSampleData() {
            const projectsId = createSet('Projects', 'ph-kanban');
            const projectsSet = state.sets.get(projectsId);

            const contactsId = createSet('Clients', 'ph-users-three');
            const contactsSet = state.sets.get(contactsId);

            contactsSet.schema = [
                { id: 'name', name: 'Client Name', type: 'TEXT', width: '200px' },
                { id: 'industry', name: 'Industry', type: 'SINGLE_SELECT', width: '140px', config: {
                    options: ['Technology', 'Retail', 'Finance', 'Healthcare'],
                    colors: { 'Technology': 'blue', 'Retail': 'purple', 'Finance': 'green', 'Healthcare': 'yellow' }
                }},
                { id: 'website', name: 'Website', type: 'URL', width: '200px' }
            ];

            contactsSet.profiles = new Map([
                ['default', { id: 'default', name: 'All Fields', visibleFields: [] }]
            ]);

            const acmeId = addRecord(contactsId, { name: 'Acme Corp', industry: 'Technology', website: 'https://acme.example.com' });
            const harborId = addRecord(contactsId, { name: 'Harbor Retail', industry: 'Retail', website: 'https://harborretail.example.com' });
            const northbankId = addRecord(contactsId, { name: 'Northbank Finance', industry: 'Finance', website: 'https://northbank.example.com' });

            createView(contactsId, 'All Clients', { type: 'grid' });

            projectsSet.schema = [
                { id: 'name', name: 'Project Name', type: 'TEXT', width: '200px' },
                { id: 'client', name: 'Client', type: 'LINK_RECORD', width: '180px', config: { linkedSetId: contactsId } },
                { id: 'status', name: 'Status', type: 'SINGLE_SELECT', width: '130px', config: {
                    options: ['Planning', 'In Progress', 'On Hold', 'Completed'],
                    colors: { 'Planning': 'gray', 'In Progress': 'blue', 'On Hold': 'yellow', 'Completed': 'green' }
                }},
                { id: 'budget', name: 'Budget', type: 'CURRENCY', width: '120px' },
                { id: 'start_date', name: 'Start Date', type: 'DATE', width: '120px' },
                { id: 'priority', name: 'Priority', type: 'SINGLE_SELECT', width: '100px', config: {
                    options: ['Low', 'Medium', 'High', 'Critical'],
                    colors: { 'Low': 'gray', 'Medium': 'blue', 'High': 'yellow', 'Critical': 'red' }
                }},
                { id: 'notes', name: 'Notes', type: 'LONG_TEXT', width: '300px' }
            ];

            projectsSet.profiles = new Map([
                ['default', { id: 'default', name: 'All Fields', visibleFields: [] }]
            ]);

            addRecord(projectsId, {
                name: 'Website Redesign',
                client: acmeId,
                status: 'In Progress',
                budget: 50000,
                start_date: '2024-01-15',
                priority: 'High',
                notes: 'Complete overhaul of company website'
            });

            addRecord(projectsId, {
                name: 'Mobile App',
                client: harborId,
                status: 'Planning',
                budget: 120000,
                start_date: '2024-06-01',
                priority: 'Critical',
                notes: 'iOS and Android native apps'
            });

            addRecord(projectsId, {
                name: 'Database Migration',
                client: northbankId,
                status: 'Completed',
                budget: 30000,
                start_date: '2023-11-01',
                priority: 'High',
                notes: 'Migrate to new cloud infrastructure'
            });

            createView(projectsId, 'All Projects', { type: 'grid' });
            createView(projectsId, 'By Status', { type: 'kanban' });
            createView(projectsId, 'Card View', { type: 'card' });

            state.currentSetId = projectsId;
            state.currentViewId = Array.from(projectsSet.views.keys())[0];
            state.expandedSets.add(projectsId);
        }

        // SET MANAGEMENT
        function createSet(name, icon = 'ph-squares-four') {
            const setId = 'set_' + Date.now();
            state.sets.set(setId, {
                id: setId,
                name: name,
                icon: icon,
                schema: [],
                records: new Map(),
                views: new Map(),
                profiles: new Map([['default', { id: 'default', name: 'All Fields', visibleFields: [] }]])
            });
            createEvent(
                'Create Set',
                'INS',
                { type: 'Set', id: setId },
                { name },
                { summary: `Created set "${name}"`, scale: 'collection' }
            );
            return setId;
        }

        function createView(setId, name, config = {}) {
            const viewId = 'view_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const set = state.sets.get(setId);
            set.views.set(viewId, {
                id: viewId,
                name: name,
                type: config.type || 'grid',
                icon: config.icon || VIEW_TYPE_ICONS[config.type || 'grid'] || 'üìã',
                filters: config.filters || [],
                sorts: config.sorts || [],
                hiddenFields: config.hiddenFields || [],
                popupVisibilityRules: config.popupVisibilityRules || [],
                kanbanGroupField: config.kanbanGroupField || null,
                cardFields: config.cardFields || [],
                parentId: config.parentId || null
            });
            return viewId;
        }

        function addRecord(setId, data) {
            const set = state.sets.get(setId);
            const recordId = 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const record = { id: recordId, ...data };
            set.records.set(recordId, record);
            createEvent(
                'Create Record',
                'INS',
                { type: 'Record', id: recordId, setId },
                { setId, recordId, data, summary: 'Created record' }
            );
            return recordId;
        }

        function getRecordById(recordId) {
            for (const [setId, set] of state.sets.entries()) {
                if (set.records.has(recordId)) {
                    return { setId, set, record: set.records.get(recordId) };
                }
            }
            return null;
        }

        function getLinkedSet(field) {
            const linkedSetId = field?.config?.linkedSetId;
            if (!linkedSetId) return null;
            return state.sets.get(linkedSetId) || null;
        }

        function getLinkedRecordOptions(field) {
            const linkedSet = getLinkedSet(field);
            return linkedSet ? Array.from(linkedSet.records.values()) : [];
        }

        function createLinkedRecordOptionList(field) {
            const options = getLinkedRecordOptions(field);
            return options.map(opt => ({
                id: opt.id,
                label: opt.name || getRecordDisplayName(opt.id) || opt.id
            }));
        }

        function validateConnectionPayload(sourceId, targetId, metadata = {}) {
            if (!sourceId || !targetId) {
                throw new Error('Connections require both sourceId and targetId');
            }

            const sourceRef = getRecordById(sourceId);
            const targetRef = getRecordById(targetId);

            if (!sourceRef) throw new Error(`Source record ${sourceId} not found`);
            if (!targetRef) throw new Error(`Target record ${targetId} not found`);
            if (metadata === null || typeof metadata !== 'object' || Array.isArray(metadata)) {
                throw new Error('Connection metadata must be an object');
            }

            return { sourceRef, targetRef, metadata };
        }

        function createConnection(sourceId, targetId, metadata = {}) {
            const { sourceRef, targetRef, metadata: normalizedMetadata } = validateConnectionPayload(sourceId, targetId, metadata);
            const connectionId = `edge_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const connection = {
                id: connectionId,
                sourceId,
                targetId,
                metadata: normalizedMetadata,
                createdAt: new Date().toISOString()
            };

            state.connections.set(connectionId, connection);

            const summary = `Connected ${sourceRef.record.name || sourceId} ‚Üí ${targetRef.record.name || targetId}`;
            createEvent(
                'Create Connection',
                'CON',
                { type: 'Connection', id: connectionId },
                {
                    edge: connection,
                    sourceId,
                    targetId,
                    summary
                },
                { frame: 'graph', scale: 'relationship' }
            );

            return connectionId;
        }

        function updateConnection(connectionId, updates = {}) {
            const existing = state.connections.get(connectionId);
            if (!existing) throw new Error(`Connection ${connectionId} not found`);

            const nextSourceId = updates.sourceId || existing.sourceId;
            const nextTargetId = updates.targetId || existing.targetId;
            const hasMetadataUpdate = Object.prototype.hasOwnProperty.call(updates, 'metadata');
            const nextMetadata = hasMetadataUpdate ? updates.metadata : existing.metadata;
            const { sourceRef, targetRef, metadata: normalizedMetadata } = validateConnectionPayload(nextSourceId, nextTargetId, nextMetadata);

            const updated = {
                ...existing,
                sourceId: nextSourceId,
                targetId: nextTargetId,
                metadata: normalizedMetadata,
                updatedAt: new Date().toISOString()
            };

            const changes = {};
            if (existing.sourceId !== nextSourceId) changes.sourceId = { from: existing.sourceId, to: nextSourceId };
            if (existing.targetId !== nextTargetId) changes.targetId = { from: existing.targetId, to: nextTargetId };
            if (JSON.stringify(existing.metadata) !== JSON.stringify(normalizedMetadata)) changes.metadata = { from: existing.metadata, to: normalizedMetadata };

            state.connections.set(connectionId, updated);

            const summary = `Updated connection ${connectionId} (${sourceRef.record.name || nextSourceId} ‚Üí ${targetRef.record.name || nextTargetId})`;
            createEvent(
                'Update Connection',
                'CON',
                { type: 'Connection', id: connectionId },
                {
                    edge: updated,
                    sourceId: nextSourceId,
                    targetId: nextTargetId,
                    changes: Object.keys(changes).length ? changes : undefined,
                    summary
                },
                { frame: 'graph', scale: 'relationship' }
            );

            return updated;
        }

        function deleteConnection(connectionId) {
            const existing = state.connections.get(connectionId);
            if (!existing) throw new Error(`Connection ${connectionId} not found`);

            const { sourceRef, targetRef } = validateConnectionPayload(existing.sourceId, existing.targetId, existing.metadata);
            state.connections.delete(connectionId);

            const summary = `Removed connection ${sourceRef.record.name || existing.sourceId} ‚Üí ${targetRef.record.name || existing.targetId}`;
            createEvent(
                'Delete Connection',
                'CON',
                { type: 'Connection', id: connectionId },
                {
                    edge: existing,
                    sourceId: existing.sourceId,
                    targetId: existing.targetId,
                    summary,
                    deleted: true
                },
                { frame: 'graph', scale: 'relationship' }
            );

            return existing;
        }

        // SIDEBAR
        function toggleSidebar() {
            const isMobile = window.matchMedia('(max-width: 1024px)').matches;
            if (isMobile) {
                state.sidebarOpenMobile = !state.sidebarOpenMobile;
            } else {
                state.sidebarCollapsed = !state.sidebarCollapsed;
            }
            applyResponsiveLayout();
        }

        function closeMobileSidebar() {
            if (!state.sidebarOpenMobile) return;
            state.sidebarOpenMobile = false;
            applyResponsiveLayout();
        }

        function toggleSetExpansion(setId) {
            if (state.expandedSets.has(setId)) {
                state.expandedSets.delete(setId);
            } else {
                state.expandedSets.add(setId);
            }
            renderSidebar();
        }

        function renderSidebar() {
            const container = document.getElementById('setsList');
            container.innerHTML = '';

            state.sets.forEach((set, setId) => {
                const isExpanded = state.expandedSets.has(setId);
                const isActive = setId === state.currentSetId;

                const setItem = document.createElement('div');
                setItem.className = `set-item ${isExpanded ? 'expanded' : ''}`;

                const setHeader = document.createElement('div');
                setHeader.className = `set-header ${isActive && !state.currentViewId ? 'active' : ''}`;
                setHeader.innerHTML = `
                    <span class="set-icon">${renderIcon(set.icon)}</span>
                    <span class="set-name">${set.name}</span>
                    <span class="set-expand-icon">‚ñ∂</span>
                `;
                setHeader.onclick = (e) => { if (e.detail === 1) toggleSetExpansion(setId); };
                setHeader.ondblclick = (e) => { e.stopPropagation(); openAddSetModal(setId); };
                setHeader.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); openAddSetModal(setId); };
                setItem.appendChild(setHeader);

                if (isExpanded) {
                    const viewsList = document.createElement('div');
                    viewsList.className = 'views-list';

                    const orderedViews = Array.from(set.views.entries());
                    renderViewTree(orderedViews, setId, viewsList);

                    const addViewBtn = document.createElement('div');
                    addViewBtn.className = 'add-view-btn';
                    addViewBtn.textContent = '+ Add View';
                    addViewBtn.onclick = (e) => {
                        e.stopPropagation();
                        state.currentSetId = setId;
                        openAddViewModal(setId);
                    };
                    viewsList.appendChild(addViewBtn);

                    setItem.appendChild(viewsList);
                }

                container.appendChild(setItem);
            });
        }

        function renderViewTree(orderedViews, setId, container, parentId = null, depth = 0) {
            const normalizedParent = parentId || null;
            const childViews = orderedViews.filter(([_, view]) => (view.parentId || null) === normalizedParent);

            childViews.forEach(([viewId, view]) => {
                const viewItem = document.createElement('div');
                viewItem.className = `view-item ${viewId === state.currentViewId ? 'active' : ''}`;
                viewItem.style.paddingLeft = `${12 + depth * 16}px`;
                viewItem.innerHTML = `
                    <span class="view-item-icon">${renderIcon(view.icon || VIEW_TYPE_ICONS[view.type])}</span>
                    <span>${view.name}</span>
                `;
                viewItem.onclick = (e) => {
                    e.stopPropagation();
                    switchSet(setId, viewId);
                };
                viewItem.ondblclick = (e) => { e.stopPropagation(); openAddViewModal(setId, viewId); };
                viewItem.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); openAddViewModal(setId, viewId); };

                container.appendChild(viewItem);
                renderViewTree(orderedViews, setId, container, viewId, depth + 1);
            });
        }

        function isViewDescendant(set, startId, potentialAncestorId) {
            let currentParent = set.views.get(startId)?.parentId || null;
            while (currentParent) {
                if (currentParent === potentialAncestorId) return true;
                currentParent = set.views.get(currentParent)?.parentId || null;
            }
            return false;
        }

        function populateViewParentOptions(setId, excludeViewId = null, selectedParentId = null) {
            const select = document.getElementById('newViewParent');
            if (!select) return;

            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'No parent';
            select.appendChild(defaultOption);

            const set = state.sets.get(setId);
            if (!set) return;

            const orderedViews = Array.from(set.views.entries());
            const renderOptions = (parentId = null, depth = 0) => {
                const children = orderedViews.filter(([id, view]) => (view.parentId || null) === (parentId || null));
                children.forEach(([id, view]) => {
                    if (excludeViewId && id === excludeViewId) return;
                    const option = document.createElement('option');
                    option.value = id;
                    option.innerHTML = `${'‚Ä¢ '.repeat(depth)}${renderIcon(view.icon || VIEW_TYPE_ICONS[view.type])} ${view.name}`;
                    select.appendChild(option);
                    renderOptions(id, depth + 1);
                });
            };

            renderOptions();
            select.value = selectedParentId || '';
        }

        function openAddViewModal(setId, viewId = null) {
            const set = state.sets.get(setId);
            if (!set) return;

            const titleEl = document.getElementById('addViewModalTitle');
            const saveBtn = document.getElementById('saveAddViewBtn');
            const nameInput = document.getElementById('newViewName');
            const iconInput = document.getElementById('newViewIcon');

            state.currentSetId = setId;
            if (viewId) {
                const view = set.views.get(viewId);
                state.viewEditorContext = { setId, viewId };
                if (titleEl) titleEl.textContent = 'Edit View';
                if (saveBtn) saveBtn.textContent = 'Save';
                if (nameInput) nameInput.value = view?.name || '';
                if (iconInput) iconInput.value = extractIconToken(view?.icon || VIEW_TYPE_ICONS[view?.type]);
                populateViewParentOptions(setId, viewId, view?.parentId || null);
            } else {
                state.viewEditorContext = { setId, viewId: null };
                if (titleEl) titleEl.textContent = 'Create View';
                if (saveBtn) saveBtn.textContent = 'Create';
                if (nameInput) nameInput.value = '';
                if (iconInput) iconInput.value = '';
                populateViewParentOptions(setId);
            }

            openModal('addViewModal');
        }

        function switchSet(setId, viewId) {
            state.currentSetId = setId;
            state.currentViewId = viewId;
            const set = state.sets.get(setId);
            if (!viewId && set.views.size > 0) {
                state.currentViewId = Array.from(set.views.keys())[0];
            }
            closeMobileSidebar();
            renderSidebar();
            renderCurrentView();
        }

        function getCurrentSet() { return state.sets.get(state.currentSetId); }
        function getCurrentView() { const set = getCurrentSet(); return set?.views.get(state.currentViewId); }
        function getCurrentProfile() { const set = getCurrentSet(); return set?.profiles.get(state.currentProfileId); }

        // VIEW SWITCHING
        function switchViewType(type) {
            const view = getCurrentView();
            if (!view) return;
            view.type = type;
            
            // Update button states
            document.querySelectorAll('.view-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) btn.classList.add('active');
            });
            
            renderCurrentView();
        }

        function renderCurrentView() {
            const view = getCurrentView();
            if (!view) return;

            ensureViewDefaults(view);

            // Update view type buttons
            document.querySelectorAll('.view-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === view.type) btn.classList.add('active');
            });

            switch(view.type) {
                case 'grid':
                    renderGridView();
                    break;
                case 'card':
                    renderCardView();
                    break;
                case 'kanban':
                    renderKanbanView();
                    break;
            }
        }

        function ensureViewDefaults(view) {
            if (!view.icon) view.icon = VIEW_TYPE_ICONS[view.type] || 'ph-note';
            if (!view.sorts) view.sorts = [];
        }

        function applyColumnWidth(fieldId, width) {
            const normalizedWidth = clampColumnWidth(width);
            const widthPx = `${normalizedWidth}px`;
            const set = getCurrentSet();
            const field = set?.schema.find(f => f.id === fieldId);
            if (field) field.width = widthPx;

            document.querySelectorAll(`[data-field-id="${fieldId}"]`).forEach(el => {
                el.style.width = widthPx;
            });

            const table = document.getElementById('dataTable');
            if (table && set) {
                const totalWidth = set.schema.reduce((sum, f) => sum + getFieldWidth(f), 0);
                table.style.minWidth = `${Math.max(totalWidth, 600)}px`;
            }
        }

        function addColumnResizer(element, field) {
            const existingResizer = element.querySelector('.column-resizer');
            if (existingResizer) return;

            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            element.appendChild(resizer);

            let startX = 0;
            let startWidth = getFieldWidth(field);

            const onMouseMove = (event) => {
                const delta = event.clientX - startX;
                applyColumnWidth(field.id, startWidth + delta);
            };

            const onMouseUp = () => {
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            resizer.addEventListener('mousedown', (event) => {
                event.stopPropagation();
                event.preventDefault();
                startX = event.clientX;
                startWidth = getFieldWidth(field);
                document.body.classList.add('resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function getPointerPosition(event) {
            if (!event) return { clientX: 0, clientY: 0 };
            if (event.touches && event.touches.length > 0) {
                return { clientX: event.touches[0].clientX, clientY: event.touches[0].clientY };
            }
            if (event.changedTouches && event.changedTouches.length > 0) {
                return { clientX: event.changedTouches[0].clientX, clientY: event.changedTouches[0].clientY };
            }
            return { clientX: event.clientX, clientY: event.clientY };
        }

        function createColumnGhost(element, position) {
            const ghost = document.createElement('div');
            ghost.className = 'column-drag-ghost';
            ghost.style.width = `${element.offsetWidth}px`;
            ghost.innerHTML = element.innerHTML;
            ghost.style.left = `${position.clientX - columnDragState.offsetX}px`;
            ghost.style.top = `${position.clientY - columnDragState.offsetY}px`;
            document.body.appendChild(ghost);
            return ghost;
        }

        function clearColumnDropIndicators() {
            document.querySelectorAll('#tableHeader .column-header').forEach(header => {
                header.classList.remove('column-drop-before', 'column-drop-after');
            });
        }

        function updateColumnDropTarget(clientX) {
            const headers = Array.from(document.querySelectorAll('#tableHeader .column-header'));
            clearColumnDropIndicators();

            const target = headers.find(h => {
                const rect = h.getBoundingClientRect();
                return clientX >= rect.left && clientX <= rect.right;
            });

            if (!target || target.dataset.fieldId === columnDragState.draggedFieldId) {
                columnDragState.dropFieldId = null;
                columnDragState.dropPosition = null;
                return;
            }

            const rect = target.getBoundingClientRect();
            const position = clientX < rect.left + rect.width / 2 ? 'before' : 'after';
            target.classList.add(position === 'before' ? 'column-drop-before' : 'column-drop-after');
            columnDragState.dropFieldId = target.dataset.fieldId;
            columnDragState.dropPosition = position;
        }

        function reorderSchemaField(draggedFieldId, targetFieldId, position) {
            const set = getCurrentSet();
            if (!set) return;

            const fromIndex = set.schema.findIndex(f => f.id === draggedFieldId);
            let targetIndex = set.schema.findIndex(f => f.id === targetFieldId);
            if (fromIndex === -1 || targetIndex === -1) return;

            const [field] = set.schema.splice(fromIndex, 1);
            if (fromIndex < targetIndex) targetIndex -= 1;
            const insertIndex = position === 'after' ? targetIndex + 1 : targetIndex;
            set.schema.splice(insertIndex, 0, field);
        }

        function endColumnDrag() {
            document.body.classList.remove('column-dragging');
            document.removeEventListener('mousemove', handleColumnDragMove);
            document.removeEventListener('touchmove', handleColumnDragMove);
            document.removeEventListener('mouseup', endColumnDrag);
            document.removeEventListener('touchend', endColumnDrag);
            document.removeEventListener('touchcancel', endColumnDrag);

            if (columnDragState.ghost) columnDragState.ghost.remove();
            if (columnDragState.sourceElement) columnDragState.sourceElement.classList.remove('column-being-dragged');
            clearColumnDropIndicators();

            if (columnDragState.draggedFieldId && columnDragState.dropFieldId) {
                reorderSchemaField(columnDragState.draggedFieldId, columnDragState.dropFieldId, columnDragState.dropPosition);
                renderCurrentView();
            }

            columnDragState.draggedFieldId = null;
            columnDragState.dropFieldId = null;
            columnDragState.dropPosition = null;
            columnDragState.ghost = null;
            columnDragState.sourceElement = null;
        }

        function handleColumnDragMove(event) {
            if (!columnDragState.draggedFieldId || !columnDragState.ghost) return;
            if (event.cancelable) event.preventDefault();
            const position = getPointerPosition(event);
            columnDragState.ghost.style.left = `${position.clientX - columnDragState.offsetX}px`;
            columnDragState.ghost.style.top = `${position.clientY - columnDragState.offsetY}px`;
            updateColumnDropTarget(position.clientX);
        }

        function startColumnDrag(startPosition, element, field) {
            columnDragState.timer = null;
            columnDragState.draggedFieldId = field.id;
            columnDragState.sourceElement = element;

            const rect = element.getBoundingClientRect();
            columnDragState.offsetX = startPosition.clientX - rect.left;
            columnDragState.offsetY = startPosition.clientY - rect.top;

            columnDragState.ghost = createColumnGhost(element, startPosition);
            element.classList.add('column-being-dragged');
            document.body.classList.add('column-dragging');

            document.addEventListener('mousemove', handleColumnDragMove);
            document.addEventListener('touchmove', handleColumnDragMove, { passive: false });
            document.addEventListener('mouseup', endColumnDrag);
            document.addEventListener('touchend', endColumnDrag);
            document.addEventListener('touchcancel', endColumnDrag);
        }

        function setupColumnDragInteractions(element, field) {
            const cancelTimer = () => {
                if (columnDragState.timer) {
                    clearTimeout(columnDragState.timer);
                    columnDragState.timer = null;
                }
            };

            const startTimer = (event) => {
                if (event.button !== undefined && event.button !== 0) return;
                if (event.target.closest('.column-resizer')) return;
                const startPosition = getPointerPosition(event);
                cancelTimer();
                columnDragState.timer = setTimeout(() => startColumnDrag(startPosition, element, field), 400);
            };

            element.addEventListener('mousedown', startTimer);
            element.addEventListener('touchstart', startTimer);
            element.addEventListener('mouseup', cancelTimer);
            element.addEventListener('mouseleave', cancelTimer);
            element.addEventListener('mousemove', cancelTimer);
            element.addEventListener('touchend', cancelTimer);
            element.addEventListener('touchcancel', cancelTimer);
        }

        // GRID VIEW
        function renderGridView() {
            const set = getCurrentSet();
            if (!set) return;
            
            const view = getCurrentView();
            const profile = getCurrentProfile();
            const schema = set.schema.filter(f =>
                !profile || profile.visibleFields.length === 0 || profile.visibleFields.includes(f.id)
            );

            let records = Array.from(set.records.values());
            if (view && view.filters.length > 0) records = applyFilterGroups(records, view.filters, schema);
            if (view?.sorts?.length) records = applySorts(records, view.sorts, schema);

            const recordCount = records.length;
            const recordLabel = recordCount === 1 ? 'record' : 'records';

            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="max-w-full px-6 py-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="table-scroll">
                            <table id="dataTable" class="border-collapse">
                                <thead><tr id="tableHeader"></tr></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <span class="record-counter" id="recordCounter">${recordCount} ${recordLabel}</span>
                        </div>
                    </div>
                </div>
            `;

            const headerRow = document.getElementById('tableHeader');
            schema.forEach(field => {
                const th = document.createElement('th');
                th.className = 'column-header';
                th.dataset.type = field.type;
                th.dataset.fieldId = field.id;
                const width = `${getFieldWidth(field)}px`;
                th.style.width = width;
                const sortIndex = view?.sorts?.findIndex(s => s.fieldId === field.id) ?? -1;
                const sortConfig = sortIndex >= 0 ? view.sorts[sortIndex] : null;
                const directionIcon = sortConfig ? (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤') : '‚áÖ';
                const indicatorClass = sortConfig ? 'sort-indicator' : 'sort-indicator muted';
                const orderBadge = sortConfig ? `<span class="order-badge">${sortIndex + 1}</span>` : '';
                th.innerHTML = `<span>${field.name}</span><span class="${indicatorClass}"><span class="direction-icon">${directionIcon}</span>${orderBadge}</span>`;
                th.onclick = () => toggleColumnSort(field.id);
                addColumnResizer(th, field);
                setupColumnDragInteractions(th, field);
                th.oncontextmenu = (e) => { e.preventDefault(); showColumnMenu(e, field); };
                headerRow.appendChild(th);
            });

            const table = document.getElementById('dataTable');
            const minimumTableWidth = schema.reduce((sum, field) => sum + getFieldWidth(field), 0);
            table.style.minWidth = `${Math.max(minimumTableWidth, 600)}px`;

            const tbody = document.getElementById('tableBody');
            records.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.dataset.recordId = record.id;
                tr.ondblclick = () => openExpandedRecord(record.id);

                schema.forEach(field => {
                    const td = document.createElement('td');
                    td.className = 'cell-editable';
                    td.dataset.recordId = record.id;
                    td.dataset.fieldId = field.id;
                    td.style.width = `${getFieldWidth(field)}px`;
                    const value = record[field.id];
                    td.innerHTML = renderCellValue(value, field);
                    addColumnResizer(td, field);
                    if (field.type === 'CHECKBOX') {
                        td.onclick = (e) => {
                            e.stopPropagation();
                            const now = Date.now();
                            if (td._lastToggleTime && now - td._lastToggleTime < 250) return;
                            td._lastToggleTime = now;
                            toggleCheckbox(record.id, field.id);
                        };
                        td.ondblclick = (e) => {
                            e.stopPropagation();
                            openExpandedRecord(record.id);
                        };
                    } else {
                        td.onclick = (e) => {
                            e.stopPropagation();
                            const clickPosition = { x: e.clientX, y: e.clientY };
                            if (td._editTimer) clearTimeout(td._editTimer);
                            td._editTimer = setTimeout(() => {
                                makeEditable(td, record.id, field, clickPosition);
                                td._editTimer = null;
                            }, 180);
                        };
                        td.ondblclick = (e) => {
                            e.stopPropagation();
                            if (td._editTimer) {
                                clearTimeout(td._editTimer);
                                td._editTimer = null;
                            }
                            openExpandedRecord(record.id);
                        };
                    }
                    td.oncontextmenu = (e) => { e.preventDefault(); showCellMenu(e, record.id, field); };
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
        }

        function renderCellValue(value, field) {
            switch(field.type) {
                case 'TEXT': case 'LONG_TEXT': case 'EMAIL': case 'URL': case 'PHONE':
                    return value || '';
                case 'NUMBER':
                    return value ? Number(value).toLocaleString() : '';
                case 'CURRENCY':
                    return value ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value) : '';
                case 'DATE':
                    return value ? new Date(value).toLocaleDateString() : '';
                case 'CHECKBOX':
                    return value ? '‚úÖ' : '‚¨ú';
                case 'LINK_RECORD':
                    if (!value) return '';
                    const linkedName = getRecordDisplayName(value);
                    return `<button class="text-blue-600 hover:underline" onclick="event.stopPropagation(); openLinkedRecord('${value}')">${linkedName}</button>`;
                case 'SINGLE_SELECT':
                    if (!value) return '';
                    const color = field.config?.colors?.[value] || 'gray';
                    return `<span class="badge badge-${color}">${value}</span>`;
                default:
                    return value || '';
            }
        }

        // CARD VIEW
        function renderCardView() {
            const set = getCurrentSet();
            if (!set) return;
            
            const view = getCurrentView();
            let records = Array.from(set.records.values());
            if (view && view.filters.length > 0) records = applyFilterGroups(records, view.filters, set.schema);
            if (view?.sorts?.length) records = applySorts(records, view.sorts, set.schema);

            const container = document.getElementById('viewContainer');
            container.innerHTML = '<div class="cards-grid" id="cardsGrid"></div>';
            
            const grid = document.getElementById('cardsGrid');
            records.forEach(record => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openExpandedRecord(record.id);
                
                const primaryField = set.schema[0];
                const displayFields = set.schema.slice(1, 6);
                
                card.innerHTML = `
                    <div class="card-title">${record[primaryField.id] || 'Untitled'}</div>
                    ${displayFields.map(field => {
                        const value = record[field.id];
                        if (!value && value !== 0 && value !== false) return '';
                        return `
                            <div class="card-field">
                                <div class="card-field-label">${field.name}</div>
                                <div class="card-field-value">${renderCellValue(value, field)}</div>
                            </div>
                        `;
                    }).join('')}
                `;
                
                grid.appendChild(card);
            });
        }

        // KANBAN VIEW
        function renderKanbanView() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            
            if (!view.kanbanGroupField) {
                const container = document.getElementById('viewContainer');
                container.innerHTML = `
                    <div class="kanban-empty-state">
                        <div class="text-4xl mb-4">üìä</div>
                        <p class="text-lg font-semibold mb-2">Configure Kanban Board</p>
                        <p class="mb-4">Select a single-select field to group your records</p>
                        <button onclick="openKanbanConfig()" class="btn btn-primary">Configure Kanban</button>
                    </div>
                `;
                return;
            }
            
            const groupField = set.schema.find(f => f.id === view.kanbanGroupField);
            if (!groupField || groupField.type !== 'SINGLE_SELECT') {
                showToast('‚ö†Ô∏è Invalid kanban configuration');
                return;
            }
            
            let records = Array.from(set.records.values());
            if (view.filters.length > 0) records = applyFilterGroups(records, view.filters, set.schema);
            if (view?.sorts?.length) records = applySorts(records, view.sorts, set.schema);
            
            const container = document.getElementById('viewContainer');
            container.innerHTML = '<div class="kanban-board" id="kanbanBoard"></div>';
            
            const board = document.getElementById('kanbanBoard');
            const options = groupField.config.options || [];
            
            options.forEach(option => {
                const columnRecords = records.filter(r => r[groupField.id] === option);
                const column = createKanbanColumn(option, columnRecords, groupField);
                board.appendChild(column);
            });
            
            // Uncategorized column
            const uncategorized = records.filter(r => !r[groupField.id]);
            if (uncategorized.length > 0) {
                const column = createKanbanColumn('Uncategorized', uncategorized, groupField);
                board.appendChild(column);
            }
        }

        function createKanbanColumn(title, records, groupField) {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.value = title;
            
            const color = groupField.config?.colors?.[title] || 'gray';
            
            column.innerHTML = `
                <div class="kanban-column-header">
                    <div class="kanban-column-title">
                        <span class="badge badge-${color}">${title}</span>
                    </div>
                    <span class="kanban-column-count">${records.length}</span>
                </div>
                <div class="kanban-cards" data-column="${title}"></div>
            `;
            
            const cardsContainer = column.querySelector('.kanban-cards');
            
            // Enable drop
            cardsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            
            cardsContainer.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });
            
            cardsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                column.classList.remove('drag-over');
                
                if (state.draggedRecord) {
                    const newValue = title === 'Uncategorized' ? '' : title;
                    updateRecord(state.draggedRecord.id, groupField.id, newValue, state.draggedRecord[groupField.id]);
                    state.draggedRecord = null;
                    renderKanbanView();
                }
            });
            
            records.forEach(record => {
                const card = createKanbanCard(record);
                cardsContainer.appendChild(card);
            });
            
            return column;
        }

        function createKanbanCard(record) {
            const set = getCurrentSet();
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.recordId = record.id;
            
            const primaryField = set.schema[0];
            const displayFields = set.schema.slice(1, 4);
            
            card.innerHTML = `
                <div class="font-semibold mb-2">${record[primaryField.id] || 'Untitled'}</div>
                ${displayFields.map(field => {
                    const value = record[field.id];
                    if (!value && value !== 0 && value !== false) return '';
                    return `<div class="text-sm text-gray-600 mb-1">${renderCellValue(value, field)}</div>`;
                }).join('')}
            `;
            
            card.addEventListener('dragstart', (e) => {
                state.draggedRecord = record;
                card.classList.add('dragging');
            });
            
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });
            
            card.onclick = (e) => {
                if (!card.classList.contains('dragging')) {
                    openExpandedRecord(record.id);
                }
            };
            
            return card;
        }

        function openKanbanConfig() {
            const set = getCurrentSet();
            const select = document.getElementById('kanbanGroupField');
            select.innerHTML = '<option value="">Select a field...</option>';
            
            set.schema.forEach(field => {
                if (field.type === 'SINGLE_SELECT') {
                    select.innerHTML += `<option value="${field.id}">${field.name}</option>`;
                }
            });
            
            const view = getCurrentView();
            if (view.kanbanGroupField) {
                select.value = view.kanbanGroupField;
            }
            
            openModal('kanbanConfigModal');
        }

        function saveKanbanConfig() {
            const fieldId = document.getElementById('kanbanGroupField').value;
            if (!fieldId) {
                showConfirm('Please select a field to group by', () => {});
                return;
            }
            
            const view = getCurrentView();
            view.kanbanGroupField = fieldId;
            
            closeModal('kanbanConfigModal');
            renderKanbanView();
            showToast('‚úì Kanban configured');
        }

        // CELL EDITING
        function makeEditable(cell, recordId, field, clickPosition = null) {
            if (field.type === 'DATE') { showDatePicker(cell, recordId, field); return; }
            if (field.type === 'SINGLE_SELECT') { showSelectDropdown(cell, recordId, field); return; }
            if (field.type === 'LINK_RECORD') { showLinkedRecordDropdown(cell, recordId, field); return; }

            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            cell.contentEditable = true;
            cell.textContent = currentValue || '';
            cell.focus();

            if (clickPosition) {
                const selection = window.getSelection();
                let range = null;

                if (document.caretPositionFromPoint) {
                    const pos = document.caretPositionFromPoint(clickPosition.x, clickPosition.y);
                    if (pos) {
                        range = document.createRange();
                        range.setStart(pos.offsetNode, pos.offset);
                    }
                } else if (document.caretRangeFromPoint) {
                    range = document.caretRangeFromPoint(clickPosition.x, clickPosition.y);
                }

                if (range) {
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }

            const finishEdit = () => {
                cell.contentEditable = false;
                let newValue = cell.textContent.trim();
                if (field.type === 'NUMBER' || field.type === 'CURRENCY') newValue = parseFloat(newValue) || 0;
                if (String(newValue) !== String(currentValue)) updateRecord(recordId, field.id, newValue, currentValue);
                renderCurrentView();
            };
            
            cell.onblur = finishEdit;
            cell.onkeydown = (e) => {
                if (e.key === 'Enter' && field.type !== 'LONG_TEXT') { e.preventDefault(); finishEdit(); }
            };
        }

        function toggleCheckbox(recordId, fieldId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[fieldId];
            updateRecord(recordId, fieldId, !currentValue, currentValue);
        }

        function showDatePicker(cell, recordId, field) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentValue || '';
            input.className = 'w-full px-2 py-1';
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.onblur = () => {
                const newValue = input.value;
                if (newValue !== currentValue) updateRecord(recordId, field.id, newValue, currentValue);
                renderCurrentView();
            };
        }

        function showSelectDropdown(cell, recordId, field) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            const rect = cell.getBoundingClientRect();
            const dropdown = document.createElement('div');
            dropdown.className = 'context-menu';
            dropdown.style.top = `${rect.bottom + 4}px`;
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.minWidth = '200px';
            
            field.config.options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'context-menu-item';
                const color = field.config.colors[option] || 'gray';
                item.innerHTML = `<span class="badge badge-${color}">${option}</span>`;
                item.onclick = () => {
                    if (option !== currentValue) updateRecord(recordId, field.id, option, currentValue);
                    dropdown.remove();
                    renderCurrentView();
                };
                dropdown.appendChild(item);
            });
            
            document.body.appendChild(dropdown);
            setTimeout(() => {
                document.addEventListener('click', function close(e) {
                    if (!dropdown.contains(e.target)) { dropdown.remove(); document.removeEventListener('click', close); }
                });
            }, 0);
        }

        function showLinkedRecordDropdown(cell, recordId, field) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            const linkedSet = getLinkedSet(field);
            const options = createLinkedRecordOptionList(field);

            cell.innerHTML = '';

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search linked records...';
            searchInput.className = 'w-full mb-2 px-2 py-1 border rounded text-sm';

            const select = document.createElement('select');
            select.className = 'w-full px-2 py-1 border rounded';
            select.innerHTML = '<option value="">Select a record</option>';

            const renderOptions = (query = '') => {
                const normalizedQuery = query.trim().toLowerCase();
                const filtered = options.filter(opt => opt.label.toLowerCase().includes(normalizedQuery));
                const previousValue = select.value;

                select.innerHTML = '<option value="">Select a record</option>';

                if (filtered.length === 0) {
                    const placeholder = document.createElement('option');
                    placeholder.disabled = true;
                    placeholder.textContent = 'No matches';
                    select.appendChild(placeholder);
                    select.value = '';
                } else {
                    filtered.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.id;
                        option.textContent = opt.label;
                        select.appendChild(option);
                    });

                    const stillExists = filtered.some(opt => opt.id === previousValue);
                    select.value = stillExists ? previousValue : (currentValue || '');
                }

                select.disabled = !linkedSet || options.length === 0 || filtered.length === 0;
                searchInput.disabled = !linkedSet || options.length === 0;
            };

            renderOptions();

            searchInput.oninput = () => renderOptions(searchInput.value);

            select.onchange = () => {
                const newValue = select.value;
                if (newValue !== currentValue) updateRecord(recordId, field.id, newValue, currentValue);
                renderCurrentView();
            };

            select.onblur = () => {
                renderCurrentView();
            };

            cell.appendChild(searchInput);
            cell.appendChild(select);

            if (!linkedSet || options.length === 0) {
                const note = document.createElement('div');
                note.className = 'text-xs text-gray-500 mt-1';
                note.textContent = linkedSet
                    ? 'Add records to the linked set to choose one.'
                    : 'Select a set to link to in the field configuration.';
                cell.appendChild(note);
            }

            select.focus();
        }

        function filterLinkedRecordSelect(selectId, query) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const optionsData = select.dataset.options
                ? JSON.parse(decodeURIComponent(select.dataset.options))
                : [];
            const normalizedQuery = query.trim().toLowerCase();
            const filtered = optionsData.filter(opt => opt.label.toLowerCase().includes(normalizedQuery));
            const previousValue = select.value;

            select.innerHTML = '<option value="">Select a record</option>';

            if (filtered.length === 0) {
                const placeholder = document.createElement('option');
                placeholder.disabled = true;
                placeholder.textContent = 'No matches';
                select.appendChild(placeholder);
                select.value = '';
                select.disabled = true;
                return;
            }

            filtered.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.label;
                select.appendChild(option);
            });

            const stillExists = filtered.some(opt => opt.id === previousValue);
            select.value = stillExists ? previousValue : '';
            select.disabled = false;
        }

        function updateRecord(recordId, fieldId, newValue, oldValue) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const field = set.schema.find(f => f.id === fieldId);
            record[fieldId] = newValue;
            createEvent(
                'Update Cell',
                'SEG',
                { type: 'Record', id: recordId, setId: set.id },
                {
                    fieldId: fieldId,
                    fieldName: field.name,
                    oldValue: oldValue,
                    newValue: newValue,
                    setId: set.id,
                    recordId: recordId,
                    summary: `Updated ${field.name}`
                }
            );
            renderCurrentView();
            showToast(`‚úì Updated ${field.name}`);
        }

        // FIELD MANAGEMENT
        function openAddFieldModal() {
            state.selectOptions = [{ value: 'Option 1', color: 'blue' }];
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldType').value = 'TEXT';
            renderFieldTypeGrid('TEXT');
            updateFieldConfig('TEXT');
            
            const linkSelect = document.getElementById('linkToSet');
            linkSelect.innerHTML = '';
            state.sets.forEach((set, setId) => {
                const label = setId === state.currentSetId ? `${set.name} (this set)` : set.name;
                linkSelect.innerHTML += `<option value="${setId}">${label}</option>`;
            });
            if (linkSelect.options.length === 0) {
                linkSelect.innerHTML = '<option value="">No sets available</option>';
                linkSelect.disabled = true;
            } else {
                linkSelect.disabled = false;
                const defaultValue = state.sets.has(state.currentSetId) ? state.currentSetId : linkSelect.options[0].value;
                linkSelect.value = defaultValue;
            }

            openModal('addFieldModal');
        }

        function renderFieldTypeGrid(selectedType) {
            const grid = document.getElementById('fieldTypeGrid');
            grid.innerHTML = '';
            Object.values(FIELD_TYPES).forEach(fieldType => {
                const option = document.createElement('div');
                option.className = `field-type-option ${fieldType.id === selectedType ? 'selected' : ''}`;
                option.onclick = (e) => selectFieldType(fieldType.id, e.currentTarget);
                option.innerHTML = `
                    <div class="field-type-icon">${renderIcon(fieldType.icon)}</div>
                    <div class="field-type-content">
                        <div class="field-type-name">${fieldType.name}</div>
                        <div class="field-type-id">${fieldType.id.replace(/_/g, ' ')}</div>
                    </div>
                `;
                grid.appendChild(option);
            });
        }

        function selectFieldType(typeId, target) {
            document.getElementById('newFieldType').value = typeId;
            document.querySelectorAll('.field-type-option').forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');
            updateFieldConfig(typeId);
        }

        function updateFieldConfig(typeId) {
            document.getElementById('singleSelectConfig').classList.remove('visible');
            document.getElementById('linkToRecordConfig').classList.remove('visible');
            if (typeId === 'SINGLE_SELECT') {
                document.getElementById('singleSelectConfig').classList.add('visible');
                renderSelectOptions();
            } else if (typeId === 'LINK_RECORD') {
                document.getElementById('linkToRecordConfig').classList.add('visible');
            }
        }

        function renderSelectOptions() {
            const container = document.getElementById('selectOptionsList');
            container.innerHTML = state.selectOptions.map((opt, i) => `
                <div class="option-row">
                    <input type="text" value="${opt.value}" onchange="updateSelectOption(${i}, this.value, '${opt.color}')" placeholder="Option ${i + 1}">
                    <div class="color-picker">
                        ${['blue', 'green', 'yellow', 'red', 'purple', 'gray'].map(c => `
                            <div class="color-option badge-${c} ${opt.color === c ? 'selected' : ''}" 
                                 onclick="updateSelectOption(${i}, '${opt.value}', '${c}')"></div>
                        `).join('')}
                    </div>
                    ${state.selectOptions.length > 1 ? `<button onclick="removeSelectOption(${i})" class="btn btn-secondary btn-sm">‚úï</button>` : ''}
                </div>
            `).join('');
        }

        function addSelectOption() {
            state.selectOptions.push({ value: `Option ${state.selectOptions.length + 1}`, color: 'blue' });
            renderSelectOptions();
        }

        function updateSelectOption(index, value, color) {
            state.selectOptions[index] = { value, color };
            renderSelectOptions();
        }

        function removeSelectOption(index) {
            state.selectOptions.splice(index, 1);
            renderSelectOptions();
        }

        function saveField() {
            const name = document.getElementById('newFieldName').value.trim();
            const type = document.getElementById('newFieldType').value;
            if (!name) { showConfirm('Please enter a field name', () => {}); return; }
            
            const set = getCurrentSet();
            const fieldId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (set.schema.find(f => f.id === fieldId)) {
                showConfirm('A field with this name already exists', () => {});
                return;
            }
            
            const newField = { id: fieldId, name: name, type: type, width: '150px', config: {} };

            if (type === 'SINGLE_SELECT') {
                newField.config = {
                    options: state.selectOptions.map(o => o.value),
                    colors: Object.fromEntries(state.selectOptions.map(o => [o.value, o.color]))
                };
            } else if (type === 'LINK_RECORD') {
                const linkedSetId = document.getElementById('linkToSet').value;
                if (!linkedSetId) { showConfirm('Select a set to link to', () => {}); return; }
                newField.config = { linkedSetId };
            }
            
            set.schema.push(newField);
            set.records.forEach(r => r[fieldId] = FIELD_TYPES[type].defaultValue);
            
            closeModal('addFieldModal');
            renderCurrentView();
            
            // Scroll to new field
            setTimeout(() => {
                const header = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
                    header.style.animation = 'flash-yellow 0.5s ease-out';
                }
            }, 100);
            
            showToast('‚úì Field added');
        }

        // FILTERING (simplified for space)
        function openFilterModal() {
            renderFilterBuilder();
            openModal('filterModal');
        }

        function renderFilterBuilder() {
            const view = getCurrentView();
            const container = document.getElementById('filterGroupsContainer');
            if (!view.filters || view.filters.length === 0) view.filters = [[{ field: '', operator: 'equals', value: '' }]];
            container.innerHTML = view.filters.map((group, groupIndex) => `
                <div class="filter-group">
                    <div class="filter-group-header">
                        <div class="filter-operator-toggle">
                            <button class="${group.operator !== 'OR' ? 'active' : ''}" onclick="setGroupOperator(${groupIndex}, 'AND')">AND</button>
                            <button class="${group.operator === 'OR' ? 'active' : ''}" onclick="setGroupOperator(${groupIndex}, 'OR')">OR</button>
                        </div>
                        <button onclick="removeFilterGroup(${groupIndex})" class="text-red-600 text-sm">Remove Group</button>
                    </div>
                    ${group.map((rule, ruleIndex) => renderFilterRule(groupIndex, ruleIndex, rule)).join('')}
                    <button onclick="addFilterRule(${groupIndex})" class="btn btn-secondary btn-sm mt-2">+ Add Rule</button>
                </div>
            `).join('');
        }

        function renderFilterRule(groupIndex, ruleIndex, rule) {
            const schema = getCurrentSet().schema;
            return `
                <div class="filter-rule">
                    <select onchange="updateFilterField(${groupIndex}, ${ruleIndex}, this.value)">
                        <option value="">Select field...</option>
                        ${schema.map(f => `<option value="${f.id}" ${f.id === rule.field ? 'selected' : ''}>${f.name}</option>`).join('')}
                    </select>
                    <select><option>equals</option></select>
                    <input type="text" value="${rule.value || ''}" onchange="updateFilterValue(${groupIndex}, ${ruleIndex}, this.value)">
                    <button onclick="removeFilterRule(${groupIndex}, ${ruleIndex})" class="text-red-600">‚úï</button>
                </div>
            `;
        }

        function applyFilterGroups(records, filterGroups, schema) {
            return records.filter(record => {
                return filterGroups.some(group => {
                    const operator = group.operator || 'AND';
                    const rules = group.filter(r => r.field);
                    if (operator === 'AND') return rules.every(rule => record[rule.field] === rule.value);
                    else return rules.some(rule => record[rule.field] === rule.value);
                });
            });
        }

        function getSortableValue(value, field) {
            if (value === undefined || value === null) return '';
            switch(field?.type) {
                case 'NUMBER':
                case 'CURRENCY':
                    return Number(value) || 0;
                case 'DATE':
                    return new Date(value).getTime() || 0;
                case 'CHECKBOX':
                    return value ? 1 : 0;
                default:
                    return String(value).toLowerCase();
            }
        }

        function applySorts(records, sorts, schema) {
            if (!sorts || sorts.length === 0) return records;
            const schemaMap = new Map(schema.map(f => [f.id, f]));
            const activeSorts = sorts.filter(sort => schemaMap.has(sort.fieldId));
            if (activeSorts.length === 0) return records;

            return [...records].sort((a, b) => {
                for (const sort of activeSorts) {
                    const field = schemaMap.get(sort.fieldId);
                    const aVal = getSortableValue(a[sort.fieldId], field);
                    const bVal = getSortableValue(b[sort.fieldId], field);

                    if (aVal < bVal) return sort.direction === 'desc' ? 1 : -1;
                    if (aVal > bVal) return sort.direction === 'desc' ? -1 : 1;
                }
                return 0;
            });
        }

        function toggleColumnSort(fieldId) {
            const view = getCurrentView();
            if (!view) return;

            ensureViewDefaults(view);
            const existingIndex = view.sorts.findIndex(s => s.fieldId === fieldId);
            if (existingIndex === -1) {
                view.sorts.unshift({ fieldId, direction: 'asc' });
            } else if (view.sorts[existingIndex].direction === 'asc') {
                view.sorts[existingIndex].direction = 'desc';
            } else {
                view.sorts.splice(existingIndex, 1);
            }

            renderCurrentView();
        }

        function openSortModal() {
            const view = getCurrentView();
            if (!view) return;

            ensureViewDefaults(view);
            renderSortBuilder();
            openModal('sortModal');
        }

        function renderSortBuilder() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;

            const container = document.getElementById('sortRulesContainer');
            const schema = set.schema;

            if (!view.sorts || view.sorts.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No sorts configured. Add a field to start sorting.</p>';
                return;
            }

            container.innerHTML = view.sorts.map((sort, index) => `
                <div class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-gray-50">
                    <div class="text-xs font-semibold text-gray-500">#${index + 1}</div>
                    <select class="flex-1" onchange="updateSortField(${index}, this.value)">
                        <option value="">Select field...</option>
                        ${schema.map(f => `<option value="${f.id}" ${f.id === sort.fieldId ? 'selected' : ''}>${f.name}</option>`).join('')}
                    </select>
                    <select onchange="updateSortDirection(${index}, this.value)">
                        <option value="asc" ${sort.direction === 'asc' ? 'selected' : ''}>Ascending</option>
                        <option value="desc" ${sort.direction === 'desc' ? 'selected' : ''}>Descending</option>
                    </select>
                    <div class="flex items-center gap-1">
                        <button class="btn btn-secondary btn-sm" onclick="moveSort(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button class="btn btn-secondary btn-sm" onclick="moveSort(${index}, 1)" ${index === view.sorts.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        <button class="btn btn-danger btn-sm" onclick="removeSortRule(${index})">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function addSortRule() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;

            const defaultField = set.schema[0]?.id || '';
            view.sorts.push({ fieldId: defaultField, direction: 'asc' });
            renderSortBuilder();
        }

        function updateSortField(index, fieldId) {
            const view = getCurrentView();
            if (!view) return;
            view.sorts[index].fieldId = fieldId;
            renderSortBuilder();
        }

        function updateSortDirection(index, direction) {
            const view = getCurrentView();
            if (!view) return;
            view.sorts[index].direction = direction;
            renderSortBuilder();
        }

        function moveSort(index, delta) {
            const view = getCurrentView();
            if (!view) return;
            const newIndex = index + delta;
            if (newIndex < 0 || newIndex >= view.sorts.length) return;
            const [item] = view.sorts.splice(index, 1);
            view.sorts.splice(newIndex, 0, item);
            renderSortBuilder();
        }

        function removeSortRule(index) {
            const view = getCurrentView();
            if (!view) return;
            view.sorts.splice(index, 1);
            renderSortBuilder();
        }

        function clearSorts() {
            const view = getCurrentView();
            if (!view) return;
            view.sorts = [];
            renderSortBuilder();
            renderCurrentView();
        }

        function applySortsFromModal() {
            closeModal('sortModal');
            renderCurrentView();
        }

        function setGroupOperator(groupIndex, operator) {
            const view = getCurrentView();
            view.filters[groupIndex].operator = operator;
            renderFilterBuilder();
        }

        function addFilterRule(groupIndex) {
            const view = getCurrentView();
            view.filters[groupIndex].push({ field: '', operator: 'equals', value: '' });
            renderFilterBuilder();
        }

        function removeFilterRule(groupIndex, ruleIndex) {
            const view = getCurrentView();
            view.filters[groupIndex].splice(ruleIndex, 1);
            if (view.filters[groupIndex].length === 0) view.filters.splice(groupIndex, 1);
            renderFilterBuilder();
        }

        function addFilterGroup() {
            const view = getCurrentView();
            view.filters.push([{ field: '', operator: 'equals', value: '' }]);
            renderFilterBuilder();
        }

        function removeFilterGroup(groupIndex) {
            const view = getCurrentView();
            view.filters.splice(groupIndex, 1);
            renderFilterBuilder();
        }

        function updateFilterField(groupIndex, ruleIndex, fieldId) {
            const view = getCurrentView();
            view.filters[groupIndex][ruleIndex].field = fieldId;
            renderFilterBuilder();
        }

        function updateFilterValue(groupIndex, ruleIndex, value) {
            const view = getCurrentView();
            view.filters[groupIndex][ruleIndex].value = value;
        }

        function applyFilters() {
            closeModal('filterModal');
            renderCurrentView();
            showToast('‚úì Filters applied');
        }

        function clearFilters() {
            const view = getCurrentView();
            view.filters = [[{ field: '', operator: 'equals', value: '' }]];
            renderFilterBuilder();
        }

        // EXPANDED RECORD
        function openExpandedRecord(recordId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            state.currentRecordTab = 'history';
            state.recordHistoryVisible = true;
            document.getElementById('expandedRecordTitle').textContent = record.name || record.id;
            renderExpandedRecordMain(recordId);
            renderRecordSidebar(recordId);
            updateRecordHistoryVisibility();
            openModal('expandedRecordModal');
        }

        function openCellHistory(recordId, fieldId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const field = set.schema.find(f => f.id === fieldId);
            const modal = document.getElementById('cellHistoryModal');

            const entries = state.eventStream
                .filter(e => e.op === 'SEG' && e.data?.recordId === recordId && e.data?.fieldId === fieldId)
                .sort((a, b) => new Date(a.published) - new Date(b.published));

            state.cellHistoryContext = {
                recordId,
                fieldId,
                fieldName: field?.name || fieldId,
                recordName: record?.name || recordId,
                entries,
                index: entries.length > 0 ? entries.length - 1 : 0,
                selectedValueSource: 'new'
            };

            renderCellHistoryModal();
            if (modal.classList.contains('hidden')) openModal('cellHistoryModal');
        }

        function renderCellHistoryModal() {
            const container = document.getElementById('cellHistoryContent');
            const title = document.getElementById('cellHistoryTitle');
            const subtitle = document.getElementById('cellHistorySubtitle');
            const ctx = state.cellHistoryContext;

            if (!ctx) return;

            title.textContent = `${ctx.fieldName} history`;
            subtitle.textContent = `Record: ${ctx.recordName}`;

            if (ctx.entries.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No history for this cell yet.</p>';
                return;
            }

            if (ctx.index >= ctx.entries.length) ctx.index = ctx.entries.length - 1;

            const activeEntry = ctx.entries[ctx.index];
            const selectedValue = ctx.selectedValueSource === 'old'
                ? activeEntry.data?.oldValue
                : activeEntry.data?.newValue;

            container.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm text-gray-600">${ctx.entries.length} change${ctx.entries.length === 1 ? '' : 's'} found</div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-secondary btn-sm" ${ctx.index === 0 ? 'disabled' : ''} onclick="stepCellHistory(-1)">‚óÄ Prev</button>
                        <button class="btn btn-secondary btn-sm" ${ctx.index >= ctx.entries.length - 1 ? 'disabled' : ''} onclick="stepCellHistory(1)">Next ‚ñ∂</button>
                    </div>
                </div>
                <div class="space-y-3 mb-4">
                    ${ctx.entries.map((entry, i) => `
                        <div class="border rounded-lg p-3 ${i === ctx.index ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white'}" onclick="selectCellHistoryEntry(${i})">
                            <div class="flex items-center justify-between">
                                <div class="font-medium">${entry.data?.fieldName || ctx.fieldName}</div>
                                <div class="text-xs text-gray-500">${new Date(entry.published).toLocaleString()}</div>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${entry.data?.summary || 'Updated value'}</div>
                            <div class="text-sm mt-2 flex items-center gap-2">
                                <span class="text-red-600">${entry.data?.oldValue ?? '‚Äî'}</span>
                                <span>‚Üí</span>
                                <span class="text-green-600">${entry.data?.newValue ?? '‚Äî'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="border-t pt-4">
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="text-sm text-gray-700">Apply value from selected change:</span>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-secondary btn-sm ${ctx.selectedValueSource === 'old' ? 'bg-gray-200' : ''}" onclick="chooseHistoryValue('old')">Use old value</button>
                            <button class="btn btn-secondary btn-sm ${ctx.selectedValueSource === 'new' ? 'bg-gray-200' : ''}" onclick="chooseHistoryValue('new')">Use new value</button>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="applySelectedHistoricalValue()">Apply to cell</button>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">Selected value preview: <span class="font-semibold text-gray-900">${selectedValue ?? '‚Äî'}</span></div>
                </div>
            `;
        }

        function selectCellHistoryEntry(index) {
            if (!state.cellHistoryContext) return;
            state.cellHistoryContext.index = index;
            renderCellHistoryModal();
        }

        function stepCellHistory(direction) {
            if (!state.cellHistoryContext || state.cellHistoryContext.entries.length === 0) return;
            const newIndex = Math.min(Math.max(state.cellHistoryContext.index + direction, 0), state.cellHistoryContext.entries.length - 1);
            state.cellHistoryContext.index = newIndex;
            renderCellHistoryModal();
        }

        function chooseHistoryValue(source) {
            if (!state.cellHistoryContext) return;
            state.cellHistoryContext.selectedValueSource = source;
            renderCellHistoryModal();
        }

        function applySelectedHistoricalValue() {
            const ctx = state.cellHistoryContext;
            if (!ctx || ctx.entries.length === 0) return;

            const entry = ctx.entries[ctx.index];
            const selectedValue = ctx.selectedValueSource === 'old'
                ? entry.data?.oldValue
                : entry.data?.newValue;

            const set = getCurrentSet();
            const record = set.records.get(ctx.recordId);
            const currentValue = record ? record[ctx.fieldId] : undefined;

            updateRecord(ctx.recordId, ctx.fieldId, selectedValue, currentValue);

            if (!document.getElementById('expandedRecordModal').classList.contains('hidden')) {
                renderExpandedRecordMain(ctx.recordId);
                renderRecordSidebar(ctx.recordId);
            }

            openCellHistory(ctx.recordId, ctx.fieldId);
        }

        function ensurePopupRule(fieldId) {
            const view = getCurrentView();
            if (!view) return null;
            view.popupVisibilityRules = view.popupVisibilityRules || [];
            let rule = view.popupVisibilityRules.find(r => r.fieldId === fieldId);
            if (!rule) {
                rule = { fieldId, visibility: 'show', criteria: { type: 'always', value: '' } };
                view.popupVisibilityRules.push(rule);
            }
            return rule;
        }

        function evaluatePopupCriteria(criteria, value) {
            if (!criteria || criteria.type === 'always') return true;

            switch (criteria.type) {
                case 'equals':
                    return String(value ?? '').toLowerCase() === String(criteria.value ?? '').toLowerCase();
                case 'notEquals':
                    return String(value ?? '').toLowerCase() !== String(criteria.value ?? '').toLowerCase();
                case 'contains':
                    return String(value ?? '').toLowerCase().includes(String(criteria.value ?? '').toLowerCase());
                case 'empty':
                    return value === undefined || value === null || value === '';
                case 'notEmpty':
                    return !(value === undefined || value === null || value === '');
                default:
                    return true;
            }
        }

        function refreshOpenRecordModal() {
            const container = document.getElementById('expandedRecordMain');
            const recordId = container?.dataset?.recordId;
            if (recordId && !document.getElementById('expandedRecordModal').classList.contains('hidden')) {
                renderExpandedRecordMain(recordId);
            }
        }

        function shouldDisplayFieldInPopup(field, record) {
            const view = getCurrentView();
            if (!view) return true;
            view.popupVisibilityRules = view.popupVisibilityRules || [];
            const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id);
            if (!rule) return true;

            const criteriaMet = evaluatePopupCriteria(rule.criteria, record[field.id]);
            if (!rule.criteria || criteriaMet) {
                return rule.visibility !== 'hide';
            }

            return true;
        }

        function renderExpandedRecordMain(recordId) {
            const set = getCurrentSet();
            const view = getCurrentView();
            const record = set.records.get(recordId);
            const container = document.getElementById('expandedRecordMain');
            container.dataset.recordId = recordId;

            const orderedFields = view ? getPopupOrderedFields(set, view) : set.schema;
            const visibleFields = orderedFields.filter(field => shouldDisplayFieldInPopup(field, record));

            container.innerHTML = visibleFields.length === 0
                ? '<p class="text-gray-500">No fields are visible in this popup based on the current view settings.</p>'
                : `
                <div class="space-y-4">
                    ${visibleFields.map(field => `
                        <div class="field-editor">
                            <label class="form-label">${field.name}</label>
                            ${renderFieldEditor(recordId, field, record[field.id])}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFieldEditor(recordId, field, value) {
            switch(field.type) {
                case 'TEXT': case 'EMAIL': case 'URL': case 'PHONE':
                    return `<input type="text" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
                case 'LONG_TEXT':
                    return `<textarea rows="4" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">${value || ''}</textarea>`;
                case 'NUMBER': case 'CURRENCY':
                    return `<input type="number" value="${value || 0}" onchange="updateRecordField('${recordId}', '${field.id}', parseFloat(this.value))">`;
                case 'DATE':
                    return `<input type="date" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
                case 'CHECKBOX':
                    return `<input type="checkbox" ${value ? 'checked' : ''} onchange="updateRecordField('${recordId}', '${field.id}', this.checked)">`;
                case 'LINK_RECORD': {
                    const linkedSet = getLinkedSet(field);
                    const options = createLinkedRecordOptionList(field);
                    const disabled = !linkedSet || options.length === 0;
                    const selectId = `linked-record-select-${recordId}-${field.id}`;
                    const optionsDataAttr = encodeURIComponent(JSON.stringify(options));
                    const hint = !linkedSet
                        ? '<p class="text-xs text-gray-500 mt-1">Configure a linked set to enable selection.</p>'
                        : options.length === 0
                            ? '<p class="text-xs text-gray-500 mt-1">Add records to the linked set to select one.</p>'
                            : '';

                    return `
                        <div class="space-y-1">
                            <input type="text" class="border rounded px-3 py-2 text-sm w-full" placeholder="Search linked records..." ${disabled ? 'disabled' : ''} oninput="filterLinkedRecordSelect('${selectId}', this.value)">
                            <select id="${selectId}" class="border rounded px-3 py-2 text-sm w-full" data-options="${optionsDataAttr}" ${disabled ? 'disabled' : ''} onchange="updateRecordField('${recordId}', '${field.id}', this.value)">
                                <option value="">Select a record</option>
                                ${options.map(opt => `<option value="${opt.id}" ${opt.id === value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                            </select>
                            ${hint}
                        </div>
                    `;
                }
                case 'SINGLE_SELECT':
                    return `<select onchange="updateRecordField('${recordId}', '${field.id}', this.value)">
                        <option value="">Select...</option>
                        ${field.config.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>`;
                default:
                    return `<input type="text" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
            }
        }

        function updateRecordField(recordId, fieldId, value) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const oldValue = record[fieldId];
            updateRecord(recordId, fieldId, value, oldValue);
            renderExpandedRecordMain(recordId);
        }

        function switchRecordTab(tab) {
            state.currentRecordTab = tab;
            const recordId = document.getElementById('expandedRecordMain').dataset.recordId;
            renderExpandedRecordMain(recordId);
            renderRecordSidebar(recordId);
            updateRecordHistoryVisibility();
        }

        function renderRecordSidebar(recordId) {
            const container = document.getElementById('expandedRecordSidebar');
            document.querySelectorAll('.record-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === state.currentRecordTab);
            });

            if (!container) return;

            switch (state.currentRecordTab) {
                case 'connections':
                    renderConnectionsSidebar(container, recordId);
                    break;
                case 'history':
                default:
                    renderHistorySidebar(container, recordId);
                    break;
            }
        }

        function renderHistorySidebar(container, recordId) {
            const history = state.eventStream.filter(e => e.object?.id === recordId && e.op === 'SEG');
            container.innerHTML = `
                <h3 class="font-semibold mb-4">Change History</h3>
                ${history.length === 0 ? '<p class="text-gray-500">No changes yet</p>' : ''}
                ${history.map(e => `
                    <div class="history-entry">
                        <div class="font-medium">${e.data?.fieldName || 'Field change'}</div>
                        <div class="text-sm text-gray-500">${getTimeAgo(e.published)}</div>
                        <div class="text-sm mt-1">
                            <span class="text-red-600">${e.data?.oldValue}</span> ‚Üí
                            <span class="text-green-600">${e.data?.newValue}</span>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getConnectionBuilder() {
            if (!state.connectionBuilder) {
                state.connectionBuilder = { targetSetId: null, targetRecordId: '', metadataJson: '' };
            }
            return state.connectionBuilder;
        }

        function renderConnectionsSidebar(container, recordId) {
            const builder = getConnectionBuilder();
            const setEntries = Array.from(state.sets.entries());
            const selectedSetId = builder.targetSetId && state.sets.has(builder.targetSetId)
                ? builder.targetSetId
                : (setEntries[0]?.[0] || null);
            if (builder.targetSetId !== selectedSetId) builder.targetSetId = selectedSetId;

            const selectedSet = selectedSetId ? state.sets.get(selectedSetId) : null;
            const availableRecords = selectedSet ? Array.from(selectedSet.records.values()).filter(r => r.id !== recordId) : [];
            const selectedRecordId = availableRecords.some(rec => rec.id === builder.targetRecordId) ? builder.targetRecordId : '';
            if (builder.targetRecordId !== selectedRecordId) builder.targetRecordId = selectedRecordId;

            const metadataText = builder.metadataJson || '';
            const connections = Array.from(state.connections.values()).filter(edge => edge.sourceId === recordId || edge.targetId === recordId);

            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="font-semibold">Connections</h3>
                        <p class="text-sm text-gray-600">Link this record to other records.</p>
                    </div>
                    <div class="border border-gray-200 bg-white rounded-lg p-4 space-y-3">
                        <label class="form-label">Select set</label>
                        <select id="newConnectionSet" class="border rounded px-3 py-2 text-sm w-full" onchange="handleConnectionSetChange('${recordId}', this.value)">
                            ${setEntries.length === 0 ? '<option value="">No sets available</option>' : ''}
                            ${setEntries.map(([id, set]) => `<option value="${id}" ${id === selectedSetId ? 'selected' : ''}>${set.name || id}</option>`).join('')}
                        </select>
                        <label class="form-label">Connect to</label>
                        <select id="newConnectionTarget" class="border rounded px-3 py-2 text-sm w-full" onchange="handleConnectionRecordChange('${recordId}', this.value)" ${!selectedSetId ? 'disabled' : ''}>
                            <option value="">${selectedSetId ? 'Select a record' : 'Select a set first'}</option>
                            ${availableRecords.map(rec => `<option value="${rec.id}" ${rec.id === selectedRecordId ? 'selected' : ''}>${rec.name || rec.id}</option>`).join('')}
                        </select>
                        <label class="form-label">Parameters (JSON object)</label>
                        <textarea id="newConnectionMetadata" class="border rounded px-3 py-2 text-sm w-full h-24" placeholder="{\"role\": \"depends-on\"}" oninput="updateConnectionBuilderMetadata('${recordId}', this.value)">${metadataText}</textarea>
                        <button class="btn btn-primary btn-sm" onclick="createConnectionFromSidebar('${recordId}')" ${(availableRecords.length === 0 || !selectedRecordId) ? 'disabled' : ''}>Add Connection</button>
                        ${availableRecords.length === 0 ? '<p class="text-xs text-gray-500">Add records to the selected set to create connections.</p>' : ''}
                    </div>
                    <div class="space-y-3">
                        ${connections.length === 0 ? '<p class="text-gray-500">No connections yet.</p>' : connections.map(edge => renderConnectionCard(edge, recordId)).join('')}
                    </div>
                </div>
            `;
        }

        function handleConnectionSetChange(recordId, setId) {
            const builder = getConnectionBuilder();
            builder.targetSetId = setId || null;
            builder.targetRecordId = '';
            renderRecordSidebar(recordId);
        }

        function handleConnectionRecordChange(recordId, targetId) {
            const builder = getConnectionBuilder();
            builder.targetRecordId = targetId || '';
            renderRecordSidebar(recordId);
        }

        function updateConnectionBuilderMetadata(recordId, value) {
            const builder = getConnectionBuilder();
            builder.metadataJson = value;
        }

        function renderConnectionCard(edge, recordId) {
            const isSource = edge.sourceId === recordId;
            const otherId = isSource ? edge.targetId : edge.sourceId;
            const otherName = getRecordDisplayName(otherId);
            const direction = isSource ? '‚Üí' : '‚Üê';
            const timestamp = edge.updatedAt || edge.createdAt;

            return `
                <div class="border border-gray-200 rounded-lg p-3 bg-white">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <div class="font-semibold">${direction} ${otherName}</div>
                            <div class="text-xs text-gray-500">${isSource ? 'Source' : 'Target'} ¬∑ ${timestamp ? getTimeAgo(timestamp) : ''}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="text-sm text-blue-600" onclick="editConnectionParameters('${edge.id}', '${recordId}')">Edit parameters</button>
                            <button class="text-sm text-red-500" onclick="deleteConnectionFromSidebar('${edge.id}', '${recordId}')">Remove</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="text-xs font-semibold text-gray-600 mb-1">Parameters</div>
                        ${renderConnectionMetadata(edge.metadata)}
                    </div>
                </div>
            `;
        }

        function renderConnectionMetadata(metadata) {
            if (!metadata || !Object.keys(metadata).length) {
                return '<p class="text-xs text-gray-500">No parameters</p>';
            }

            return `<dl class="text-xs text-gray-700 space-y-1">
                ${Object.entries(metadata).map(([key, value]) => `
                    <div class="flex justify-between gap-2">
                        <dt class="font-medium text-gray-600">${key}</dt>
                        <dd class="text-right break-all text-gray-800">${typeof value === 'object' ? JSON.stringify(value) : value}</dd>
                    </div>
                `).join('')}
            </dl>`;
        }

        function parseConnectionMetadata(raw) {
            if (!raw || !raw.trim()) return {};

            let parsed;
            try {
                parsed = JSON.parse(raw);
            } catch (err) {
                throw new Error('Connection parameters must be valid JSON');
            }

            if (parsed === null || typeof parsed !== 'object' || Array.isArray(parsed)) {
                throw new Error('Connection parameters must be a JSON object');
            }

            return parsed;
        }

        function editConnectionParameters(connectionId, recordId) {
            const existing = state.connections.get(connectionId);
            if (!existing) {
                showToast('Connection not found');
                return;
            }

            const currentJson = JSON.stringify(existing.metadata || {}, null, 2);
            const input = prompt('Edit connection parameters (JSON object)', currentJson);
            if (input === null) return;

            let parsed;
            try {
                parsed = parseConnectionMetadata(input);
            } catch (err) {
                showToast(err.message);
                return;
            }

            updateConnection(connectionId, { metadata: parsed });
            renderRecordSidebar(recordId);
            showToast('‚úì Parameters updated');
        }

        function getRecordDisplayName(recordId) {
            const ref = getRecordById(recordId);
            return ref?.record?.name || recordId;
        }

        function openLinkedRecord(recordId) {
            if (!recordId) return;
            const ref = getRecordById(recordId);
            if (!ref) {
                showToast('Linked record not found');
                return;
            }

            const firstViewId = ref.set.views.size ? Array.from(ref.set.views.keys())[0] : null;
            if (ref.setId !== state.currentSetId) {
                switchSet(ref.setId, firstViewId);
            }
            openExpandedRecord(recordId);
        }

        function createConnectionFromSidebar(recordId) {
            const builder = getConnectionBuilder();
            const target = builder.targetRecordId || document.getElementById('newConnectionTarget')?.value;
            if (!target) {
                showToast('Select a record to connect');
                return;
            }

            const rawMetadata = document.getElementById('newConnectionMetadata')?.value || builder.metadataJson || '';
            let metadata = {};
            try {
                metadata = parseConnectionMetadata(rawMetadata);
            } catch (err) {
                showToast(err.message);
                return;
            }

            builder.targetRecordId = '';
            createConnection(recordId, target, metadata);
            renderRecordSidebar(recordId);
            showToast('‚úì Connection created');
        }

        function deleteConnectionFromSidebar(connectionId, recordId) {
            deleteConnection(connectionId);
            renderRecordSidebar(recordId);
            showToast('‚úì Connection removed');
        }

        function updateRecordHistoryVisibility() {
            const historyColumn = document.getElementById('expandedRecordHistoryColumn');
            const mainWrapper = document.getElementById('expandedRecordMainWrapper');
            const toggleBtn = document.getElementById('toggleHistorySidebarBtn');
            const isVisible = state.recordHistoryVisible;

            if (historyColumn) historyColumn.classList.toggle('hidden', !isVisible);
            if (mainWrapper) {
                mainWrapper.classList.toggle('md:col-span-3', !isVisible);
                mainWrapper.classList.toggle('md:col-span-2', isVisible);
                mainWrapper.classList.toggle('border-r', isVisible);
            }
            if (toggleBtn) {
                toggleBtn.disabled = false;
                toggleBtn.textContent = state.recordHistoryVisible ? 'Hide History' : 'Show History';
            }
        }

        function toggleRecordHistoryVisibility() {
            state.recordHistoryVisible = !state.recordHistoryVisible;
            updateRecordHistoryVisibility();
        }

        function getPopupLayout(view) {
            view.popupLayout = view.popupLayout || { size: 'medium', columns: 2 };
            return view.popupLayout;
        }

        function getPopupOrderedFields(set, view) {
            const defaultOrder = set.schema.map(f => f.id);
            view.popupFieldOrder = Array.isArray(view.popupFieldOrder) && view.popupFieldOrder.length
                ? view.popupFieldOrder
                : defaultOrder;
            const orderMap = new Map(view.popupFieldOrder.map((id, idx) => [id, idx]));
            return [...set.schema].sort((a, b) => {
                const aIndex = orderMap.has(a.id) ? orderMap.get(a.id) : Number.MAX_SAFE_INTEGER;
                const bIndex = orderMap.has(b.id) ? orderMap.get(b.id) : Number.MAX_SAFE_INTEGER;
                return aIndex - bIndex;
            });
        }

        function renderPopupSettings(targetIds = ['popupSettingsFields', 'popupSettingsSidebar']) {
            const popupModal = document.getElementById('popupSettingsModal');
            const modalOpen = popupModal && !popupModal.classList.contains('hidden');
            if (modalOpen) {
                renderPopupConfigurator();
            }
            renderInlinePopupSettings(targetIds);
        }

        function renderInlinePopupSettings(targetIds = ['popupSettingsFields']) {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;

            view.popupVisibilityRules = view.popupVisibilityRules || [];
            const fields = getPopupOrderedFields(set, view);
            const popupSettingsHtml = fields.map(field => {
                const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id) || { visibility: 'show', criteria: { type: 'always', value: '' } };
                const criteriaType = rule.criteria?.type || 'always';
                const criteriaValue = rule.criteria?.value || '';
                const needsValue = ['equals', 'notEquals', 'contains'].includes(criteriaType);

                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between gap-4 flex-wrap">
                            <div>
                                <div class="font-semibold text-gray-900">${field.name}</div>
                                <div class="text-sm text-gray-500">${field.type}</div>
                            </div>
                            <div class="flex items-center gap-3 flex-wrap">
                                <label class="text-sm text-gray-600 flex items-center gap-2">
                                    Visibility
                                    <select class="border rounded px-2 py-1" onchange="updatePopupVisibilityRule('${field.id}', this.value)">
                                        <option value="show" ${rule.visibility !== 'hide' ? 'selected' : ''}>Show</option>
                                        <option value="hide" ${rule.visibility === 'hide' ? 'selected' : ''}>Hide</option>
                                    </select>
                                </label>
                                <label class="text-sm text-gray-600 flex items-center gap-2">
                                    Criteria
                                    <select class="border rounded px-2 py-1" onchange="updatePopupCriteriaType('${field.id}', this.value)">
                                        <option value="always" ${criteriaType === 'always' ? 'selected' : ''}>Always</option>
                                        <option value="equals" ${criteriaType === 'equals' ? 'selected' : ''}>Value equals</option>
                                        <option value="notEquals" ${criteriaType === 'notEquals' ? 'selected' : ''}>Value not equal</option>
                                        <option value="contains" ${criteriaType === 'contains' ? 'selected' : ''}>Value contains</option>
                                        <option value="empty" ${criteriaType === 'empty' ? 'selected' : ''}>When empty</option>
                                        <option value="notEmpty" ${criteriaType === 'notEmpty' ? 'selected' : ''}>When not empty</option>
                                    </select>
                                </label>
                                <input
                                    type="text"
                                    class="border rounded px-3 py-1 text-sm ${needsValue ? '' : 'opacity-50'}"
                                    placeholder="Criteria value"
                                    value="${criteriaValue}"
                                    ${needsValue ? '' : 'disabled'}
                                    oninput="updatePopupCriteriaValue('${field.id}', this.value)">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const targets = Array.isArray(targetIds) ? targetIds : [targetIds];
            targets.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = popupSettingsHtml;
            });
        }

        function openPopupSettingsModal() {
            state.popupUi = state.popupUi || { filter: 'all', activeTab: 'popupFields' };
            state.popupUi.filter = state.popupUi.filter || 'all';
            state.popupUi.activeTab = 'popupFields';
            renderPopupConfigurator();
            openModal('popupSettingsModal');
        }

        function updatePopupVisibilityRule(fieldId, visibility) {
            const rule = ensurePopupRule(fieldId);
            if (!rule) return;
            rule.visibility = visibility;
            logPopupEvent('visibility', { fieldId, visibility });
            renderPopupSettings();
            refreshOpenRecordModal();
        }

        function updatePopupCriteriaType(fieldId, type) {
            const rule = ensurePopupRule(fieldId);
            if (!rule) return;
            rule.criteria = rule.criteria || { type: 'always', value: '' };
            rule.criteria.type = type;
            if (!['equals', 'notEquals', 'contains'].includes(type)) {
                rule.criteria.value = '';
            }
            renderPopupSettings();
            logPopupEvent('criteriaType', { fieldId, type });
            refreshOpenRecordModal();
        }

        function updatePopupCriteriaValue(fieldId, value) {
            const rule = ensurePopupRule(fieldId);
            if (!rule) return;
            rule.criteria = rule.criteria || { type: 'always', value: '' };
            rule.criteria.value = value;
            logPopupEvent('criteriaValue', { fieldId, value });
            renderPopupSettings();
            refreshOpenRecordModal();
        }

        function setPopupTab(tab) {
            state.popupUi.activeTab = tab;
            document.querySelectorAll('.popup-config-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.popup-tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === tab);
            });
            renderPopupConfigurator();
        }

        function setPopupFilter(filter) {
            state.popupUi.filter = filter;
            renderPopupConfigurator();
        }

        function renderPopupFilters() {
            const filters = [
                { id: 'all', label: 'All Fields' },
                { id: 'visible', label: '‚úì Visible' },
                { id: 'hidden', label: '‚¶ª Hidden' },
                { id: 'conditional', label: '‚ö° Conditional' }
            ];
            const container = document.getElementById('popupFilters');
            if (!container) return;
            container.innerHTML = filters.map(f => `
                <button class="popup-filter ${state.popupUi.filter === f.id ? 'active' : ''}" onclick="setPopupFilter('${f.id}')">${f.label}</button>
            `).join('');
        }

        function togglePopupFieldVisibility(fieldId) {
            const rule = ensurePopupRule(fieldId);
            if (!rule) return;
            const newVisibility = rule.visibility === 'hide' ? 'show' : 'hide';
            updatePopupVisibilityRule(fieldId, newVisibility);
        }

        function renderPopupFieldList() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            view.popupVisibilityRules = view.popupVisibilityRules || [];

            const fields = getPopupOrderedFields(set, view).filter(field => {
                const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id);
                const isVisible = !rule || rule.visibility !== 'hide';
                const hasCondition = rule?.criteria?.type && rule.criteria.type !== 'always';
                if (state.popupUi.filter === 'visible') return isVisible;
                if (state.popupUi.filter === 'hidden') return !isVisible;
                if (state.popupUi.filter === 'conditional') return hasCondition;
                return true;
            });

            const container = document.getElementById('popupFieldList');
            if (!container) return;

            container.innerHTML = fields.map(field => {
                const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id);
                const isVisible = !rule || rule.visibility !== 'hide';
                const hasCondition = rule?.criteria?.type && rule.criteria.type !== 'always';
                return `
                    <div class="popup-field-card" draggable="true" data-field-id="${field.id}">
                        <div class="drag-handle">‚ãÆ‚ãÆ</div>
                        <div class="popup-field-meta">
                            <div class="popup-field-name">
                                ${field.name}
                                ${hasCondition ? '<span class="popup-badge warn">Conditional</span>' : ''}
                                ${!isVisible ? '<span class="popup-badge warn">Hidden</span>' : ''}
                            </div>
                            <div class="popup-field-type field-type">${field.type}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="popup-toggle ${isVisible ? 'active' : ''}" onclick="togglePopupFieldVisibility('${field.id}')"></div>
                            <button class="btn btn-secondary btn-sm" onclick="focusPopupCondition('${field.id}')">‚öôÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            const popupFieldCountBadge = document.getElementById('popupFieldCountBadge');
            if (popupFieldCountBadge) popupFieldCountBadge.textContent = fields.length;
            attachPopupFieldDragHandlers();
        }

        function attachPopupFieldDragHandlers() {
            document.querySelectorAll('.popup-field-card').forEach(card => {
                card.addEventListener('dragstart', handlePopupFieldDragStart);
                card.addEventListener('dragover', handlePopupFieldDragOver);
                card.addEventListener('drop', handlePopupFieldDrop);
                card.addEventListener('dragend', handlePopupFieldDragEnd);
            });
        }

        function handlePopupFieldDragStart(e) {
            state.popupDraggedField = e.currentTarget.dataset.fieldId;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handlePopupFieldDragOver(e) {
            e.preventDefault();
            const target = e.currentTarget;
            if (state.popupDraggedField && target.dataset.fieldId !== state.popupDraggedField) {
                target.classList.add('drag-over');
            }
        }

        function handlePopupFieldDrop(e) {
            e.preventDefault();
            const targetId = e.currentTarget.dataset.fieldId;
            if (state.popupDraggedField && targetId && targetId !== state.popupDraggedField) {
                updatePopupFieldOrder(state.popupDraggedField, targetId);
                logPopupEvent('reorder', { from: state.popupDraggedField, to: targetId });
            }
            document.querySelectorAll('.popup-field-card').forEach(el => el.classList.remove('drag-over'));
            state.popupDraggedField = null;
        }

        function handlePopupFieldDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.popup-field-card').forEach(el => el.classList.remove('drag-over'));
            state.popupDraggedField = null;
        }

        function updatePopupFieldOrder(draggedId, targetId) {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;

            const order = getPopupOrderedFields(set, view).map(f => f.id);
            const fromIndex = order.indexOf(draggedId);
            const toIndex = order.indexOf(targetId);
            if (fromIndex === -1 || toIndex === -1) return;

            order.splice(fromIndex, 1);
            order.splice(toIndex, 0, draggedId);
            view.popupFieldOrder = order;
            renderPopupConfigurator();
        }

        function renderPopupStats() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            view.popupVisibilityRules = view.popupVisibilityRules || [];
            const fields = getPopupOrderedFields(set, view);
            const visibleCount = fields.reduce((count, field) => {
                const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id);
                return count + ((rule && rule.visibility === 'hide') ? 0 : 1);
            }, 0);
            const conditionalCount = view.popupVisibilityRules.filter(r => r.criteria?.type && r.criteria.type !== 'always').length;
            const popupVisibleCount = document.getElementById('popupVisibleCount');
            const popupConditionalCount = document.getElementById('popupConditionalCount');
            if (popupVisibleCount) popupVisibleCount.textContent = visibleCount;
            if (popupConditionalCount) popupConditionalCount.textContent = conditionalCount;
        }

        function renderPopupPreview() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            const layout = getPopupLayout(view);
            const preview = document.getElementById('popupPreview');
            if (!preview) return;

            const record = Array.from(set.records.values())[0] || {};
            const fields = getPopupOrderedFields(set, view).filter(field => shouldDisplayFieldInPopup(field, record)).slice(0, 9);

            preview.innerHTML = `
                <div class="popup-preview-header">
                    <span>Record Preview</span>
                    <span class="popup-pill">${layout.size} ¬∑ ${layout.columns} columns</span>
                </div>
                <div class="popup-preview-fields cols-${layout.columns}">
                    ${fields.map(field => `
                        <div class="popup-preview-field">
                            <div class="label">${field.name}</div>
                            <div class="value">${record[field.id] ?? '‚Äî'}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPopupLayoutOptions() {
            const view = getCurrentView();
            if (!view) return;
            const layout = getPopupLayout(view);

            const sizeOptions = [
                { id: 'small', label: 'Small', desc: 'Compact width' },
                { id: 'medium', label: 'Medium', desc: 'Balanced width' },
                { id: 'large', label: 'Large', desc: 'Full dialog' }
            ];
            const sizeContainer = document.getElementById('popupSizeOptions');
            if (sizeContainer) {
                sizeContainer.innerHTML = sizeOptions.map(opt => `
                    <div class="popup-layout-option ${layout.size === opt.id ? 'active' : ''}" onclick="updatePopupSize('${opt.id}')">
                        <div class="font-semibold">${opt.label}</div>
                        <div class="text-sm text-gray-600">${opt.desc}</div>
                    </div>
                `).join('');
            }

            const columnContainer = document.getElementById('popupColumnOptions');
            if (columnContainer) {
                columnContainer.innerHTML = [1, 2, 3].map(cols => `
                    <div class="popup-layout-option ${layout.columns === cols ? 'active' : ''}" onclick="updatePopupColumns(${cols})">
                        <div class="font-semibold">${cols} Column${cols > 1 ? 's' : ''}</div>
                        <div class="text-sm text-gray-600">${cols === 1 ? 'Single stack' : cols === 2 ? 'Split view' : 'Dense grid'}</div>
                    </div>
                `).join('');
            }
        }

        function updatePopupSize(size) {
            const view = getCurrentView();
            if (!view) return;
            const layout = getPopupLayout(view);
            layout.size = size;
            logPopupEvent('size', { size });
            renderPopupConfigurator();
        }

        function updatePopupColumns(columns) {
            const view = getCurrentView();
            if (!view) return;
            const layout = getPopupLayout(view);
            layout.columns = columns;
            logPopupEvent('columns', { columns });
            renderPopupConfigurator();
        }

        function renderPopupConditions() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            view.popupVisibilityRules = view.popupVisibilityRules || [];
            const container = document.getElementById('popupConditionsList');
            if (!container) return;

            const fields = getPopupOrderedFields(set, view);
            container.innerHTML = fields.map(field => {
                const rule = view.popupVisibilityRules.find(r => r.fieldId === field.id) || { visibility: 'show', criteria: { type: 'always', value: '' } };
                const criteriaType = rule.criteria?.type || 'always';
                const needsValue = ['equals', 'notEquals', 'contains'].includes(criteriaType);
                return `
                    <div class="popup-condition-card" data-condition-field="${field.id}">
                        <div class="popup-condition-title">${field.name} <span class="popup-pill">${rule.visibility === 'hide' ? 'Hidden' : 'Shown'}</span></div>
                        <div class="popup-condition-row">
                            <label class="text-sm text-gray-600 flex items-center gap-2">Visibility
                                <select class="border rounded px-2 py-2 text-sm" onchange="updatePopupVisibilityRule('${field.id}', this.value)">
                                    <option value="show" ${rule.visibility !== 'hide' ? 'selected' : ''}>Show</option>
                                    <option value="hide" ${rule.visibility === 'hide' ? 'selected' : ''}>Hide</option>
                                </select>
                            </label>
                            <label class="text-sm text-gray-600 flex items-center gap-2">Criteria
                                <select class="border rounded px-2 py-2 text-sm" onchange="updatePopupCriteriaType('${field.id}', this.value)">
                                    <option value="always" ${criteriaType === 'always' ? 'selected' : ''}>Always</option>
                                    <option value="equals" ${criteriaType === 'equals' ? 'selected' : ''}>Value equals</option>
                                    <option value="notEquals" ${criteriaType === 'notEquals' ? 'selected' : ''}>Value not equal</option>
                                    <option value="contains" ${criteriaType === 'contains' ? 'selected' : ''}>Value contains</option>
                                    <option value="empty" ${criteriaType === 'empty' ? 'selected' : ''}>When empty</option>
                                    <option value="notEmpty" ${criteriaType === 'notEmpty' ? 'selected' : ''}>When not empty</option>
                                </select>
                            </label>
                            <input class="border rounded px-3 py-2 text-sm ${needsValue ? '' : 'opacity-50'}" placeholder="Criteria value" value="${rule.criteria?.value || ''}" ${needsValue ? '' : 'disabled'} oninput="updatePopupCriteriaValue('${field.id}', this.value)">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPopupEvents() {
            const container = document.getElementById('popupEventStream');
            if (!container) return;
            if (state.popupEventStream.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-600">No recent configuration changes yet.</p>';
                return;
            }
            container.innerHTML = state.popupEventStream.map(evt => `
                <div class="popup-event">
                    <div class="popup-event-header">
                        <span>${evt.type}</span>
                        <span class="popup-event-time">${new Date(evt.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="text-sm text-gray-600">${describePopupEvent(evt)}</div>
                </div>
            `).join('');
        }

        function describePopupEvent(event) {
            const name = event.data?.fieldId ? getFieldNameById(event.data.fieldId) : '';
            switch (event.action) {
                case 'visibility':
                    return `${name || 'Field'} set to ${event.data.visibility}`;
                case 'criteriaType':
                    return `${name || 'Field'} criteria: ${event.data.type}`;
                case 'criteriaValue':
                    return `${name || 'Field'} criteria value updated`;
                case 'reorder':
                    return `Reordered fields (${event.data.from} ‚Üí ${event.data.to})`;
                case 'size':
                    return `Popup size changed to ${event.data.size}`;
                case 'columns':
                    return `Layout updated to ${event.data.columns} columns`;
                case 'template':
                    return `Applied ${event.data.template} template`;
                default:
                    return event.type;
            }
        }

        function renderPopupRecentChanges() {
            const container = document.getElementById('popupRecentChanges');
            if (!container) return;
            const items = state.popupEventStream.slice(0, 4);
            container.innerHTML = items.length === 0
                ? '<p class="text-sm text-gray-500">No changes yet.</p>'
                : items.map(evt => `<div>‚Ä¢ ${describePopupEvent(evt)}</div>`).join('');
        }

        function logPopupEvent(action, data = {}) {
            const entry = { id: Date.now(), action, data, type: action, timestamp: new Date().toISOString() };
            state.popupEventStream.unshift(entry);
            state.popupEventStream = state.popupEventStream.slice(0, 25);
            renderPopupEvents();
            renderPopupRecentChanges();
        }

        function resetPopupLayout() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            view.popupLayout = { size: 'medium', columns: 2 };
            view.popupFieldOrder = set.schema.map(f => f.id);
            view.popupVisibilityRules = [];
            logPopupEvent('reset', {});
            renderPopupConfigurator();
            refreshOpenRecordModal();
        }

        function applyPopupTemplate(template) {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            const ordered = getPopupOrderedFields(set, view);
            const layout = getPopupLayout(view);

            if (template === 'minimal') {
                layout.size = 'small';
                layout.columns = 1;
                view.popupVisibilityRules = ordered.map((field, idx) => ({ fieldId: field.id, visibility: idx < 4 ? 'show' : 'hide', criteria: { type: 'always', value: '' } }));
            } else if (template === 'detailed') {
                layout.size = 'large';
                layout.columns = 3;
                view.popupVisibilityRules = ordered.map(field => ({ fieldId: field.id, visibility: 'show', criteria: { type: 'always', value: '' } }));
            } else if (template === 'compact') {
                layout.size = 'medium';
                layout.columns = 2;
                view.popupVisibilityRules = ordered.map((field, idx) => ({ fieldId: field.id, visibility: idx < 6 ? 'show' : 'hide', criteria: { type: 'always', value: '' } }));
            }
            logPopupEvent('template', { template });
            renderPopupConfigurator();
            refreshOpenRecordModal();
        }

        function focusPopupCondition(fieldId) {
            setPopupTab('popupConditions');
            requestAnimationFrame(() => {
                const el = document.querySelector(`[data-condition-field="${fieldId}"]`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }

        function getFieldNameById(fieldId) {
            const set = getCurrentSet();
            return set?.schema.find(f => f.id === fieldId)?.name || fieldId;
        }

        function renderPopupConfigurator() {
            const activeTab = state.popupUi?.activeTab || 'popupFields';
            document.querySelectorAll('.popup-config-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === activeTab);
            });
            document.querySelectorAll('.popup-tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === activeTab);
            });
            renderPopupFilters();
            renderPopupFieldList();
            renderPopupStats();
            renderPopupLayoutOptions();
            renderPopupPreview();
            renderPopupConditions();
            renderPopupEvents();
            renderPopupRecentChanges();
        }

        // CONTEXT MENUS
        function showColumnMenu(e, field) {
            showContextMenu(e, [
                { label: 'Hide Field', action: () => hideField(field.id) },
                { label: 'Delete Field', action: () => confirmDelete('field', field.id), danger: true }
            ]);
        }

        function showCellMenu(e, recordId, field) {
            showContextMenu(e, [
                { label: 'Open Cell History', action: () => openCellHistory(recordId, field.id) }
            ]);
        }

        function showContextMenu(e, items) {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.innerHTML = items.map(item => `<div class="context-menu-item ${item.danger ? 'danger' : ''}">${item.label}</div>`).join('');
            menu.querySelectorAll('.context-menu-item').forEach((el, i) => {
                el.onclick = () => { items[i].action(); menu.remove(); };
            });
            document.body.appendChild(menu);
            setTimeout(() => {
                document.addEventListener('click', function close() { menu.remove(); document.removeEventListener('click', close); });
            }, 0);
        }

        function confirmDelete(type, id) {
            const messages = {
                field: 'Delete this field? This will remove data from all records.',
                record: 'Delete this record? This cannot be undone.'
            };
            showConfirm(messages[type], () => {
                if (type === 'field') deleteField(id);
                if (type === 'record') deleteRecord(id);
            });
        }

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            state.confirmCallback = callback;
            openModal('confirmModal');
        }

        function registerInterpretationRule(rule, options = {}) {
            const normalizedRule = {
                rule_id: rule.rule_id || `rule_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                applies_to_op: rule.applies_to_op || null,
                description: rule.description || '',
                effect: rule.effect || 'none',
                frame: rule.frame || 'system',
                scale: rule.scale || 'system'
            };

            state.interpretationRules.push(normalizedRule);

            if (!options.skipEvent) {
                createEvent(
                    'Define Rule',
                    'REC',
                    { type: 'InterpretationRule', id: normalizedRule.rule_id },
                    { rule: normalizedRule, summary: normalizedRule.description },
                    { frame: normalizedRule.frame, scale: normalizedRule.scale }
                );
            }

            return normalizedRule;
        }

        function hideField(fieldId) {
            const view = getCurrentView();
            if (!view.hiddenFields.includes(fieldId)) view.hiddenFields.push(fieldId);
            renderCurrentView();
            showToast('‚úì Field hidden');
        }

        function deleteField(fieldId) {
            const set = getCurrentSet();
            const fieldIndex = set.schema.findIndex(f => f.id === fieldId);
            if (fieldIndex === -1) return;
            const [field] = set.schema.splice(fieldIndex, 1);
            set.records.forEach(record => delete record[fieldId]);
            createEvent(
                'Delete Field',
                'NUL',
                { type: 'Field', id: fieldId, setId: set.id },
                { setId: set.id, fieldId, fieldName: field?.name, summary: `Deleted field ${field?.name || fieldId}` },
                { frame: 'schema', scale: 'collection' }
            );
            renderCurrentView();
            showToast('‚úì Field deleted');
        }

        function deleteRecord(recordId) {
            const set = getCurrentSet();
            set.records.delete(recordId);
            createEvent(
                'Delete Record',
                'NUL',
                { type: 'Record', id: recordId, setId: set.id },
                { setId: set.id, recordId, summary: 'Record deleted' }
            );
            renderCurrentView();
            showToast('‚úì Record deleted');
        }

        // UTILITIES
        function applyInterpretationRules(event) {
            const appliedRules = [];

            state.interpretationRules.forEach(rule => {
                if (rule.applies_to_op && rule.applies_to_op !== event.op) return;

                switch (rule.effect) {
                    case 'require_actor':
                        if (!event.actor || !event.actor.id) throw new Error('Events require an actor');
                        appliedRules.push(rule.rule_id);
                        break;
                    case 'require_object_id':
                        if (!event.object || !event.object.id) throw new Error('Operations require an object reference with an id');
                        appliedRules.push(rule.rule_id);
                        break;
                    case 'require_connection_endpoints':
                        if (!event.data?.sourceId || !event.data?.targetId) throw new Error('Connections require both sourceId and targetId');
                        appliedRules.push(rule.rule_id);
                        break;
                    case 'mark_deleted':
                        event.data = { ...event.data, deleted: true };
                        appliedRules.push(rule.rule_id);
                        break;
                    default:
                        break;
                }
            });

            return { ...event, appliedRules };
        }

        function createEvent(verb, op, object, data = {}, options = {}) {
            if (!state.operatorSet[op]) {
                throw new Error(`Invalid operator ${op}. Expected one of ${Object.keys(state.operatorSet).join(', ')}`);
            }

            const eventData = { ...data };

            if (options.summary && !eventData.summary) {
                eventData.summary = options.summary;
            }

            const event = {
                id: `event-${state.eventIdCounter++}`,
                verb: verb,
                op: op,
                frame: options.frame || 'ui',
                scale: options.scale || 'object',
                published: new Date().toISOString(),
                actor: { type: state.currentUser.type, id: state.currentUser.id },
                object: object,
                data: eventData
            };

            const interpretedEvent = applyInterpretationRules(event);
            state.eventStream.unshift(interpretedEvent);
            return interpretedEvent;
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function closeAllContextMenus() {
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());
        }

        function closeAllModals(exceptId = null) {
            const remaining = [];
            state.modalStack.forEach(id => {
                if (id === exceptId) {
                    remaining.push(id);
                    return;
                }

                const modalEl = document.getElementById(id);
                if (modalEl) modalEl.classList.add('hidden');
            });
            state.modalStack = remaining;
        }

        function openModal(modalId) {
            closeAllContextMenus();
            closeAllModals(modalId);

            const modal = document.getElementById(modalId);
            if (!modal) return;

            modal.classList.remove('hidden');
            if (!state.modalStack.includes(modalId)) {
                state.modalStack.push(modalId);
            }
        }

        function closeModal(modalId) {
            closeAllContextMenus();
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
            state.modalStack = state.modalStack.filter(id => id !== modalId);
        }

        function exportJSON() {
            const data = {
                sets: Array.from(state.sets.values()).map(s => ({
                    ...s,
                    records: Array.from(s.records.values()),
                    views: Array.from(s.views.values()),
                    profiles: Array.from(s.profiles.values())
                })),
                connections: Array.from(state.connections.values()),
                eventStream: state.eventStream
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workbase-export.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('‚úì Exported data');
        }

        function renderHistory() {
            const container = document.getElementById('historyContent');
            container.innerHTML = state.eventStream.map(e => `
                <div class="history-entry">
                    <div class="font-medium">${e.verb} <span class="text-xs text-gray-500">(${e.op})</span></div>
                    <div class="text-sm text-gray-500">${getTimeAgo(e.published)} ‚Ä¢ Frame: ${e.frame} ‚Ä¢ Scale: ${e.scale}</div>
                    <div class="text-sm">${e.data?.summary || e.verb}</div>
                    ${e.appliedRules?.length ? `<div class="text-xs text-gray-400">Rules: ${e.appliedRules.join(', ')}</div>` : ''}
                </div>
            `).join('');
        }

        // EVENT LISTENERS
        function setupEventListeners() {
            document.getElementById('addRecordBtn').onclick = () => {
                const set = getCurrentSet();
                const record = { id: `rec_${Date.now()}` };
                set.schema.forEach(f => record[f.id] = FIELD_TYPES[f.type].defaultValue);
                set.records.set(record.id, record);
                renderCurrentView();
                showToast('‚úì Record added');
            };
            document.getElementById('addFieldBtn').onclick = openAddFieldModal;
            document.getElementById('filterBtn').onclick = openFilterModal;
            document.getElementById('sortBtn').onclick = openSortModal;
            document.getElementById('popupSettingsBtn').onclick = openPopupSettingsModal;
            document.getElementById('historyBtn').onclick = () => {
                document.getElementById('historyPanel').classList.add('open');
                renderHistory();
            };
            document.getElementById('viewJsonBtn').onclick = openJsonViewer;
            document.getElementById('exportBtn').onclick = exportJSON;
            document.getElementById('closeHistoryBtn').onclick = () => document.getElementById('historyPanel').classList.remove('open');
            document.getElementById('toggleHistorySidebarBtn').onclick = toggleRecordHistoryVisibility;
            document.getElementById('closeExpandedRecordBtn').onclick = () => closeModal('expandedRecordModal');
            document.getElementById('openSetIconPickerBtn').onclick = () => openIconPicker('newSetIcon');
            document.getElementById('openViewIconPickerBtn').onclick = () => openIconPicker('newViewIcon');
            document.getElementById('closeIconPickerBtn').onclick = () => closeModal('iconPickerModal');
            document.getElementById('iconPickerSearch').oninput = (event) => {
                state.iconPickerQuery = event.target.value;
                renderIconPickerOptions();
            };
            document.getElementById('closeFilterBtn').onclick = () => closeModal('filterModal');
            document.getElementById('closePopupSettingsBtn').onclick = () => closeModal('popupSettingsModal');
            document.getElementById('applyFiltersBtn').onclick = applyFilters;
            document.getElementById('clearFiltersBtn').onclick = clearFilters;
            document.getElementById('addFilterGroupBtn').onclick = addFilterGroup;
            document.getElementById('confirmCancelBtn').onclick = () => {
                state.confirmCallback = null;
                closeModal('confirmModal');
            };
            document.getElementById('confirmOkBtn').onclick = () => {
                if (state.confirmCallback) state.confirmCallback();
                state.confirmCallback = null;
                closeModal('confirmModal');
            };
            document.getElementById('addSortRuleBtn').onclick = addSortRule;
            document.getElementById('clearSortsBtn').onclick = clearSorts;
            document.getElementById('applySortsBtn').onclick = applySortsFromModal;
            document.getElementById('closeSortBtn').onclick = () => closeModal('sortModal');
            document.getElementById('saveAddFieldBtn').onclick = saveField;
            document.getElementById('cancelAddFieldBtn').onclick = () => closeModal('addFieldModal');
            document.getElementById('closeAddFieldBtn').onclick = () => closeModal('addFieldModal');
            document.getElementById('saveAddSetBtn').onclick = () => {
                const name = document.getElementById('newSetName').value.trim();
                const icon = extractIconToken(document.getElementById('newSetIcon').value.trim() || 'ph-squares-four');
                if (!name) { showConfirm('Please enter a set name', () => {}); return; }
                if (state.setEditorContext?.setId) {
                    const set = state.sets.get(state.setEditorContext.setId);
                    set.name = name;
                    set.icon = icon;
                    closeModal('addSetModal');
                    state.setEditorContext = null;
                    renderSidebar();
                    renderCurrentView();
                    showToast('‚úì Set updated');
                } else {
                    const setId = createSet(name, icon);
                    closeModal('addSetModal');
                    document.getElementById('newSetName').value = '';
                    document.getElementById('newSetIcon').value = '';
                    createView(setId, 'All ' + name, { type: 'grid' });
                    state.expandedSets.add(setId);
                    renderSidebar();
                    switchSet(setId, null);
                    showToast('‚úì Set created');
                }
            };
            document.getElementById('cancelAddSetBtn').onclick = () => { state.setEditorContext = null; closeModal('addSetModal'); };
            document.getElementById('saveAddViewBtn').onclick = () => {
                const name = document.getElementById('newViewName').value.trim();
                const icon = extractIconToken(document.getElementById('newViewIcon').value.trim() || 'ph-table');
                const parentId = document.getElementById('newViewParent').value || null;
                if (!name) { showConfirm('Please enter a view name', () => {}); return; }
                const set = state.sets.get(state.viewEditorContext?.setId || state.currentSetId);
                const setId = set?.id;
                if (!setId) return;
                if (state.viewEditorContext?.viewId && parentId && isViewDescendant(set, parentId, state.viewEditorContext.viewId)) {
                    showConfirm('You cannot nest a view under its own descendant.', () => {});
                    return;
                }

                if (state.viewEditorContext?.viewId) {
                    const view = set.views.get(state.viewEditorContext.viewId);
                    if (view) {
                        view.name = name;
                        view.icon = icon;
                        view.parentId = parentId;
                    }
                    closeModal('addViewModal');
                    state.viewEditorContext = null;
                    renderSidebar();
                    switchSet(setId, view?.id || state.currentViewId);
                    showToast('‚úì View updated');
                } else {
                    const viewId = createView(setId, name, { type: 'grid', icon, parentId });
                    closeModal('addViewModal');
                    document.getElementById('newViewName').value = '';
                    document.getElementById('newViewIcon').value = '';
                    state.viewEditorContext = null;
                    renderSidebar();
                    switchSet(setId, viewId);
                    showToast('‚úì View created');
                }
            };
            document.getElementById('cancelAddViewBtn').onclick = () => { state.viewEditorContext = null; closeModal('addViewModal'); };
            document.getElementById('saveKanbanConfigBtn').onclick = saveKanbanConfig;
            document.getElementById('cancelKanbanConfigBtn').onclick = () => closeModal('kanbanConfigModal');
            document.getElementById('closeJsonViewerBtn').onclick = () => closeModal('jsonViewerModal');
            document.getElementById('copyJsonBtn').onclick = copyJsonToClipboard;
        }

        // JSON VIEWER
        let currentJsonTab = 'all';
        
        function openJsonViewer() {
            currentJsonTab = 'all';
            renderJsonContent();
            openModal('jsonViewerModal');
        }
        
        function switchJsonTab(tab) {
            currentJsonTab = tab;
            document.querySelectorAll('.json-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.json-tab[data-tab="${tab}"]`).classList.add('active');
            renderJsonContent();
        }
        
        function renderJsonContent() {
            let data;
            
            switch(currentJsonTab) {
                case 'all':
                    data = {
                        sets: Array.from(state.sets.values()).map(s => ({
                            ...s,
                            records: Array.from(s.records.values()),
                            views: Array.from(s.views.values()),
                            profiles: Array.from(s.profiles.values())
                        })),
                        connections: Array.from(state.connections.values()),
                        eventStream: state.eventStream,
                        operatorSet: state.operatorSet,
                        interpretationRules: state.interpretationRules,
                        currentSetId: state.currentSetId,
                        currentViewId: state.currentViewId
                    };
                    break;
                case 'sets':
                    data = Array.from(state.sets.values()).map(s => ({
                        id: s.id,
                        name: s.name,
                        icon: s.icon,
                        schema: s.schema,
                        recordCount: s.records.size,
                        viewCount: s.views.size,
                        records: Array.from(s.records.values()),
                        views: Array.from(s.views.values())
                    }));
                    break;
                case 'current':
                    const set = getCurrentSet();
                    const setRecordIds = set ? new Set(Array.from(set.records.keys())) : new Set();
                    data = set ? {
                        id: set.id,
                        name: set.name,
                        icon: set.icon,
                        schema: set.schema,
                        records: Array.from(set.records.values()),
                        views: Array.from(set.views.values()),
                        profiles: Array.from(set.profiles.values()),
                        connections: Array.from(state.connections.values()).filter(edge => setRecordIds.has(edge.sourceId) || setRecordIds.has(edge.targetId))
                    } : null;
                    break;
                case 'events':
                    data = state.eventStream;
                    break;
            }
            
            const jsonString = JSON.stringify(data, null, 2);
            const highlighted = syntaxHighlight(jsonString);
            document.getElementById('jsonContent').innerHTML = highlighted;
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function copyJsonToClipboard() {
            const content = document.getElementById('jsonContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyJsonBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }, 2000);
            }).catch(err => {
                showToast('‚ö†Ô∏è Failed to copy');
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const openMenus = document.querySelectorAll('.context-menu');
                    if (openMenus.length) {
                        openMenus.forEach(menu => menu.remove());
                        return;
                    }

                    if (state.modalStack.length > 0) {
                        closeModal(state.modalStack[state.modalStack.length - 1]);
                    }
                }
            });
        }

        function openAddSetModal(setId = null) {
            const titleEl = document.getElementById('addSetModalTitle');
            const saveBtn = document.getElementById('saveAddSetBtn');
            const nameInput = document.getElementById('newSetName');
            const iconInput = document.getElementById('newSetIcon');

            if (setId) {
                const set = state.sets.get(setId);
                state.setEditorContext = { setId };
                if (titleEl) titleEl.textContent = 'Edit Set';
                if (saveBtn) saveBtn.textContent = 'Save';
                if (nameInput) nameInput.value = set?.name || '';
                if (iconInput) iconInput.value = extractIconToken(set?.icon || 'ph-squares-four');
            } else {
                state.setEditorContext = null;
                if (titleEl) titleEl.textContent = 'Create Set';
                if (saveBtn) saveBtn.textContent = 'Create';
                if (nameInput) nameInput.value = '';
                if (iconInput) iconInput.value = '';
            }

            openModal('addSetModal');
        }

        // INITIALIZE
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
