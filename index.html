<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityStream Spreadsheet with Field Types</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-view {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .cell-editable {
            min-height: 20px;
            padding: 4px 8px;
            cursor: text;
            border: 1px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .cell-editable:hover {
            background-color: #f3f4f6;
            border-color: #e5e7eb;
        }
        .cell-editable:focus {
            outline: none;
            background-color: #fff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .cell-editing {
            background-color: #fffbeb;
            border-color: #fbbf24;
        }
        .cell-recently-changed {
            animation: flash-yellow 0.5s ease-out;
        }
        @keyframes flash-yellow {
            0% { background-color: #fef3c7; }
            100% { background-color: transparent; }
        }
        .view-toggle {
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle:hover {
            transform: scale(1.05);
        }
        .view-active {
            background-color: #3b82f6;
            color: white;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-green { background-color: #d1fae5; color: #065f46; }
        .badge-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-purple { background-color: #e9d5ff; color: #6b21a8; }
        .badge-gray { background-color: #f3f4f6; color: #374151; }
        
        .column-header {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .column-header:hover {
            background-color: #f9fafb;
        }
        .type-icon {
            opacity: 0.6;
            margin-right: 4px;
        }
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
        }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        .dropdown-divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 4px 0;
        }
        
        /* Custom select styling */
        .custom-select {
            position: absolute;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 150px;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .custom-select-option:hover {
            background-color: #f3f4f6;
        }
        .custom-select-option.selected {
            background-color: #dbeafe;
        }
        
        /* Checkbox styling */
        .checkbox-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Date input styling */
        input[type="date"] {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            width: 100%;
        }
        
        /* Number input styling */
        input[type="number"] {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .cell-editable {
                min-width: 80px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 md:py-4">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center space-x-2 md:space-x-3 min-w-0">
                    <svg class="w-6 h-6 md:w-8 md:h-8 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <div class="min-w-0">
                        <h1 class="text-lg md:text-2xl font-bold truncate">ActivityStream Spreadsheet</h1>
                        <p class="text-xs md:text-sm opacity-90 hidden sm:block">With Airtable-style Field Types</p>
                    </div>
                </div>
                <div class="text-xs md:text-sm opacity-90 hidden lg:block">
                    <span class="font-semibold">Backend:</span> ActivityStreams JSON
                </div>
            </div>
        </div>
    </div>

    <!-- View Toggle & Stats -->
    <div class="max-w-7xl mx-auto px-4 py-3 md:py-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <div class="flex space-x-1 md:space-x-2 bg-white rounded-lg shadow p-1 w-full sm:w-auto overflow-x-auto">
                <button id="spreadsheetViewBtn" class="view-toggle view-active px-3 md:px-4 py-2 rounded-md font-medium text-sm md:text-base whitespace-nowrap flex-1 sm:flex-none">
                    <span class="hidden sm:inline">Spreadsheet View</span>
                    <span class="sm:hidden">Sheet</span>
                </button>
                <button id="eventsViewBtn" class="view-toggle px-3 md:px-4 py-2 rounded-md font-medium bg-gray-100 text-sm md:text-base whitespace-nowrap flex-1 sm:flex-none">
                    <span class="hidden sm:inline">Event Stream</span>
                    <span class="sm:hidden">Events</span>
                </button>
            </div>
            <div class="bg-white rounded-lg shadow px-3 md:px-4 py-2 text-sm flex items-center space-x-3 md:space-x-4 w-full sm:w-auto">
                <span class="text-gray-600">
                    Events: <span id="eventCount" class="font-bold text-indigo-600">0</span>
                </span>
                <span class="text-gray-600 hidden md:inline">
                    Last Edit: <span id="lastEdit" class="font-bold text-indigo-600">Never</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Spreadsheet View (Full) -->
        <div id="spreadsheetViewFull" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <h2 class="text-lg md:text-xl font-semibold text-gray-800">Housing Services Investigation Tracker</h2>
                <div class="flex space-x-2 w-full sm:w-auto">
                    <button id="addRowBtn" class="flex-1 sm:flex-none bg-indigo-600 text-white px-3 md:px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors text-sm md:text-base">
                        + Add Row
                    </button>
                </div>
            </div>
            <div class="overflow-auto">
                <table id="spreadsheetTable" class="min-w-full border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr id="headerRow">
                            <th class="border border-gray-300 px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase w-12">#</th>
                            <!-- Column headers will be inserted here -->
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-xs md:text-sm text-gray-500 space-y-2 bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                <p class="flex items-start space-x-2">
                    <span class="flex-shrink-0">ðŸ’¡</span>
                    <span><strong>Click any cell to edit.</strong> Field types determine how data is displayed and edited.</span>
                </p>
                <p class="flex items-start space-x-2">
                    <span class="flex-shrink-0">ðŸŽ¯</span>
                    <span><strong>Click column headers</strong> to change field types (Text, Select, Date, Currency, etc.)</span>
                </p>
                <p class="flex items-start space-x-2">
                    <span class="flex-shrink-0">âœ¨</span>
                    <span><strong>Try it:</strong> Click the "Status" header and change it to Single Select with color options!</span>
                </p>
            </div>
        </div>

        <!-- Event Stream View (Full) -->
        <div id="eventsViewFull" class="hidden bg-gray-900 text-green-400 rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">ActivityStream Event Log</h2>
                <div class="space-x-2">
                    <button id="copyEventsBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Copy JSON
                    </button>
                </div>
            </div>
            <div id="eventsContent" class="json-view overflow-auto max-h-[600px]"></div>
        </div>
    </div>

    <!-- Type Picker Modal -->
    <div id="typePickerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-semibold">Change Field Type</h3>
                    <p class="text-sm text-gray-600 mt-1">Column: <span id="typePickerColumn" class="font-semibold"></span></p>
                </div>
                <button id="closeTypePickerBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6" id="typePickerContent">
                <!-- Type options will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Type Config Modal -->
    <div id="typeConfigModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="bg-gray-50 border-b border-gray-200 p-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Configure Field</h3>
                <button id="closeTypeConfigBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6" id="typeConfigContent">
                <!-- Configuration form will be inserted here -->
            </div>
            <div class="bg-gray-50 border-t border-gray-200 p-4 flex justify-end space-x-2">
                <button id="cancelTypeConfigBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
                <button id="saveTypeConfigBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Field Type Definitions
        const FIELD_TYPES = {
            TEXT: {
                id: 'TEXT',
                name: 'Single Line Text',
                icon: 'ðŸ“',
                group: 'text',
                defaultValue: '',
                render: (value) => value || '',
                validate: (value) => typeof value === 'string',
                needsConfig: false
            },
            LONG_TEXT: {
                id: 'LONG_TEXT',
                name: 'Long Text',
                icon: 'ðŸ“„',
                group: 'text',
                defaultValue: '',
                render: (value) => value || '',
                validate: (value) => typeof value === 'string',
                needsConfig: false
            },
            NUMBER: {
                id: 'NUMBER',
                name: 'Number',
                icon: '#ï¸âƒ£',
                group: 'number',
                defaultValue: 0,
                render: (value) => value !== '' && value !== null ? Number(value).toLocaleString() : '',
                validate: (value) => value === '' || !isNaN(value),
                needsConfig: false
            },
            CURRENCY: {
                id: 'CURRENCY',
                name: 'Currency',
                icon: 'ðŸ’°',
                group: 'number',
                defaultValue: 0,
                render: (value, config = {}) => {
                    if (value === '' || value === null) return '';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: config.currency || 'USD'
                    }).format(value);
                },
                validate: (value) => value === '' || !isNaN(value),
                needsConfig: false
            },
            SINGLE_SELECT: {
                id: 'SINGLE_SELECT',
                name: 'Single Select',
                icon: 'ðŸŽ¯',
                group: 'select',
                defaultValue: '',
                render: (value, config = {}) => {
                    if (!value) return '';
                    const color = (config.colors && config.colors[value]) || 'gray';
                    return `<span class="badge badge-${color}">${value}</span>`;
                },
                validate: (value, config = {}) => {
                    if (!value) return true;
                    return !config.options || config.options.includes(value);
                },
                needsConfig: true,
                defaultConfig: {
                    options: ['Option 1', 'Option 2', 'Option 3'],
                    colors: {
                        'Option 1': 'blue',
                        'Option 2': 'green',
                        'Option 3': 'purple'
                    }
                }
            },
            CHECKBOX: {
                id: 'CHECKBOX',
                name: 'Checkbox',
                icon: 'â˜‘ï¸',
                group: 'select',
                defaultValue: false,
                render: (value) => value ? 'âœ…' : 'â¬œ',
                validate: (value) => typeof value === 'boolean',
                needsConfig: false
            },
            DATE: {
                id: 'DATE',
                name: 'Date',
                icon: 'ðŸ“…',
                group: 'date',
                defaultValue: '',
                render: (value) => {
                    if (!value) return '';
                    return new Date(value).toLocaleDateString();
                },
                validate: (value) => {
                    if (!value) return true;
                    return !isNaN(new Date(value).getTime());
                },
                needsConfig: false
            },
            EMAIL: {
                id: 'EMAIL',
                name: 'Email',
                icon: 'ðŸ“§',
                group: 'text',
                defaultValue: '',
                render: (value) => {
                    if (!value) return '';
                    return `<a href="mailto:${value}" class="text-blue-600 hover:underline">${value}</a>`;
                },
                validate: (value) => {
                    if (!value) return true;
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                },
                needsConfig: false
            },
            URL: {
                id: 'URL',
                name: 'URL',
                icon: 'ðŸ”—',
                group: 'text',
                defaultValue: '',
                render: (value) => {
                    if (!value) return '';
                    return `<a href="${value}" target="_blank" class="text-blue-600 hover:underline">ðŸ”— Link</a>`;
                },
                validate: (value) => {
                    if (!value) return true;
                    try {
                        new URL(value);
                        return true;
                    } catch {
                        return false;
                    }
                },
                needsConfig: false
            }
        };

        // Column definitions with types
        let columns = [
            { id: 'case_id', name: 'Case ID', type: 'TEXT', width: '100px' },
            { id: 'client_name', name: 'Client Name', type: 'TEXT', width: '150px' },
            { id: 'program', name: 'Program', type: 'TEXT', width: '200px' },
            { id: 'amount', name: 'Amount', type: 'CURRENCY', width: '120px', config: { currency: 'USD' } },
            { id: 'date_placed', name: 'Date Placed', type: 'DATE', width: '120px' },
            { id: 'promised_voucher', name: 'Promised Voucher', type: 'SINGLE_SELECT', width: '130px', config: {
                options: ['Yes', 'No'],
                colors: { 'Yes': 'green', 'No': 'red' }
            }},
            { id: 'voucher_issued', name: 'Voucher Issued', type: 'SINGLE_SELECT', width: '130px', config: {
                options: ['Yes', 'No', 'N/A'],
                colors: { 'Yes': 'green', 'No': 'red', 'N/A': 'gray' }
            }},
            { id: 'status', name: 'Status', type: 'SINGLE_SELECT', width: '150px', config: {
                options: ['Active', 'At Risk', 'Facing Eviction', 'Already Evicted', 'Stable'],
                colors: {
                    'Active': 'blue',
                    'At Risk': 'yellow',
                    'Facing Eviction': 'red',
                    'Already Evicted': 'red',
                    'Stable': 'green'
                }
            }},
            { id: 'notes', name: 'Notes', type: 'LONG_TEXT', width: '300px' }
        ];

        // Sample spreadsheet data
        let spreadsheetData = [
            {
                case_id: 'HS-001',
                client_name: 'Smith Family',
                program: 'Non-Traditional Rapid Rehousing',
                amount: 12500,
                date_placed: '2024-03-15',
                promised_voucher: 'Yes',
                voucher_issued: 'No',
                status: 'Facing Eviction',
                notes: 'Placed outside Coordinated Entry. Promised Section 8 never materialized.'
            },
            {
                case_id: 'HS-002',
                client_name: 'Johnson, Maria',
                program: 'Non-Traditional Rapid Rehousing',
                amount: 8200,
                date_placed: '2024-04-22',
                promised_voucher: 'Yes',
                voucher_issued: 'No',
                status: 'Already Evicted',
                notes: 'Evicted June 2024. No voucher received. Family now in shelter.'
            },
            {
                case_id: 'HS-003',
                client_name: 'Williams, Robert',
                program: 'Emergency Housing Fund',
                amount: 15000,
                date_placed: '2024-05-10',
                promised_voucher: 'No',
                voucher_issued: 'N/A',
                status: 'Stable',
                notes: 'Proper documentation. Coordinated Entry process followed.'
            },
            {
                case_id: 'HS-004',
                client_name: 'Davis Family',
                program: 'Non-Traditional Rapid Rehousing',
                amount: 11800,
                date_placed: '2024-06-05',
                promised_voucher: 'Yes',
                voucher_issued: 'No',
                status: 'At Risk',
                notes: 'Section 8 promised by Calvin. Still waiting. Rent assistance ending soon.'
            }
        ];

        // Event stream
        let eventStream = [];
        let eventIdCounter = 1;

        // Current actor
        const currentUser = {
            type: 'Person',
            id: '@michael:groundtruth.nashville',
            name: 'Michael Clem'
        };

        // State for type picker
        let typePickerState = {
            columnId: null,
            columnIndex: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpreadsheet();
            setupEventListeners();
            updateStats();
        });

        // Initialize spreadsheet
        function initializeSpreadsheet() {
            renderSpreadsheet();
            
            // Create initial creation events
            spreadsheetData.forEach((row, rowIndex) => {
                createEvent('Create', {
                    rowIndex: rowIndex,
                    rowData: row
                }, `Initial data import for row ${rowIndex + 1}`);
            });
            
            updateEventStream();
        }

        // Render spreadsheet
        function renderSpreadsheet() {
            const headerRow = document.getElementById('headerRow');
            const tbody = document.getElementById('spreadsheetBody');
            
            // Clear existing content
            headerRow.innerHTML = '<th class="border border-gray-300 px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase w-12">#</th>';
            tbody.innerHTML = '';

            // Render headers
            columns.forEach((col, colIndex) => {
                const th = document.createElement('th');
                th.className = 'border border-gray-300 px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase column-header';
                th.style.width = col.width;
                
                const fieldType = FIELD_TYPES[col.type];
                th.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="flex items-center">
                            <span class="type-icon">${fieldType.icon}</span>
                            ${col.name}
                        </span>
                        <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                `;
                
                th.onclick = (e) => {
                    e.stopPropagation();
                    openTypePicker(col.id, colIndex);
                };
                
                headerRow.appendChild(th);
            });

            // Render rows
            spreadsheetData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                // Row number
                const tdNum = document.createElement('td');
                tdNum.className = 'border border-gray-300 px-2 py-2 text-xs text-gray-500 text-center bg-gray-50';
                tdNum.textContent = rowIndex + 1;
                tr.appendChild(tdNum);

                // Data cells
                columns.forEach((col) => {
                    const td = document.createElement('td');
                    td.className = 'border border-gray-300 cell-editable';
                    td.dataset.rowIndex = rowIndex;
                    td.dataset.columnId = col.id;
                    td.dataset.columnType = col.type;
                    
                    renderCell(td, row[col.id], col);
                    
                    // Click handler based on type
                    td.onclick = (e) => handleCellClick(e, rowIndex, col, td);
                    
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // Render individual cell based on type
        function renderCell(td, value, column) {
            const fieldType = FIELD_TYPES[column.type];
            
            if (column.type === 'CHECKBOX') {
                td.innerHTML = `<div class="checkbox-cell">${fieldType.render(value)}</div>`;
                td.style.cursor = 'pointer';
            } else {
                td.innerHTML = fieldType.render(value, column.config);
            }
        }

        // Handle cell click based on type
        function handleCellClick(e, rowIndex, column, td) {
            const fieldType = FIELD_TYPES[column.type];
            const currentValue = spreadsheetData[rowIndex][column.id];
            
            if (column.type === 'CHECKBOX') {
                // Toggle checkbox
                const newValue = !currentValue;
                handleCellEdit(rowIndex, column.id, currentValue, newValue);
                return;
            }
            
            if (column.type === 'SINGLE_SELECT') {
                // Show dropdown
                showSelectDropdown(td, rowIndex, column, currentValue);
                return;
            }
            
            if (column.type === 'DATE') {
                // Show date picker
                showDatePicker(td, rowIndex, column, currentValue);
                return;
            }
            
            // For text/number types, make contentEditable
            if (['TEXT', 'LONG_TEXT', 'NUMBER', 'CURRENCY', 'EMAIL', 'URL'].includes(column.type)) {
                makeEditable(td, rowIndex, column, currentValue);
                return;
            }
        }

        // Make cell editable
        function makeEditable(td, rowIndex, column, currentValue) {
            const originalValue = currentValue;
            
            td.contentEditable = true;
            td.textContent = currentValue || '';
            td.focus();
            td.classList.add('cell-editing');
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(td);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            const finishEdit = () => {
                td.contentEditable = false;
                td.classList.remove('cell-editing');
                const newValue = td.textContent.trim();
                
                if (newValue !== originalValue) {
                    handleCellEdit(rowIndex, column.id, originalValue, newValue);
                } else {
                    renderCell(td, originalValue, column);
                }
            };
            
            td.onblur = finishEdit;
            td.onkeydown = (e) => {
                if (e.key === 'Enter' && column.type !== 'LONG_TEXT') {
                    e.preventDefault();
                    finishEdit();
                }
                if (e.key === 'Escape') {
                    td.textContent = originalValue || '';
                    finishEdit();
                }
            };
        }

        // Show select dropdown
        function showSelectDropdown(td, rowIndex, column, currentValue) {
            // Remove any existing dropdowns
            document.querySelectorAll('.custom-select').forEach(el => el.remove());
            
            const dropdown = document.createElement('div');
            dropdown.className = 'custom-select';
            
            const options = column.config?.options || [];
            options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-select-option';
                if (option === currentValue) {
                    optionEl.classList.add('selected');
                }
                
                const color = column.config?.colors?.[option] || 'gray';
                optionEl.innerHTML = `<span class="badge badge-${color}">${option}</span>`;
                
                optionEl.onclick = () => {
                    if (option !== currentValue) {
                        handleCellEdit(rowIndex, column.id, currentValue, option);
                    }
                    dropdown.remove();
                };
                
                dropdown.appendChild(optionEl);
            });
            
            // Position dropdown
            const rect = td.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = `${rect.bottom + 4}px`;
            dropdown.style.left = `${rect.left}px`;
            
            document.body.appendChild(dropdown);
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== td) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        // Show date picker
        function showDatePicker(td, rowIndex, column, currentValue) {
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentValue || '';
            input.className = 'w-full px-2 py-1 border-2 border-indigo-500 rounded';
            
            td.innerHTML = '';
            td.appendChild(input);
            input.focus();
            
            const finishEdit = () => {
                const newValue = input.value;
                if (newValue !== currentValue) {
                    handleCellEdit(rowIndex, column.id, currentValue, newValue);
                } else {
                    renderCell(td, currentValue, column);
                }
            };
            
            input.onblur = finishEdit;
            input.onchange = finishEdit;
        }

        // Handle cell edit
        function handleCellEdit(rowIndex, columnId, oldValue, newValue) {
            // Update data
            spreadsheetData[rowIndex][columnId] = newValue;

            // Get column info
            const column = columns.find(c => c.id === columnId);

            // Create ActivityStream event
            createEvent('Update', {
                rowIndex: rowIndex,
                columnId: columnId,
                columnName: column.name,
                columnType: column.type,
                oldValue: oldValue,
                newValue: newValue,
                caseId: spreadsheetData[rowIndex].case_id
            }, `Updated ${column.name} in row ${rowIndex + 1}`);

            // Re-render the spreadsheet
            renderSpreadsheet();
            updateEventStream();
            updateStats();
            
            // Flash the changed cell
            setTimeout(() => {
                const cell = document.querySelector(`[data-row-index="${rowIndex}"][data-column-id="${columnId}"]`);
                if (cell) {
                    cell.classList.add('cell-recently-changed');
                    setTimeout(() => cell.classList.remove('cell-recently-changed'), 500);
                }
            }, 0);
        }

        // Open type picker
        function openTypePicker(columnId, columnIndex) {
            const column = columns.find(c => c.id === columnId);
            typePickerState = { columnId, columnIndex };
            
            document.getElementById('typePickerColumn').textContent = column.name;
            
            const content = document.getElementById('typePickerContent');
            content.innerHTML = '';
            
            // Group types
            const groups = {
                text: { name: 'ðŸ“ Text Types', types: [] },
                number: { name: 'ðŸ”¢ Number Types', types: [] },
                select: { name: 'ðŸŽ¯ Selection Types', types: [] },
                date: { name: 'ðŸ“… Date Types', types: [] }
            };
            
            Object.values(FIELD_TYPES).forEach(type => {
                groups[type.group].types.push(type);
            });
            
            Object.values(groups).forEach(group => {
                if (group.types.length === 0) return;
                
                const groupEl = document.createElement('div');
                groupEl.className = 'mb-4';
                groupEl.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 mb-2">${group.name}</h4>`;
                
                const typesContainer = document.createElement('div');
                typesContainer.className = 'space-y-1';
                
                group.types.forEach(type => {
                    const typeEl = document.createElement('div');
                    typeEl.className = 'dropdown-item rounded';
                    if (type.id === column.type) {
                        typeEl.classList.add('bg-indigo-50');
                    }
                    typeEl.innerHTML = `
                        <span class="text-xl">${type.icon}</span>
                        <span class="flex-1">${type.name}</span>
                        ${type.id === column.type ? '<span class="text-indigo-600">âœ“</span>' : ''}
                    `;
                    
                    typeEl.onclick = () => {
                        if (type.needsConfig) {
                            showTypeConfig(type);
                        } else {
                            changeFieldType(columnId, type.id);
                        }
                    };
                    
                    typesContainer.appendChild(typeEl);
                });
                
                groupEl.appendChild(typesContainer);
                content.appendChild(groupEl);
            });
            
            document.getElementById('typePickerModal').classList.remove('hidden');
        }

        // Show type configuration
        function showTypeConfig(fieldType) {
            const column = columns.find(c => c.id === typePickerState.columnId);
            const config = column.config || fieldType.defaultConfig;
            
            const content = document.getElementById('typeConfigContent');
            
            if (fieldType.id === 'SINGLE_SELECT') {
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
                            <div id="optionsList" class="space-y-2">
                                ${(config.options || []).map((opt, i) => `
                                    <div class="flex items-center space-x-2">
                                        <input type="text" value="${opt}" class="flex-1 border border-gray-300 rounded px-3 py-2" data-option-index="${i}" />
                                        <select class="border border-gray-300 rounded px-3 py-2" data-color-index="${i}">
                                            <option value="blue" ${config.colors[opt] === 'blue' ? 'selected' : ''}>ðŸ”µ Blue</option>
                                            <option value="green" ${config.colors[opt] === 'green' ? 'selected' : ''}>ðŸŸ¢ Green</option>
                                            <option value="yellow" ${config.colors[opt] === 'yellow' ? 'selected' : ''}>ðŸŸ¡ Yellow</option>
                                            <option value="red" ${config.colors[opt] === 'red' ? 'selected' : ''}>ðŸ”´ Red</option>
                                            <option value="purple" ${config.colors[opt] === 'purple' ? 'selected' : ''}>ðŸŸ£ Purple</option>
                                            <option value="gray" ${config.colors[opt] === 'gray' ? 'selected' : ''}>âšª Gray</option>
                                        </select>
                                        <button class="text-red-600 hover:text-red-800 p-2" onclick="removeOption(${i})">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <button id="addOptionBtn" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                + Add Option
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('addOptionBtn').onclick = addOption;
            }
            
            document.getElementById('typeConfigModal').classList.remove('hidden');
            
            // Save handler
            document.getElementById('saveTypeConfigBtn').onclick = () => {
                const newConfig = extractConfig(fieldType);
                changeFieldType(typePickerState.columnId, fieldType.id, newConfig);
            };
        }

        // Add option to select config
        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const index = optionsList.children.length;
            const optionEl = document.createElement('div');
            optionEl.className = 'flex items-center space-x-2';
            optionEl.innerHTML = `
                <input type="text" value="Option ${index + 1}" class="flex-1 border border-gray-300 rounded px-3 py-2" data-option-index="${index}" />
                <select class="border border-gray-300 rounded px-3 py-2" data-color-index="${index}">
                    <option value="blue">ðŸ”µ Blue</option>
                    <option value="green">ðŸŸ¢ Green</option>
                    <option value="yellow">ðŸŸ¡ Yellow</option>
                    <option value="red">ðŸ”´ Red</option>
                    <option value="purple">ðŸŸ£ Purple</option>
                    <option value="gray" selected>âšª Gray</option>
                </select>
                <button class="text-red-600 hover:text-red-800 p-2" onclick="this.parentElement.remove()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;
            optionsList.appendChild(optionEl);
        }

        // Extract config from form
        function extractConfig(fieldType) {
            if (fieldType.id === 'SINGLE_SELECT') {
                const options = [];
                const colors = {};
                
                document.querySelectorAll('[data-option-index]').forEach(input => {
                    const value = input.value.trim();
                    if (value) {
                        options.push(value);
                        const colorSelect = document.querySelector(`[data-color-index="${input.dataset.optionIndex}"]`);
                        colors[value] = colorSelect.value;
                    }
                });
                
                return { options, colors };
            }
            
            return {};
        }

        // Change field type
        function changeFieldType(columnId, newType, newConfig = {}) {
            const columnIndex = columns.findIndex(c => c.id === columnId);
            const column = columns[columnIndex];
            const oldType = column.type;
            const oldConfig = column.config || {};
            
            // Update column definition
            column.type = newType;
            column.config = newConfig;
            
            // Create schema change event
            createEvent('FieldTypeChanged', {
                columnId: columnId,
                columnName: column.name,
                oldType: oldType,
                newType: newType,
                oldConfig: oldConfig,
                newConfig: newConfig,
                affectedRows: spreadsheetData.length
            }, `Changed '${column.name}' field type from ${FIELD_TYPES[oldType].name} to ${FIELD_TYPES[newType].name}`);
            
            // Close modals
            document.getElementById('typePickerModal').classList.add('hidden');
            document.getElementById('typeConfigModal').classList.add('hidden');
            
            // Re-render spreadsheet
            renderSpreadsheet();
            updateEventStream();
            updateStats();
            
            // Show notification
            showNotification(`âœ“ Changed ${column.name} to ${FIELD_TYPES[newType].name}`);
        }

        // Create ActivityStream event
        function createEvent(type, data, summary) {
            const event = {
                "@context": "https://www.w3.org/ns/activitystreams",
                "type": type,
                "id": `event-${String(eventIdCounter++).padStart(4, '0')}`,
                "published": new Date().toISOString(),
                "actor": currentUser,
                "object": data,
                "summary": summary
            };

            eventStream.unshift(event);
            return event;
        }

        // Update event stream display
        function updateEventStream() {
            const eventsContent = document.getElementById('eventsContent');
            
            const jsonString = JSON.stringify({
                "@context": "https://www.w3.org/ns/activitystreams",
                "type": "OrderedCollection",
                "totalItems": eventStream.length,
                "orderedItems": eventStream
            }, null, 2);
            
            eventsContent.innerHTML = syntaxHighlight(jsonString);
        }

        // Syntax highlighting
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'text-green-400';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'text-blue-400';
                    } else {
                        cls = 'text-yellow-300';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'text-purple-400';
                } else if (/null/.test(match)) {
                    cls = 'text-red-400';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Add new row
        function addNewRow() {
            const newRow = {};
            columns.forEach(col => {
                const fieldType = FIELD_TYPES[col.type];
                newRow[col.id] = fieldType.defaultValue;
            });
            
            spreadsheetData.push(newRow);
            const rowIndex = spreadsheetData.length - 1;
            
            createEvent('Create', {
                rowIndex: rowIndex,
                rowData: newRow
            }, `Added new row ${rowIndex + 1}`);
            
            renderSpreadsheet();
            updateEventStream();
            updateStats();
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.style.transition = 'opacity 0.3s ease-out';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Update stats
        function updateStats() {
            document.getElementById('eventCount').textContent = eventStream.length;
            if (eventStream.length > 0) {
                const lastEvent = eventStream[0];
                document.getElementById('lastEdit').textContent = new Date(lastEvent.published).toLocaleTimeString();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // View toggle
            document.getElementById('spreadsheetViewBtn').addEventListener('click', () => switchView('spreadsheet'));
            document.getElementById('eventsViewBtn').addEventListener('click', () => switchView('events'));

            // Add row
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);

            // Close modals
            document.getElementById('closeTypePickerBtn').addEventListener('click', () => {
                document.getElementById('typePickerModal').classList.add('hidden');
            });
            document.getElementById('closeTypeConfigBtn').addEventListener('click', () => {
                document.getElementById('typeConfigModal').classList.add('hidden');
            });
            document.getElementById('cancelTypeConfigBtn').addEventListener('click', () => {
                document.getElementById('typeConfigModal').classList.add('hidden');
            });

            // Export events
            document.getElementById('copyEventsBtn').addEventListener('click', () => {
                const json = JSON.stringify(eventStream, null, 2);
                navigator.clipboard.writeText(json).then(() => {
                    showNotification('âœ“ Events copied to clipboard!');
                });
            });
        }

        // Switch view
        function switchView(view) {
            document.querySelectorAll('.view-toggle').forEach(btn => {
                btn.classList.remove('view-active', 'bg-gray-100');
                btn.classList.add('bg-gray-100');
            });

            document.getElementById('spreadsheetViewFull').classList.add('hidden');
            document.getElementById('eventsViewFull').classList.add('hidden');

            if (view === 'spreadsheet') {
                document.getElementById('spreadsheetViewBtn').classList.add('view-active');
                document.getElementById('spreadsheetViewBtn').classList.remove('bg-gray-100');
                document.getElementById('spreadsheetViewFull').classList.remove('hidden');
            } else if (view === 'events') {
                document.getElementById('eventsViewBtn').classList.add('view-active');
                document.getElementById('eventsViewBtn').classList.remove('bg-gray-100');
                document.getElementById('eventsViewFull').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
