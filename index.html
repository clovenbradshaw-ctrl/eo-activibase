<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workbase - Activity-Sourced Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-900: #111827;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* ============================================================================
           CELL STYLES
           ============================================================================ */
        
        .cell-editable {
            min-height: 36px;
            padding: 12px 16px;
            cursor: text;
            border-right: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .cell-editable:hover {
            background: linear-gradient(to right, transparent, rgba(59, 130, 246, 0.03), transparent);
            border-left: 2px solid rgba(59, 130, 246, 0.2);
        }
        
        .cell-editable:focus {
            outline: none;
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            border-radius: 4px;
        }
        
        .cell-recently-changed {
            animation: flash-yellow 0.5s ease-out;
        }
        
        @keyframes flash-yellow {
            0% { background-color: #fef3c7; }
            100% { background-color: transparent; }
        }
        
        .cell-with-history::after {
            content: 'üìù';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .cell-with-history:hover::after {
            opacity: 0.5;
        }
        
        /* ============================================================================
           TABLE & HEADER STYLES
           ============================================================================ */
        
        .column-header {
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
            padding: 12px 16px;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #e8e8e8;
            cursor: pointer;
            transition: background 0.15s;
            user-select: none;
            position: relative;
        }
        
        .column-header:hover {
            background: linear-gradient(180deg, #f5f5f5 0%, #eeeeee 100%);
        }
        
        /* Field type color coding */
        .column-header[data-type="TEXT"] { border-top: 3px solid #3b82f6; }
        .column-header[data-type="NUMBER"] { border-top: 3px solid #10b981; }
        .column-header[data-type="CURRENCY"] { border-top: 3px solid #059669; }
        .column-header[data-type="DATE"] { border-top: 3px solid #ec4899; }
        .column-header[data-type="EMAIL"] { border-top: 3px solid #6366f1; }
        .column-header[data-type="URL"] { border-top: 3px solid #8b5cf6; }
        .column-header[data-type="SINGLE_SELECT"] { border-top: 3px solid #f59e0b; }
        .column-header[data-type="CHECKBOX"] { border-top: 3px solid #8b5cf6; }
        .column-header[data-type="LINK_TO_RECORD"] { border-top: 3px solid #06b6d4; }
        .column-header[data-type="LOOKUP"] { border-top: 3px solid #a855f7; }
        
        tr:hover {
            background-color: #fafafa;
        }
        
        tr:hover .row-number {
            background: #3b82f6;
            color: white;
            cursor: pointer;
        }
        
        .row-number {
            transition: all 0.2s ease;
        }
        
        /* ============================================================================
           CONTEXT MENU
           ============================================================================ */
        
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .context-menu-item:hover {
            background: #f3f4f6;
        }
        
        .context-menu-item.danger:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .context-menu-separator {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }
        
        /* ============================================================================
           MODAL SYSTEM - Airtable Style
           ============================================================================ */
        
        .modal-overlay {
            backdrop-filter: blur(2px);
            animation: fadeIn 0.2s ease;
        }
        
        .modal-container {
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
        }
        
        .config-section {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            margin-top: 0;
        }
        
        .config-section.visible {
            max-height: 500px;
            opacity: 1;
            margin-top: 16px;
        }
        
        /* ============================================================================
           BUTTONS
           ============================================================================ */
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* ============================================================================
           BADGES
           ============================================================================ */
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .badge-green { background-color: #d1fae5; color: #065f46; }
        .badge-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-purple { background-color: #e9d5ff; color: #6b21a8; }
        .badge-gray { background-color: #f3f4f6; color: #374151; }
        .badge-cyan { background-color: #cffafe; color: #155e75; }
        .badge-pink { background-color: #fce7f3; color: #9f1239; }
        
        /* ============================================================================
           SIDE PANELS
           ============================================================================ */
        
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 420px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .side-panel.open {
            transform: translateX(0);
        }
        
        /* ============================================================================
           RELATIONSHIP CARDS
           ============================================================================ */
        
        .relationship-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
        }
        
        .relationship-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        
        /* ============================================================================
           HISTORY ENTRIES
           ============================================================================ */
        
        .history-entry {
            border-left: 3px solid #e5e7eb;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.15s ease;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .history-entry:hover {
            border-left-color: #3b82f6;
            background-color: #f9fafb;
        }
        
        .history-entry.revert {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .value-change {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .value-old {
            color: #dc2626;
            text-decoration: line-through;
        }
        
        .value-new {
            color: #16a34a;
            font-weight: 600;
        }
        
        /* ============================================================================
           INPUT STYLING
           ============================================================================ */
        
        input[type="text"], input[type="number"], input[type="date"], 
        input[type="email"], input[type="url"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.15s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input::placeholder {
            color: #9ca3af;
        }
        
        /* Airtable-style select */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        /* Field type picker */
        .field-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .field-type-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
        }
        
        .field-type-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .field-type-option.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .field-type-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 6px;
            flex-shrink: 0;
        }
        
        .field-type-option.selected .field-type-icon {
            background: #3b82f6;
            color: white;
        }
        
        /* Tabs in expanded record */
        .record-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            gap: 0;
        }
        
        .record-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.15s ease;
        }
        
        .record-tab:hover {
            color: #374151;
            background: #f9fafb;
        }
        
        .record-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        /* Field type selector - styled like Airtable */
        .field-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .field-type-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: white;
        }
        
        .field-type-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .field-type-option.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .field-type-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .field-type-option.selected .field-type-icon {
            color: #2563eb;
        }
        
        /* Tabs for expanded record */
        .record-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            background: #fafafa;
        }
        
        .record-tab {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }
        
        .record-tab:hover {
            color: #374151;
        }
        
        .record-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        /* ============================================================================
           TABS
           ============================================================================ */
        
        .table-tab {
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
            border-bottom: none;
        }
        
        .table-tab:hover {
            background: #f9fafb;
        }
        
        .table-tab.active {
            background: white;
            border-color: #e5e7eb;
            border-bottom: 2px solid white;
            margin-bottom: -1px;
        }
        
        .view-tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid #e5e7eb;
            background: white;
            margin-right: 4px;
        }
        
        .view-tab:hover {
            background: #f9fafb;
        }
        
        .view-tab.active {
            background: #dbeafe;
            color: #1e40af;
            border-color: #93c5fd;
        }
        
        /* ============================================================================
           LINK PILLS
           ============================================================================ */
        
        .link-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .link-pill:hover {
            background: #bfdbfe;
            transform: translateY(-1px);
        }
        
        /* ============================================================================
           TOAST NOTIFICATIONS
           ============================================================================ */
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ============================================================================
           EMPTY STATES
           ============================================================================ */
        
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #9ca3af;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* ============================================================================
           FILTER BUILDER
           ============================================================================ */
        
        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .filter-row select, .filter-row input {
            flex: 1;
            padding: 6px 10px;
            font-size: 13px;
        }
        
        /* ============================================================================
           SCROLLBAR STYLING
           ============================================================================ */
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* ============================================================================
           LABEL STYLING
           ============================================================================ */
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }
        
        /* ============================================================================
           PROPERTY EDITOR
           ============================================================================ */
        
        .property-row {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .property-row input {
            padding: 6px 10px;
            font-size: 13px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Workbase</h1>
                        <p class="text-sm text-gray-500">Activity-Sourced Database</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="historyBtn" class="btn btn-secondary" aria-label="View history">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        History
                    </button>
                    <button id="addTableBtn" class="btn btn-secondary">+ New Table</button>
                    <button id="exportBtn" class="btn btn-secondary">Export JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Tabs -->
    <div class="max-w-7xl mx-auto px-6 pt-4">
        <div class="flex items-center gap-2 border-b border-gray-200" id="tableTabsContainer" role="tablist">
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-6">
        <!-- View Controls -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2" id="viewTabsContainer" role="tablist">
                    </div>
                    <button id="addViewBtn" class="text-sm text-blue-600 hover:text-blue-800">+ Add View</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="filterBtn" class="btn btn-secondary text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Filter
                    </button>
                    <button id="addRecordBtn" class="btn btn-primary">+ Add Record</button>
                    <button id="addFieldBtn" class="btn btn-secondary">+ Add Field</button>
                </div>
            </div>
        </div>

        <!-- Grid View -->
        <div id="gridView" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table id="dataTable" class="w-full border-collapse">
                    <thead>
                        <tr id="tableHeader">
                            <th class="column-header" style="width: 50px;">#</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div id="historyPanel" class="side-panel" role="complementary" aria-label="Edit history">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold">Edit History</h3>
                    <p class="text-sm opacity-90 mt-1">Full audit trail of all changes</p>
                </div>
                <button id="closeHistoryBtn" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition" aria-label="Close history">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-3">
                <input 
                    type="text" 
                    id="historySearch" 
                    class="w-full text-gray-900 rounded-lg"
                    placeholder="Search history..."
                    aria-label="Search history"
                >
                <select id="historyFilter" class="w-full text-gray-900 rounded-lg" aria-label="Filter history by type">
                    <option value="all">All Changes</option>
                    <option value="cell">Cell Edits</option>
                    <option value="record">Record Changes</option>
                    <option value="field">Field Changes</option>
                    <option value="relationship">Relationships</option>
                    <option value="view">View Changes</option>
                </select>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="historyContent"></div>
        <div class="border-t border-gray-200 p-4 flex-shrink-0 bg-gray-50">
            <div class="text-xs text-gray-600 flex justify-between">
                <span>Total Events: <strong id="historyTotal">0</strong></span>
                <span>Showing: <strong id="historyShown">0</strong></span>
            </div>
        </div>
    </div>

    <!-- Expanded Record Modal -->
    <div id="expandedRecordModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between flex-shrink-0">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900" id="expandedRecordTitle">Record Details</h2>
                    <p class="text-sm text-gray-500 mt-1">View and edit all fields</p>
                </div>
                <button id="closeExpandedRecordBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    <div class="md:col-span-2 p-6 overflow-y-auto border-r border-gray-200" id="expandedRecordMain">
                    </div>
                    <div class="overflow-hidden bg-gray-50 flex flex-col">
                        <!-- Tabs -->
                        <div class="record-tabs px-6 pt-4 flex-shrink-0">
                            <div class="record-tab active" data-tab="history" onclick="switchRecordTab('history')">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                History
                            </div>
                            <div class="record-tab" data-tab="relationships" onclick="switchRecordTab('relationships')">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Relationships
                            </div>
                        </div>
                        <!-- Tab content -->
                        <div class="flex-1 overflow-y-auto p-6" id="expandedRecordSidebar">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Relationship Modal -->
    <div id="relationshipEditorModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between flex-shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Add Relationship</h2>
                    <p class="text-sm text-gray-500 mt-1">Connect records with meaningful relationships</p>
                </div>
                <button id="closeRelationshipEditorBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body" id="relationshipEditorContent">
            </div>
            <div class="modal-footer flex justify-end gap-2 flex-shrink-0">
                <button id="cancelRelationshipBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveRelationshipBtn" class="btn btn-primary">Save Relationship</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Field Modal - Airtable Style -->
    <div id="addFieldModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900" id="fieldModalTitle">Add Field</h2>
                    <p class="text-sm text-gray-500 mt-1">Create a new field for your table</p>
                </div>
                <button id="closeAddFieldBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body space-y-5">
                <div>
                    <label class="form-label" for="newFieldName">Field Name</label>
                    <input type="text" id="newFieldName" placeholder="e.g., Status, Amount, Contact Person" autofocus>
                    <p class="form-hint">A descriptive name for your field</p>
                </div>
                <div>
                    <label class="form-label">Field Type</label>
                    <div class="field-type-grid" id="fieldTypeGrid">
                        <!-- Field types will be rendered here -->
                    </div>
                    <input type="hidden" id="newFieldType" value="TEXT">
                </div>
                
                <!-- Link to Record Config -->
                <div id="linkToRecordConfig" class="config-section">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <label class="form-label" for="linkToTable">Link to Table</label>
                        <select id="linkToTable">
                        </select>
                        <p class="form-hint">Select which table to link to</p>
                    </div>
                </div>
                
                <!-- Lookup Config -->
                <div id="lookupConfig" class="config-section">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 space-y-4">
                        <div>
                            <label class="form-label" for="lookupLinkField">From Link Field</label>
                            <select id="lookupLinkField">
                                <option value="">Select a link field...</option>
                            </select>
                            <p class="form-hint">Choose a link field from this table</p>
                        </div>
                        <div>
                            <label class="form-label" for="lookupTargetField">Lookup Field</label>
                            <select id="lookupTargetField">
                                <option value="">Select a field to lookup...</option>
                            </select>
                            <p class="form-hint">Choose which field to display from linked records</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddFieldBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddFieldBtn" class="btn btn-primary">Add Field</button>
            </div>
        </div>
    </div>

    <!-- Add View Modal -->
    <div id="addViewModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Create View</h2>
                    <p class="text-sm text-gray-500 mt-1">Filter and organize your data</p>
                </div>
                <button id="closeAddViewBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label" for="newViewName">View Name</label>
                    <input type="text" id="newViewName" placeholder="e.g., Active Items, Completed, By Status" autofocus>
                    <p class="form-hint">Give your view a descriptive name</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddViewBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddViewBtn" class="btn btn-primary">Create View</button>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-2xl">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Filter View</h2>
                    <p class="text-sm text-gray-500 mt-1">Show only records that match your criteria</p>
                </div>
                <button id="closeFilterBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <button id="addFilterRuleBtn" class="text-sm text-blue-600 hover:text-blue-800 font-medium">+ Add Filter Rule</button>
                </div>
                <div id="filterRulesContainer" class="space-y-2">
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="clearFiltersBtn" class="btn btn-secondary">Clear All</button>
                <button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Add Table Modal -->
    <div id="addTableModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50" role="dialog" aria-modal="true">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Create Table</h2>
                    <p class="text-sm text-gray-500 mt-1">Add a new table to organize your data</p>
                </div>
                <button id="closeAddTableBtn" class="text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label" for="newTableName">Table Name</label>
                    <input type="text" id="newTableName" placeholder="e.g., Projects, Contacts, Tasks" autofocus>
                    <p class="form-hint">Choose a name that describes what you'll store</p>
                </div>
                <div>
                    <label class="form-label" for="newTableIcon">Icon (emoji)</label>
                    <input type="text" id="newTableIcon" placeholder="üìä" maxlength="2">
                    <p class="form-hint">Add a visual identifier for your table</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddTableBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddTableBtn" class="btn btn-primary">Create Table</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // ============================================================================
        // DATA MODEL & STATE
        // ============================================================================
        
        const state = {
            tables: new Map(),
            currentTableId: null,
            currentViewId: null,
            eventStream: [],
            eventIdCounter: 1,
            currentUser: {
                type: 'Person',
                id: 'user_' + Date.now(),
                name: 'User'
            },
            tempRelationship: null,
            historyFilter: 'all',
            historySearch: '',
            suppressEvents: false,
            modalStack: [],
            editingFieldId: null // For editing existing fields
        };

        // Field type definitions
        const FIELD_TYPES = {
            TEXT: {
                id: 'TEXT',
                name: 'Single line text',
                icon: 'type',
                defaultValue: '',
                render: (value) => value || '',
                needsConfig: false
            },
            LONG_TEXT: {
                id: 'LONG_TEXT',
                name: 'Long text',
                icon: 'align-left',
                defaultValue: '',
                render: (value) => value || '',
                needsConfig: false
            },
            NUMBER: {
                id: 'NUMBER',
                name: 'Number',
                icon: 'hash',
                defaultValue: 0,
                render: (value) => value !== '' && value !== null ? Number(value).toLocaleString() : '',
                needsConfig: false
            },
            CURRENCY: {
                id: 'CURRENCY',
                name: 'Currency',
                icon: 'dollar-sign',
                defaultValue: 0,
                render: (value) => value !== '' && value !== null ? 
                    new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value) : '',
                needsConfig: false
            },
            DATE: {
                id: 'DATE',
                name: 'Date',
                icon: 'calendar',
                defaultValue: '',
                render: (value) => value ? new Date(value).toLocaleDateString() : '',
                needsConfig: false
            },
            EMAIL: {
                id: 'EMAIL',
                name: 'Email',
                icon: 'mail',
                defaultValue: '',
                render: (value) => value ? `<a href="mailto:${value}" class="text-blue-600 hover:underline">${value}</a>` : '',
                needsConfig: false
            },
            URL: {
                id: 'URL',
                name: 'URL',
                icon: 'link',
                defaultValue: '',
                render: (value) => value ? `<a href="${value}" target="_blank" class="text-blue-600 hover:underline">üîó Link</a>` : '',
                needsConfig: false
            },
            PHONE: {
                id: 'PHONE',
                name: 'Phone number',
                icon: 'phone',
                defaultValue: '',
                render: (value) => value || '',
                needsConfig: false
            },
            SINGLE_SELECT: {
                id: 'SINGLE_SELECT',
                name: 'Single select',
                icon: 'check-circle',
                defaultValue: '',
                render: (value, config = {}) => {
                    if (!value) return '';
                    const color = (config.colors && config.colors[value]) || 'gray';
                    return `<span class="badge badge-${color}">${value}</span>`;
                },
                needsConfig: true,
                defaultConfig: {
                    options: ['Option 1', 'Option 2', 'Option 3'],
                    colors: {
                        'Option 1': 'blue',
                        'Option 2': 'green',
                        'Option 3': 'purple'
                    }
                }
            },
            CHECKBOX: {
                id: 'CHECKBOX',
                name: 'Checkbox',
                icon: 'check-square',
                defaultValue: false,
                render: (value) => value ? '‚úÖ' : '‚¨ú',
                needsConfig: false
            },
            LINK_TO_RECORD: {
                id: 'LINK_TO_RECORD',
                name: 'Link to another record',
                icon: 'link-2',
                defaultValue: [],
                render: (value, config = {}, currentRecord) => {
                    if (!value || value.length === 0) return '';
                    const targetTableId = config.targetTable;
                    const targetTable = state.tables.get(targetTableId);
                    if (!targetTable) return '';
                    
                    return value.map(linkedId => {
                        const linkedRecord = targetTable.records.get(linkedId);
                        if (!linkedRecord) return '';
                        const displayValue = linkedRecord[config.displayField] || linkedRecord.name || linkedId;
                        return `<span class="link-pill" onclick="jumpToRecord('${targetTableId}', '${linkedId}')">${displayValue}</span>`;
                    }).join(' ');
                },
                needsConfig: true,
                defaultConfig: {
                    targetTable: null,
                    displayField: 'name',
                    allowMultiple: true
                }
            },
            LOOKUP: {
                id: 'LOOKUP',
                name: 'Lookup',
                icon: 'search',
                defaultValue: null,
                render: (value, config = {}, currentRecord) => {
                    // Lookup doesn't store data - it computes on the fly
                    if (!config.linkField || !config.lookupField) return '';
                    
                    const table = state.tables.get(state.currentTableId);
                    const linkFieldDef = table.schema.find(f => f.id === config.linkField);
                    if (!linkFieldDef || linkFieldDef.type !== 'LINK_TO_RECORD') return '';
                    
                    const linkedIds = currentRecord[config.linkField];
                    if (!linkedIds || linkedIds.length === 0) return '';
                    
                    const targetTableId = linkFieldDef.config.targetTable;
                    const targetTable = state.tables.get(targetTableId);
                    if (!targetTable) return '';
                    
                    // Get values from linked records
                    const values = linkedIds.map(linkedId => {
                        const linkedRecord = targetTable.records.get(linkedId);
                        if (!linkedRecord) return null;
                        return linkedRecord[config.lookupField];
                    }).filter(v => v !== null && v !== undefined && v !== '');
                    
                    if (values.length === 0) return '';
                    
                    // Render based on the target field type
                    const targetField = targetTable.schema.find(f => f.id === config.lookupField);
                    if (!targetField) return values.join(', ');
                    
                    const targetFieldType = FIELD_TYPES[targetField.type];
                    return values.map(v => targetFieldType.render(v, targetField.config)).join(', ');
                },
                needsConfig: true,
                defaultConfig: {
                    linkField: null,
                    lookupField: null
                }
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        function initializeApp() {
            createSampleData();
            renderTableTabs();
            if (state.currentTableId) {
                switchTable(state.currentTableId);
            }
            setupEventListeners();
            setupKeyboardShortcuts();
            initIcons();
        }

        function createSampleData() {
            state.suppressEvents = true;
            
            const projectsId = createTable('Projects', 'üìä');
            const contactsId = createTable('Contacts', 'üë§');
            
            const projectsTable = state.tables.get(projectsId);
            projectsTable.schema = [
                { id: 'name', name: 'Project Name', type: 'TEXT', width: '200px' },
                { id: 'status', name: 'Status', type: 'SINGLE_SELECT', width: '130px', config: {
                    options: ['Not Started', 'In Progress', 'On Hold', 'Completed'],
                    colors: {
                        'Not Started': 'gray',
                        'In Progress': 'blue',
                        'On Hold': 'yellow',
                        'Completed': 'green'
                    }
                }},
                { id: 'budget', name: 'Budget', type: 'CURRENCY', width: '120px' },
                { id: 'start_date', name: 'Start Date', type: 'DATE', width: '120px' },
                { id: 'notes', name: 'Notes', type: 'LONG_TEXT', width: '300px' }
            ];
            
            addRecord(projectsId, {
                name: 'Website Redesign',
                status: 'In Progress',
                budget: 50000,
                start_date: '2024-01-15',
                notes: 'Complete overhaul of company website'
            });
            
            addRecord(projectsId, {
                name: 'Mobile App Launch',
                status: 'Not Started',
                budget: 120000,
                start_date: '2024-06-01',
                notes: 'iOS and Android native apps'
            });
            
            const contactsTable = state.tables.get(contactsId);
            contactsTable.schema = [
                { id: 'name', name: 'Full Name', type: 'TEXT', width: '200px' },
                { id: 'email', name: 'Email', type: 'EMAIL', width: '200px' },
                { id: 'phone', name: 'Phone', type: 'PHONE', width: '150px' },
                { id: 'company', name: 'Company', type: 'TEXT', width: '150px' }
            ];
            
            addRecord(contactsId, {
                name: 'John Smith',
                email: 'john@example.com',
                phone: '555-0100',
                company: 'Acme Corp'
            });
            
            state.currentTableId = projectsId;
            state.suppressEvents = false;
        }

        function createTable(name, icon = 'üìä') {
            const tableId = 'table_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            state.tables.set(tableId, {
                id: tableId,
                name: name,
                icon: icon,
                schema: [],
                records: new Map(),
                views: new Map()
            });
            
            const oldSuppressState = state.suppressEvents;
            state.suppressEvents = true;
            const defaultViewId = createView(tableId, 'All ' + name, {}, true);
            state.suppressEvents = oldSuppressState;
            
            createEvent('Create', {
                type: 'Table',
                id: tableId,
                name: name
            }, `Created table "${name}"`);
            
            return tableId;
        }

        function createView(tableId, name, config = {}, suppressEvent = false) {
            const viewId = 'view_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const table = state.tables.get(tableId);
            
            table.views.set(viewId, {
                id: viewId,
                name: name,
                filters: config.filters || [],
                sorts: config.sorts || [],
                hiddenFields: config.hiddenFields || []
            });
            
            if (!state.currentViewId) {
                state.currentViewId = viewId;
            }
            
            if (!suppressEvent && !state.suppressEvents) {
                createEvent('Create', {
                    type: 'View',
                    id: viewId,
                    tableId: tableId,
                    name: name,
                    config: config
                }, `Created view "${name}" in ${table.name}`);
            }
            
            return viewId;
        }

        function addRecord(tableId, data) {
            const table = state.tables.get(tableId);
            const recordId = 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const record = { id: recordId, ...data };
            table.records.set(recordId, record);
            
            createEvent('Create', {
                type: 'Record',
                tableId: tableId,
                recordId: recordId,
                data: data
            }, `Created record in ${table.name}`);
            
            return recordId;
        }

        // ============================================================================
        // EVENT SOURCING - WITH EFFICIENT REVERTS
        // ============================================================================
        
        function createEvent(type, object, summary) {
            if (state.suppressEvents) return null;
            
            const event = {
                '@context': 'https://www.w3.org/ns/activitystreams',
                'type': type,
                'id': `event-${String(state.eventIdCounter++).padStart(4, '0')}`,
                'published': new Date().toISOString(),
                'actor': state.currentUser,
                'object': object,
                'summary': summary
            };

            state.eventStream.unshift(event);
            return event;
        }

        // Space-efficient revert: just point to the event being reverted to
        function createRevertEvent(targetEventId, scope) {
            const targetEvent = state.eventStream.find(e => e.id === targetEventId);
            if (!targetEvent) return null;
            
            const event = {
                '@context': 'https://www.w3.org/ns/activitystreams',
                'type': 'Undo',
                'id': `event-${String(state.eventIdCounter++).padStart(4, '0')}`,
                'published': new Date().toISOString(),
                'actor': state.currentUser,
                'object': {
                    type: 'Revert',
                    targetEventId: targetEventId,
                    scope: scope // 'cell', 'row', 'column', 'view', 'table'
                },
                'summary': `Reverted to ${targetEvent.id} (${scope})`
            };

            state.eventStream.unshift(event);
            return event;
        }

        // ============================================================================
        // TABLE MANAGEMENT
        // ============================================================================
        
        function renderTableTabs() {
            const container = document.getElementById('tableTabsContainer');
            container.innerHTML = '';
            
            state.tables.forEach((table, tableId) => {
                const tab = document.createElement('div');
                tab.className = `table-tab ${tableId === state.currentTableId ? 'active' : ''}`;
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-selected', tableId === state.currentTableId);
                tab.innerHTML = `
                    <span class="text-lg mr-2">${table.icon}</span>
                    <span>${table.name}</span>
                `;
                tab.onclick = () => switchTable(tableId);
                container.appendChild(tab);
            });
        }

        function switchTable(tableId) {
            state.currentTableId = tableId;
            const table = state.tables.get(tableId);
            
            if (table.views.size > 0) {
                state.currentViewId = Array.from(table.views.keys())[0];
            }
            
            renderTableTabs();
            renderViewTabs();
            renderCurrentView();
        }

        function getCurrentTable() {
            return state.tables.get(state.currentTableId);
        }

        function getCurrentView() {
            const table = getCurrentTable();
            return table?.views.get(state.currentViewId);
        }

        // ============================================================================
        // VIEW MANAGEMENT
        // ============================================================================
        
        function renderViewTabs() {
            const container = document.getElementById('viewTabsContainer');
            container.innerHTML = '';
            
            const table = getCurrentTable();
            if (!table) return;
            
            table.views.forEach((view, viewId) => {
                const tab = document.createElement('button');
                tab.className = `view-tab ${viewId === state.currentViewId ? 'active' : ''}`;
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-selected', viewId === state.currentViewId);
                tab.textContent = view.name;
                tab.onclick = () => switchView(viewId);
                container.appendChild(tab);
            });
        }

        function switchView(viewId) {
            state.currentViewId = viewId;
            renderViewTabs();
            renderCurrentView();
        }

        function renderCurrentView() {
            document.getElementById('gridView').classList.remove('hidden');
            renderGridView();
        }

        function renderGridView() {
            const table = getCurrentTable();
            if (!table) return;
            
            const view = getCurrentView();
            const schema = table.schema;
            let records = Array.from(table.records.values());
            
            if (view && view.filters.length > 0) {
                records = applyFilters(records, view.filters, schema);
            }
            
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '<th class="column-header" style="width: 50px;">#</th>';
            
            schema.forEach(field => {
                if (view && view.hiddenFields.includes(field.id)) return;
                
                const th = document.createElement('th');
                th.className = 'column-header';
                th.dataset.type = field.type;
                th.dataset.fieldId = field.id;
                th.style.width = field.width || '150px';
                
                const fieldType = FIELD_TYPES[field.type];
                th.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${fieldType.icon}" class="w-4 h-4"></i>
                            <span>${field.name}</span>
                        </div>
                    </div>
                `;
                
                // Right-click context menu on column header
                th.oncontextmenu = (e) => {
                    e.preventDefault();
                    showColumnContextMenu(e, field);
                };
                
                headerRow.appendChild(th);
            });
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            records.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                tr.dataset.recordId = record.id;
                
                tr.onclick = (e) => {
                    if (e.target === tr || e.target.closest('.row-number')) {
                        openExpandedRecord(record.id);
                    }
                };
                
                // Row number with context menu
                const tdNum = document.createElement('td');
                tdNum.className = 'row-number cell-editable text-center bg-gray-50 font-medium text-gray-500';
                tdNum.textContent = index + 1;
                tdNum.style.cursor = 'pointer';
                tdNum.oncontextmenu = (e) => {
                    e.preventDefault();
                    showRowContextMenu(e, record.id);
                };
                tr.appendChild(tdNum);
                
                // Data cells
                schema.forEach(field => {
                    if (view && view.hiddenFields.includes(field.id)) return;
                    
                    const td = document.createElement('td');
                    td.className = 'cell-editable';
                    td.dataset.recordId = record.id;
                    td.dataset.fieldId = field.id;
                    
                    if (getCellHistory(record.id, field.id).length > 0) {
                        td.classList.add('cell-with-history');
                    }
                    
                    const fieldType = FIELD_TYPES[field.type];
                    const value = record[field.id];
                    
                    if (field.type === 'CHECKBOX') {
                        td.innerHTML = `<div class="checkbox-cell" onclick="event.stopPropagation(); toggleCheckbox('${record.id}', '${field.id}')">${fieldType.render(value)}</div>`;
                    } else if (field.type === 'LINK_TO_RECORD') {
                        td.innerHTML = fieldType.render(value, field.config, record);
                        td.onclick = (e) => {
                            e.stopPropagation();
                            openLinkSelector(record.id, field);
                        };
                    } else {
                        td.innerHTML = fieldType.render(value, field.config, record);
                        td.onclick = (e) => {
                            e.stopPropagation();
                            makeEditable(td, record.id, field);
                        };
                        td.ondblclick = (e) => {
                            e.stopPropagation();
                            openExpandedRecord(record.id, field.id);
                        };
                    }
                    
                    // Right-click for cell history
                    td.oncontextmenu = (e) => {
                        e.preventDefault();
                        showCellContextMenu(e, record.id, field.id);
                    };
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            initIcons();
        }

        function applyFilters(records, filters, schema) {
            return records.filter(record => {
                return filters.every(filter => {
                    const field = schema.find(f => f.id === filter.field);
                    if (!field) return true;
                    
                    const value = record[filter.field];
                    
                    switch(filter.operator) {
                        case 'equals':
                            return value === filter.value;
                        case 'not_equals':
                            return value !== filter.value;
                        case 'contains':
                            return String(value).toLowerCase().includes(String(filter.value).toLowerCase());
                        case 'greater_than':
                            return value > filter.value;
                        case 'less_than':
                            return value < filter.value;
                        case 'is_empty':
                            return !value || value === '';
                        case 'is_not_empty':
                            return value && value !== '';
                        default:
                            return true;
                    }
                });
            });
        }

        // ============================================================================
        // CONTEXT MENUS
        // ============================================================================
        
        function showColumnContextMenu(e, field) {
            removeExistingContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            
            const history = getColumnHistory(field.id);
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="editField('${field.id}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Field
                </div>
                <div class="context-menu-item" onclick="showColumnHistory('${field.id}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    View History (${history.length})
                </div>
                ${history.length > 0 ? `
                    <div class="context-menu-item" onclick="revertColumn('${field.id}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                        Revert Column
                    </div>
                ` : ''}
                <div class="context-menu-separator"></div>
                <div class="context-menu-item danger" onclick="deleteField('${field.id}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Field
                </div>
            `;
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    removeExistingContextMenu();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        function showRowContextMenu(e, recordId) {
            removeExistingContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            
            const history = getRecordHistory(recordId);
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="openExpandedRecord('${recordId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    View Record
                </div>
                <div class="context-menu-item" onclick="showRecordHistory('${recordId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    View History (${history.length})
                </div>
                ${history.length > 0 ? `
                    <div class="context-menu-item" onclick="revertRow('${recordId}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                        Revert Row
                    </div>
                ` : ''}
                <div class="context-menu-separator"></div>
                <div class="context-menu-item danger" onclick="deleteRecord('${recordId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Record
                </div>
            `;
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    removeExistingContextMenu();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        function showCellContextMenu(e, recordId, fieldId) {
            removeExistingContextMenu();
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            
            const history = getCellHistory(recordId, fieldId);
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="showCellHistory('${recordId}', '${fieldId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    View History (${history.length})
                </div>
                ${history.length > 0 ? `
                    <div class="context-menu-item" onclick="revertCell('${recordId}', '${fieldId}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                        Revert Cell
                    </div>
                ` : ''}
            `;
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    removeExistingContextMenu();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        function removeExistingContextMenu() {
            const existing = document.querySelector('.context-menu');
            if (existing) existing.remove();
        }

        // ============================================================================
        // BATCH REVERT FUNCTIONS
        // ============================================================================
        
        function revertCell(recordId, fieldId) {
            const history = getCellHistory(recordId, fieldId);
            if (history.length === 0) {
                showToast('No history to revert');
                return;
            }
            
            // Get the most recent change to revert
            const lastChange = history[0];
            
            // Apply the revert
            updateRecord(recordId, fieldId, lastChange.object.oldValue, lastChange.object.newValue);
            
            // Create efficient revert event
            createRevertEvent(lastChange.id, 'cell');
            
            showToast('‚úì Reverted cell');
        }

        function revertRow(recordId) {
            const history = getRecordHistory(recordId);
            if (history.length === 0) {
                showToast('No history to revert');
                return;
            }
            
            // Revert all cell changes for this record
            const cellChanges = history.filter(e => e.type === 'Update' && e.object.type === 'CellEdit');
            
            if (cellChanges.length === 0) {
                showToast('No changes to revert');
                return;
            }
            
            // Group by field to get the most recent change for each field
            const fieldMap = new Map();
            cellChanges.forEach(change => {
                const fieldId = change.object.fieldId;
                if (!fieldMap.has(fieldId)) {
                    fieldMap.set(fieldId, change);
                }
            });
            
            // Revert each field
            fieldMap.forEach((change, fieldId) => {
                updateRecord(recordId, fieldId, change.object.oldValue, change.object.newValue);
            });
            
            // Create efficient revert event pointing to the last change
            createRevertEvent(cellChanges[0].id, 'row');
            
            renderGridView();
            showToast(`‚úì Reverted row (${fieldMap.size} changes)`);
        }

        function revertColumn(fieldId) {
            const history = getColumnHistory(fieldId);
            if (history.length === 0) {
                showToast('No history to revert');
                return;
            }
            
            // Group by record to get the most recent change for each record
            const recordMap = new Map();
            history.forEach(change => {
                const recordId = change.object.recordId;
                if (!recordMap.has(recordId)) {
                    recordMap.set(recordId, change);
                }
            });
            
            // Revert each record
            recordMap.forEach((change, recordId) => {
                updateRecord(recordId, fieldId, change.object.oldValue, change.object.newValue);
            });
            
            // Create efficient revert event
            createRevertEvent(history[0].id, 'column');
            
            renderGridView();
            showToast(`‚úì Reverted column (${recordMap.size} changes)`);
        }

        // ============================================================================
        // CELL EDITING WITH HISTORY
        // ============================================================================
        
        function makeEditable(cell, recordId, field) {
            const table = getCurrentTable();
            const record = table.records.get(recordId);
            const currentValue = record[field.id];
            
            if (field.type === 'DATE') {
                showDatePicker(cell, recordId, field, currentValue);
                return;
            }
            
            if (field.type === 'SINGLE_SELECT') {
                showSelectDropdown(cell, recordId, field, currentValue);
                return;
            }
            
            const originalHTML = cell.innerHTML;
            cell.contentEditable = true;
            cell.textContent = currentValue || '';
            cell.focus();
            
            const range = document.createRange();
            range.selectNodeContents(cell);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            let isFinishing = false;
            
            const finishEdit = () => {
                if (isFinishing) return;
                isFinishing = true;
                
                cell.onblur = null;
                cell.onkeydown = null;
                
                cell.contentEditable = false;
                let newValue = cell.textContent.trim();
                
                if (field.type === 'NUMBER' || field.type === 'CURRENCY') {
                    newValue = newValue === '' ? 0 : parseFloat(newValue.replace(/[^0-9.-]/g, ''));
                }
                
                if (String(newValue) !== String(currentValue)) {
                    updateRecord(recordId, field.id, newValue, currentValue);
                } else {
                    cell.innerHTML = originalHTML;
                }
                
                initIcons();
            };
            
            cell.onblur = finishEdit;
            cell.onkeydown = (e) => {
                if (e.key === 'Enter' && field.type !== 'LONG_TEXT') {
                    e.preventDefault();
                    finishEdit();
                }
                if (e.key === 'Escape') {
                    cell.textContent = currentValue || '';
                    finishEdit();
                }
            };
        }

        function toggleCheckbox(recordId, fieldId) {
            const table = getCurrentTable();
            const record = table.records.get(recordId);
            const currentValue = record[fieldId];
            updateRecord(recordId, fieldId, !currentValue, currentValue);
        }

        function showDatePicker(cell, recordId, field, currentValue) {
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentValue || '';
            input.className = 'w-full px-2 py-1';
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            
            let isFinishing = false;
            
            const finishEdit = () => {
                if (isFinishing) return;
                isFinishing = true;
                
                input.onblur = null;
                input.onchange = null;
                
                const newValue = input.value;
                if (newValue !== currentValue) {
                    updateRecord(recordId, field.id, newValue, currentValue);
                } else {
                    renderGridView();
                }
            };
            
            input.onblur = finishEdit;
            input.onchange = finishEdit;
        }

        function showSelectDropdown(cell, recordId, field, currentValue) {
            const rect = cell.getBoundingClientRect();
            const dropdown = document.createElement('div');
            dropdown.className = 'fixed bg-white border border-gray-200 rounded-lg shadow-lg z-50';
            dropdown.style.top = `${rect.bottom + 4}px`;
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.minWidth = '200px';
            
            field.config.options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2';
                const color = field.config.colors[option] || 'gray';
                optionEl.innerHTML = `<span class="badge badge-${color}">${option}</span>`;
                
                optionEl.onclick = () => {
                    if (option !== currentValue) {
                        updateRecord(recordId, field.id, option, currentValue);
                    }
                    dropdown.remove();
                };
                
                dropdown.appendChild(optionEl);
            });
            
            document.body.appendChild(dropdown);
            
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== cell) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        function updateRecord(recordId, fieldId, newValue, oldValue) {
            const table = getCurrentTable();
            const record = table.records.get(recordId);
            const field = table.schema.find(f => f.id === fieldId);
            
            record[fieldId] = newValue;
            
            createEvent('Update', {
                type: 'CellEdit',
                tableId: table.id,
                recordId: recordId,
                fieldId: fieldId,
                fieldName: field.name,
                oldValue: oldValue,
                newValue: newValue
            }, `Updated ${field.name} from "${oldValue}" to "${newValue}"`);
            
            renderGridView();
            
            setTimeout(() => {
                const cell = document.querySelector(`[data-record-id="${recordId}"][data-field-id="${fieldId}"]`);
                if (cell) {
                    cell.classList.add('cell-recently-changed');
                    setTimeout(() => cell.classList.remove('cell-recently-changed'), 500);
                }
            }, 0);
            
            showToast(`‚úì Updated ${field.name}`);
        }

        function deleteRecord(recordId) {
            if (!confirm('Delete this record? This cannot be undone.')) return;
            
            const table = getCurrentTable();
            const record = table.records.get(recordId);
            table.records.delete(recordId);
            
            createEvent('Delete', {
                type: 'Record',
                recordId: recordId,
                data: record
            }, `Deleted record`);
            
            renderGridView();
            showToast('‚úì Deleted record');
        }

        function deleteField(fieldId) {
            if (!confirm('Delete this field? This will remove data from all records.')) return;
            
            const table = getCurrentTable();
            const fieldIndex = table.schema.findIndex(f => f.id === fieldId);
            if (fieldIndex === -1) return;
            
            const field = table.schema[fieldIndex];
            table.schema.splice(fieldIndex, 1);
            
            // Remove field from all records
            table.records.forEach(record => {
                delete record[fieldId];
            });
            
            createEvent('Delete', {
                type: 'Field',
                fieldId: fieldId,
                fieldName: field.name
            }, `Deleted field "${field.name}"`);
            
            renderGridView();
            showToast('‚úì Deleted field');
        }

        // ============================================================================
        // HISTORY TRACKING
        // ============================================================================
        
        function getCellHistory(recordId, fieldId) {
            return state.eventStream.filter(e => 
                e.type === 'Update' && 
                e.object.type === 'CellEdit' &&
                e.object.recordId === recordId && 
                e.object.fieldId === fieldId
            );
        }

        function getRecordHistory(recordId) {
            return state.eventStream.filter(e => {
                if (e.type === 'Update' && e.object.type === 'CellEdit' && e.object.recordId === recordId) {
                    return true;
                }
                if (e.type === 'Create' && e.object.type === 'Record' && e.object.recordId === recordId) {
                    return true;
                }
                return false;
            });
        }

        function getColumnHistory(fieldId) {
            return state.eventStream.filter(e => 
                e.type === 'Update' && 
                e.object.type === 'CellEdit' &&
                e.object.fieldId === fieldId
            );
        }

        function showCellHistory(recordId, fieldId) {
            const table = getCurrentTable();
            const field = table.schema.find(f => f.id === fieldId);
            const record = table.records.get(recordId);
            
            document.getElementById('historyPanel').classList.add('open');
            state.historyFilter = 'cell';
            state.historySearch = `${record.name || recordId} - ${field.name}`;
            document.getElementById('historySearch').value = state.historySearch;
            document.getElementById('historyFilter').value = 'cell';
            renderHistory();
        }

        function showRecordHistory(recordId) {
            document.getElementById('historyPanel').classList.add('open');
            state.historyFilter = 'all';
            state.historySearch = recordId;
            document.getElementById('historySearch').value = state.historySearch;
            document.getElementById('historyFilter').value = 'all';
            renderHistory();
        }

        function showColumnHistory(fieldId) {
            const table = getCurrentTable();
            const field = table.schema.find(f => f.id === fieldId);
            
            document.getElementById('historyPanel').classList.add('open');
            state.historyFilter = 'cell';
            state.historySearch = field.name;
            document.getElementById('historySearch').value = state.historySearch;
            document.getElementById('historyFilter').value = 'cell';
            renderHistory();
        }

        function renderHistory(subtitle = '') {
            let filtered = [...state.eventStream];
            
            if (state.historyFilter !== 'all') {
                filtered = filtered.filter(e => {
                    switch(state.historyFilter) {
                        case 'cell':
                            return e.type === 'Update' && e.object.type === 'CellEdit';
                        case 'record':
                            return e.type === 'Create' && e.object.type === 'Record';
                        case 'field':
                            return e.type === 'Create' && e.object.type === 'Field';
                        case 'relationship':
                            return e.type === 'Add' && e.object.target;
                        case 'view':
                            return e.type === 'Create' && e.object.type === 'View';
                        default:
                            return true;
                    }
                });
            }
            
            if (state.historySearch) {
                const query = state.historySearch.toLowerCase();
                filtered = filtered.filter(e => 
                    e.summary.toLowerCase().includes(query)
                );
            }
            
            document.getElementById('historyTotal').textContent = state.eventStream.length;
            document.getElementById('historyShown').textContent = filtered.length;
            
            const content = document.getElementById('historyContent');
            
            if (filtered.length === 0) {
                const noEventsMsg = state.eventStream.length === 0 
                    ? 'Start making changes to see them here'
                    : 'No history matches your filters';
                    
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p class="text-gray-600 font-medium">${state.eventStream.length === 0 ? 'No history yet' : 'No matches found'}</p>
                        <p class="text-sm text-gray-500 mt-2">${noEventsMsg}</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = filtered.map(event => renderHistoryEntry(event)).join('');
            initIcons();
        }

        function renderHistoryEntry(event) {
            const timeAgo = getTimeAgo(event.published);
            let icon = 'üìù';
            let canRevert = false;
            let isRevert = false;
            
            if (event.type === 'Undo' && event.object.type === 'Revert') {
                icon = '‚èÆÔ∏è';
                isRevert = true;
                const targetEvent = state.eventStream.find(e => e.id === event.object.targetEventId);
                return `
                    <div class="history-entry revert">
                        <div class="flex items-start gap-3 mb-2">
                            <span class="text-xl">${icon}</span>
                            <div class="flex-1">
                                <div class="font-medium text-sm text-gray-900">Revert (${event.object.scope})</div>
                                <div class="text-xs text-gray-500">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-700 ml-11">‚Üí Reverted to ${event.object.targetEventId}</div>
                    </div>
                `;
            } else if (event.type === 'Update' && event.object.type === 'CellEdit') {
                icon = '‚úèÔ∏è';
                canRevert = true;
            } else if (event.type === 'Create') {
                icon = '‚ûï';
            } else if (event.type === 'Add') {
                icon = 'üîó';
                canRevert = true;
            }
            
            return `
                <div class="history-entry ${isRevert ? 'revert' : ''}" ${canRevert ? `onclick="restoreFromHistory('${event.id}')"` : ''}>
                    <div class="flex items-start gap-3 mb-2">
                        <span class="text-xl">${icon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-sm text-gray-900">${event.type}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </div>
                        ${canRevert ? `
                            <button class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                Restore
                            </button>
                        ` : ''}
                    </div>
                    <div class="text-sm text-gray-700 ml-11">${event.summary}</div>
                    ${event.type === 'Update' && event.object.type === 'CellEdit' ? `
                        <div class="value-change ml-11 mt-2">
                            <span class="value-old">${event.object.oldValue}</span>
                            <span class="text-gray-400">‚Üí</span>
                            <span class="value-new">${event.object.newValue}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function restoreFromHistory(eventId) {
            const event = state.eventStream.find(e => e.id === eventId);
            if (!event) return;
            
            if (event.type === 'Update' && event.object.type === 'CellEdit') {
                updateRecord(event.object.recordId, event.object.fieldId, event.object.oldValue, event.object.newValue);
                createRevertEvent(eventId, 'cell');
                showToast('‚úì Restored previous value');
            } else if (event.type === 'Add' && event.object.target) {
                const newEvent = createEvent('Remove', {
                    relationshipId: event.id,
                    ...event.object
                }, `Removed ${event.object.relationship} relationship`);
                
                showToast('‚úì Removed relationship');
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // ============================================================================
        // EXPANDED RECORD VIEW
        // ============================================================================
        
        let currentRecordTab = 'history';
        
        function switchRecordTab(tabName) {
            currentRecordTab = tabName;
            
            // Update tab visual state
            document.querySelectorAll('.record-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.record-tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Render appropriate content
            const recordId = document.getElementById('expandedRecordSidebar').dataset.recordId;
            renderRecordSidebarContent(recordId);
        }
        
        function renderRecordSidebarContent(recordId) {
            const sidebarContent = document.getElementById('expandedRecordSidebar');
            sidebarContent.dataset.recordId = recordId;
            
            if (currentRecordTab === 'history') {
                const history = getRecordHistory(recordId);
                sidebarContent.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase">Change History</h3>
                        <span class="badge badge-blue">${history.length}</span>
                    </div>
                    ${history.length === 0 ? `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-2 opacity-50">üìù</div>
                            <p class="text-sm text-gray-500">No changes yet</p>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${history.map(event => renderCompactHistoryEntry(event)).join('')}
                        </div>
                    `}
                `;
            } else if (currentRecordTab === 'relationships') {
                const relationships = getRecordRelationships(recordId);
                sidebarContent.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase">Relationships</h3>
                        <span class="badge badge-cyan">${relationships.length}</span>
                    </div>
                    ${relationships.length === 0 ? `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-2 opacity-50">üîó</div>
                            <p class="text-sm text-gray-500 mb-4">No relationships yet</p>
                            <button onclick="openRelationshipEditor('${recordId}')" class="btn btn-secondary btn-sm">
                                + Add Relationship
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-2 mb-4">
                            ${relationships.map(rel => renderRelationshipCard(rel)).join('')}
                        </div>
                        <button onclick="openRelationshipEditor('${recordId}')" class="btn btn-secondary w-full text-sm">
                            + Add Relationship
                        </button>
                    `}
                `;
            }
            
            initIcons();
        }
        
        function getRecordRelationships(recordId) {
            return state.eventStream.filter(e => 
                e.type === 'Add' && 
                e.object && 
                e.object.target &&
                (e.object.id === recordId || e.object.target.id === recordId)
            );
        }
        
        function renderRelationshipCard(event) {
            const rel = event.object;
            const props = rel.relationshipProperties || {};
            const hasProps = Object.keys(props).length > 0;
            
            return `
                <div class="relationship-card">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-medium text-sm">${rel.name || rel.id}</span>
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                </svg>
                                <span class="font-medium text-sm">${rel.target.name || rel.target.id}</span>
                            </div>
                            <span class="badge badge-blue text-xs">${rel.relationship}</span>
                            ${hasProps ? `
                                <div class="text-xs text-gray-600 space-y-1 mt-2 pl-4 border-l-2 border-gray-200">
                                    ${Object.entries(props).map(([key, value]) => `
                                        <div class="flex gap-2">
                                            <span class="font-medium">${formatPropertyName(key)}:</span>
                                            <span>${formatPropertyValue(value)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="restoreFromHistory('${event.id}')" class="text-red-600 hover:text-red-800 transition ml-4 text-xs">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        function openExpandedRecord(recordId, focusFieldId = null) {
            const table = getCurrentTable();
            const record = table.records.get(recordId);
            
            currentRecordTab = 'history'; // Reset to history tab
            
            document.getElementById('expandedRecordTitle').textContent = record.name || recordId;
            
            const mainContent = document.getElementById('expandedRecordMain');
            mainContent.innerHTML = `
                <div class="space-y-4">
                    ${table.schema.map(field => {
                        const fieldType = FIELD_TYPES[field.type];
                        const value = record[field.id];
                        const fieldHistory = getCellHistory(recordId, field.id);
                        return `
                            <div class="border-b border-gray-200 pb-4 ${focusFieldId === field.id ? 'bg-blue-50 p-4 rounded-lg' : ''}">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-700">${field.name}</label>
                                    ${fieldHistory.length > 0 ? `
                                        <button onclick="showCellHistory('${recordId}', '${field.id}')" class="text-xs text-blue-600 hover:text-blue-800">
                                            üìù ${fieldHistory.length} ${fieldHistory.length === 1 ? 'edit' : 'edits'}
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="text-base text-gray-900">${fieldType.render(value, field.config, record)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            renderRecordSidebarContent(recordId);
            
            openModal('expandedRecordModal');
            initIcons();
        }

        function renderCompactHistoryEntry(event) {
            const timeAgo = getTimeAgo(event.published);
            let icon = 'üìù';
            
            if (event.type === 'Update' && event.object.type === 'CellEdit') {
                icon = '‚úèÔ∏è';
                return `
                    <div class="history-entry text-xs" onclick="restoreFromHistory('${event.id}')">
                        <div class="flex items-start gap-2 mb-1">
                            <span>${icon}</span>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${event.object.fieldName}</div>
                                <div class="text-gray-500">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="value-change ml-6">
                            <span class="value-old text-xs">${event.object.oldValue}</span>
                            <span class="text-gray-400">‚Üí</span>
                            <span class="value-new text-xs">${event.object.newValue}</span>
                        </div>
                        <button class="text-blue-600 hover:text-blue-800 text-xs font-medium ml-6 mt-1">
                            Restore
                        </button>
                    </div>
                `;
            } else if (event.type === 'Create') {
                icon = '‚ûï';
                return `
                    <div class="history-entry text-xs">
                        <div class="flex items-start gap-2">
                            <span>${icon}</span>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Record created</div>
                                <div class="text-gray-500">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        // ============================================================================
        // RELATIONSHIP MANAGEMENT - FIXED PROPERTY INPUT BUG
        // ============================================================================
        
        function openRelationshipEditor(fromRecordId = null) {
            state.tempRelationship = {
                from: fromRecordId,
                to: null,
                type: '',
                properties: {}
            };
            
            renderRelationshipEditor();
            openModal('relationshipEditorModal');
        }

        function renderRelationshipEditor() {
            const content = document.getElementById('relationshipEditorContent');
            const rel = state.tempRelationship;
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">From</label>
                                <select id="relationshipFrom" class="w-full">
                                    <option value="">Select record...</option>
                                    ${getAllRecordsOptions(rel.from)}
                                </select>
                            </div>
                            
                            <div class="flex items-center justify-center py-2">
                                <div class="flex-1 border-t border-gray-300"></div>
                                <div class="px-4">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 border-t border-gray-300"></div>
                            </div>
                            
                            <div>
                                <label class="form-label text-center block">Relationship</label>
                                <input 
                                    type="text" 
                                    id="relationshipType"
                                    class="w-full text-center font-medium text-lg"
                                    placeholder="e.g., 'reports to', 'works with', 'depends on'"
                                    value="${rel.type}"
                                >
                            </div>
                            
                            <div class="flex items-center justify-center py-2">
                                <div class="flex-1 border-t border-gray-300"></div>
                                <div class="px-4">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 border-t border-gray-300"></div>
                            </div>
                            
                            <div>
                                <label class="form-label">To</label>
                                <select id="relationshipTo" class="w-full">
                                    <option value="">Select record...</option>
                                    ${getAllRecordsOptions(rel.to)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="form-label mb-0">Properties (optional)</label>
                            <button onclick="addPropertyToTempRel()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                + Add property
                            </button>
                        </div>
                        <div id="propertyList" class="space-y-2">
                            ${Object.entries(rel.properties).length === 0 ? `
                                <p class="text-sm text-gray-500 text-center py-4">No properties yet</p>
                            ` : Object.entries(rel.properties).map(([key, value]) => 
                                renderPropertyEditor(key, value)
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            initIcons();
        }

        // FIXED: Property editor now maintains its own state properly
        function renderPropertyEditor(key, value) {
            const type = inferType(value);
            const propId = `prop_${key.replace(/[^a-z0-9]/gi, '_')}`;
            
            return `
                <div class="property-row">
                    <input 
                        type="text" 
                        value="${escapeHtml(key)}"
                        placeholder="Property name"
                        class="flex-1"
                        id="${propId}_key"
                        data-old-key="${escapeHtml(key)}"
                    >
                    ${getInputForType(type, value, propId, key)}
                    <button onclick="deleteTempRelProperty('${escapeHtml(key)}')" class="text-red-500 hover:text-red-700">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        function getInputForType(type, value, propId, key) {
            const safeValue = escapeHtml(String(value));
            const safeKey = escapeHtml(key);
            
            switch(type) {
                case 'boolean':
                    return `<input type="checkbox" ${value ? 'checked' : ''} id="${propId}_value" data-key="${safeKey}">`;
                case 'number':
                    return `<input type="number" value="${safeValue}" id="${propId}_value" data-key="${safeKey}" class="flex-1">`;
                case 'date':
                    return `<input type="date" value="${safeValue}" id="${propId}_value" data-key="${safeKey}" class="flex-1">`;
                default:
                    return `<input type="text" value="${safeValue}" id="${propId}_value" data-key="${safeKey}" class="flex-1">`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function inferType(value) {
            if (typeof value === 'boolean') return 'boolean';
            if (typeof value === 'number') return 'number';
            if (value && typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) return 'date';
            return 'text';
        }

        function getAllRecordsOptions(selectedId = null) {
            let html = '';
            state.tables.forEach((table, tableId) => {
                html += `<optgroup label="${table.name}">`;
                table.records.forEach(record => {
                    const label = record.name || record[table.schema[0]?.id] || record.id;
                    const value = `${tableId}:${record.id}`;
                    html += `<option value="${value}" ${value === selectedId ? 'selected' : ''}>${label}</option>`;
                });
                html += `</optgroup>`;
            });
            return html;
        }

        function addPropertyToTempRel() {
            const propName = prompt('Property name:');
            if (!propName) return;
            
            state.tempRelationship.properties[propName] = '';
            renderRelationshipEditor();
        }

        function deleteTempRelProperty(key) {
            delete state.tempRelationship.properties[key];
            renderRelationshipEditor();
        }

        function saveRelationship() {
            // Collect current property values from the form
            const propertyList = document.getElementById('propertyList');
            const propertyRows = propertyList.querySelectorAll('.property-row');
            
            state.tempRelationship.properties = {};
            
            propertyRows.forEach(row => {
                const keyInput = row.querySelector('input[id$="_key"]');
                const valueInput = row.querySelector('input[id$="_value"]');
                
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    let value = valueInput.value;
                    
                    if (valueInput.type === 'checkbox') {
                        value = valueInput.checked;
                    } else if (valueInput.type === 'number') {
                        value = parseFloat(value) || 0;
                    }
                    
                    if (key) {
                        state.tempRelationship.properties[key] = value;
                    }
                }
            });
            
            const rel = state.tempRelationship;
            
            const fromSelect = document.getElementById('relationshipFrom');
            const toSelect = document.getElementById('relationshipTo');
            const typeInput = document.getElementById('relationshipType');
            
            if (!fromSelect.value || !toSelect.value || !typeInput.value) {
                alert('Please fill in all required fields');
                return;
            }
            
            const [fromTableId, fromRecordId] = fromSelect.value.split(':');
            const [toTableId, toRecordId] = toSelect.value.split(':');
            
            const fromTable = state.tables.get(fromTableId);
            const fromRecord = fromTable.records.get(fromRecordId);
            const toTable = state.tables.get(toTableId);
            const toRecord = toTable.records.get(toRecordId);
            
            createEvent('Add', {
                id: fromRecordId,
                type: fromTable.name,
                name: fromRecord.name || fromRecord[fromTable.schema[0]?.id],
                relationship: typeInput.value,
                relationshipProperties: rel.properties,
                target: {
                    id: toRecordId,
                    type: toTable.name,
                    name: toRecord.name || toRecord[toTable.schema[0]?.id]
                }
            }, `Created ${typeInput.value} relationship from ${fromRecord.name || fromRecordId} to ${toRecord.name || toRecordId}`);
            
            closeModal('relationshipEditorModal');
            showToast(`‚úì Created relationship: ${typeInput.value}`);
        }

        // ============================================================================
        // LINK FIELD MANAGEMENT
        // ============================================================================
        
        function openLinkSelector(recordId, field) {
            const targetTableId = field.config.targetTable;
            const targetTable = state.tables.get(targetTableId);
            
            if (!targetTable) {
                alert('Target table not found');
                return;
            }
            
            const currentTable = getCurrentTable();
            const record = currentTable.records.get(recordId);
            const currentLinks = record[field.id] || [];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.innerHTML = `
                <div class="modal-container bg-white w-full max-w-md">
                    <div class="modal-header flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Link to ${targetTable.name}</h2>
                            <p class="text-sm text-gray-500 mt-1">Select records to link</p>
                        </div>
                        <button class="close-btn text-gray-400 hover:text-gray-600 transition p-2" aria-label="Close modal">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${Array.from(targetTable.records.values()).map(targetRecord => {
                                const isLinked = currentLinks.includes(targetRecord.id);
                                const displayValue = targetRecord[field.config.displayField] || targetRecord.name || targetRecord.id;
                                return `
                                    <label class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded cursor-pointer transition">
                                        <input 
                                            type="checkbox" 
                                            value="${targetRecord.id}"
                                            ${isLinked ? 'checked' : ''}
                                            class="link-checkbox"
                                        >
                                        <span>${displayValue}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="modal-footer flex justify-end gap-2">
                        <button class="cancel-btn btn btn-secondary">Cancel</button>
                        <button class="save-btn btn btn-primary">Save</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.save-btn').onclick = () => {
                const checkboxes = modal.querySelectorAll('.link-checkbox');
                const newLinks = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                updateRecord(recordId, field.id, newLinks, currentLinks);
                modal.remove();
            };
        }

        function jumpToRecord(tableId, recordId) {
            state.currentTableId = tableId;
            switchTable(tableId);
            setTimeout(() => openExpandedRecord(recordId), 100);
        }

        // ============================================================================
        // ADD/EDIT FIELD - IMPROVED
        // ============================================================================
        
        function renderFieldTypeGrid(selectedType = 'TEXT') {
            const grid = document.getElementById('fieldTypeGrid');
            grid.innerHTML = '';
            
            Object.values(FIELD_TYPES).forEach(fieldType => {
                const option = document.createElement('div');
                option.className = `field-type-option ${fieldType.id === selectedType ? 'selected' : ''}`;
                option.onclick = () => selectFieldType(fieldType.id);
                
                option.innerHTML = `
                    <div class="field-type-icon">
                        <i data-lucide="${fieldType.icon}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-sm">${fieldType.name}</div>
                    </div>
                `;
                
                grid.appendChild(option);
            });
            
            initIcons();
        }
        
        function selectFieldType(typeId) {
            document.getElementById('newFieldType').value = typeId;
            
            // Update visual selection
            document.querySelectorAll('.field-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateFieldTypeConfig();
        }
        
        function openAddFieldModal() {
            state.editingFieldId = null;
            document.getElementById('fieldModalTitle').textContent = 'Add Field';
            document.getElementById('saveAddFieldBtn').textContent = 'Add Field';
            document.getElementById('newFieldName').value = '';
            
            renderFieldTypeGrid('TEXT');
            
            // Populate link to table dropdown
            const linkSelect = document.getElementById('linkToTable');
            linkSelect.innerHTML = '';
            state.tables.forEach((table, tableId) => {
                if (tableId !== state.currentTableId) {
                    linkSelect.innerHTML += `<option value="${tableId}">${table.name}</option>`;
                }
            });
            
            // Populate lookup field dropdowns
            populateLookupDropdowns();
            
            updateFieldTypeConfig();
            openModal('addFieldModal');
            setTimeout(() => document.getElementById('newFieldName').focus(), 100);
        }
        
        function populateLookupDropdowns() {
            const table = getCurrentTable();
            if (!table) return;
            
            // Populate link field dropdown (only show LINK_TO_RECORD fields)
            const linkFieldSelect = document.getElementById('lookupLinkField');
            linkFieldSelect.innerHTML = '<option value="">Select a link field...</option>';
            
            table.schema.forEach(field => {
                if (field.type === 'LINK_TO_RECORD') {
                    linkFieldSelect.innerHTML += `<option value="${field.id}">${field.name}</option>`;
                }
            });
            
            // When link field changes, update target field options
            linkFieldSelect.onchange = updateLookupTargetFields;
        }
        
        function updateLookupTargetFields() {
            const linkFieldId = document.getElementById('lookupLinkField').value;
            const targetFieldSelect = document.getElementById('lookupTargetField');
            
            if (!linkFieldId) {
                targetFieldSelect.innerHTML = '<option value="">Select a field to lookup...</option>';
                return;
            }
            
            const table = getCurrentTable();
            const linkField = table.schema.find(f => f.id === linkFieldId);
            if (!linkField || !linkField.config.targetTable) return;
            
            const targetTable = state.tables.get(linkField.config.targetTable);
            if (!targetTable) return;
            
            targetFieldSelect.innerHTML = '<option value="">Select a field to lookup...</option>';
            targetTable.schema.forEach(field => {
                // Don't allow lookup of lookup fields (could cause circular references)
                if (field.type !== 'LOOKUP' && field.type !== 'LINK_TO_RECORD') {
                    targetFieldSelect.innerHTML += `<option value="${field.id}">${field.name}</option>`;
                }
            });
        }

        function editField(fieldId) {
            const table = getCurrentTable();
            const field = table.schema.find(f => f.id === fieldId);
            if (!field) return;
            
            state.editingFieldId = fieldId;
            document.getElementById('fieldModalTitle').textContent = 'Edit Field';
            document.getElementById('saveAddFieldBtn').textContent = 'Save Changes';
            document.getElementById('newFieldName').value = field.name;
            
            renderFieldTypeGrid(field.type);
            
            const linkSelect = document.getElementById('linkToTable');
            linkSelect.innerHTML = '';
            state.tables.forEach((table, tableId) => {
                if (tableId !== state.currentTableId) {
                    const selected = field.config?.targetTable === tableId ? 'selected' : '';
                    linkSelect.innerHTML += `<option value="${tableId}" ${selected}>${table.name}</option>`;
                }
            });
            
            populateLookupDropdowns();
            
            // If editing a lookup field, set the values
            if (field.type === 'LOOKUP' && field.config) {
                if (field.config.linkField) {
                    document.getElementById('lookupLinkField').value = field.config.linkField;
                    updateLookupTargetFields();
                    if (field.config.lookupField) {
                        setTimeout(() => {
                            document.getElementById('lookupTargetField').value = field.config.lookupField;
                        }, 50);
                    }
                }
            }
            
            updateFieldTypeConfig();
            openModal('addFieldModal');
            setTimeout(() => document.getElementById('newFieldName').focus(), 100);
        }

        function updateFieldTypeConfig() {
            const fieldType = document.getElementById('newFieldType').value;
            const linkConfigSection = document.getElementById('linkToRecordConfig');
            const lookupConfigSection = document.getElementById('lookupConfig');
            
            // Hide all config sections first
            linkConfigSection.classList.remove('visible');
            lookupConfigSection.classList.remove('visible');
            
            // Show appropriate config section
            if (fieldType === 'LINK_TO_RECORD') {
                linkConfigSection.classList.add('visible');
            } else if (fieldType === 'LOOKUP') {
                lookupConfigSection.classList.add('visible');
            }
        }

        function saveNewField() {
            const name = document.getElementById('newFieldName').value.trim();
            const type = document.getElementById('newFieldType').value;
            
            if (!name) {
                alert('Please enter a field name');
                return;
            }
            
            const table = getCurrentTable();
            
            if (state.editingFieldId) {
                // Edit existing field
                const field = table.schema.find(f => f.id === state.editingFieldId);
                if (!field) return;
                
                field.name = name;
                field.type = type;
                
                if (type === 'LINK_TO_RECORD') {
                    const targetTable = document.getElementById('linkToTable').value;
                    if (!targetTable) {
                        alert('Please select a table to link to');
                        return;
                    }
                    field.config = {
                        targetTable: targetTable,
                        displayField: 'name',
                        allowMultiple: true
                    };
                } else if (type === 'LOOKUP') {
                    const linkField = document.getElementById('lookupLinkField').value;
                    const lookupField = document.getElementById('lookupTargetField').value;
                    if (!linkField || !lookupField) {
                        alert('Please select both a link field and a field to lookup');
                        return;
                    }
                    field.config = {
                        linkField: linkField,
                        lookupField: lookupField
                    };
                } else {
                    const fieldType = FIELD_TYPES[type];
                    if (fieldType.needsConfig) {
                        field.config = fieldType.defaultConfig;
                    } else {
                        field.config = {};
                    }
                }
                
                createEvent('Update', {
                    type: 'Field',
                    fieldId: field.id,
                    fieldName: name,
                    fieldType: type
                }, `Updated field "${name}"`);
                
                showToast(`‚úì Updated field: ${name}`);
            } else {
                // Add new field
                const fieldId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                
                if (table.schema.find(f => f.id === fieldId)) {
                    alert('A field with this name already exists');
                    return;
                }
                
                const fieldType = FIELD_TYPES[type];
                const newField = {
                    id: fieldId,
                    name: name,
                    type: type,
                    width: '150px',
                    config: {}
                };
                
                if (type === 'LINK_TO_RECORD') {
                    const targetTable = document.getElementById('linkToTable').value;
                    if (!targetTable) {
                        alert('Please select a table to link to');
                        return;
                    }
                    newField.config = {
                        targetTable: targetTable,
                        displayField: 'name',
                        allowMultiple: true
                    };
                } else if (type === 'LOOKUP') {
                    const linkField = document.getElementById('lookupLinkField').value;
                    const lookupField = document.getElementById('lookupTargetField').value;
                    if (!linkField || !lookupField) {
                        alert('Please select both a link field and a field to lookup');
                        return;
                    }
                    newField.config = {
                        linkField: linkField,
                        lookupField: lookupField
                    };
                } else if (fieldType.needsConfig) {
                    newField.config = fieldType.defaultConfig;
                }
                
                table.schema.push(newField);
                
                // Add default values to existing records (LOOKUP fields don't store data)
                const oldSuppressState = state.suppressEvents;
                state.suppressEvents = true;
                table.records.forEach(record => {
                    if (type !== 'LOOKUP') {
                        record[fieldId] = fieldType.defaultValue;
                    }
                });
                state.suppressEvents = oldSuppressState;
                
                createEvent('Create', {
                    type: 'Field',
                    tableId: table.id,
                    fieldId: fieldId,
                    fieldName: name,
                    fieldType: type,
                    affectedRecords: table.records.size
                }, `Added field "${name}" (${fieldType.name}) to ${table.name}`);
                
                showToast(`‚úì Added field: ${name}`);
            }
            
            closeModal('addFieldModal');
            document.getElementById('newFieldName').value = '';
            renderCurrentView();
        }

        // ============================================================================
        // FILTERS
        // ============================================================================
        
        function openFilterModal() {
            renderFilterBuilder();
            openModal('filterModal');
        }

        function renderFilterBuilder() {
            const view = getCurrentView();
            const container = document.getElementById('filterRulesContainer');
            
            if (!view.filters || view.filters.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No filters applied</p>';
                return;
            }
            
            const schema = getCurrentTable().schema;
            container.innerHTML = view.filters.map((filter, index) => `
                <div class="filter-row">
                    <select onchange="updateFilterField(${index}, this.value)">
                        ${schema.map(field => `
                            <option value="${field.id}" ${filter.field === field.id ? 'selected' : ''}>
                                ${field.name}
                            </option>
                        `).join('')}
                    </select>
                    <select onchange="updateFilterOperator(${index}, this.value)">
                        <option value="equals" ${filter.operator === 'equals' ? 'selected' : ''}>equals</option>
                        <option value="not_equals" ${filter.operator === 'not_equals' ? 'selected' : ''}>not equals</option>
                        <option value="contains" ${filter.operator === 'contains' ? 'selected' : ''}>contains</option>
                        <option value="greater_than" ${filter.operator === 'greater_than' ? 'selected' : ''}>greater than</option>
                        <option value="less_than" ${filter.operator === 'less_than' ? 'selected' : ''}>less than</option>
                        <option value="is_empty" ${filter.operator === 'is_empty' ? 'selected' : ''}>is empty</option>
                        <option value="is_not_empty" ${filter.operator === 'is_not_empty' ? 'selected' : ''}>is not empty</option>
                    </select>
                    <input 
                        type="text" 
                        value="${filter.value || ''}"
                        onchange="updateFilterValue(${index}, this.value)"
                        ${filter.operator === 'is_empty' || filter.operator === 'is_not_empty' ? 'disabled' : ''}
                    >
                    <button onclick="removeFilter(${index})" class="text-red-500 hover:text-red-700" aria-label="Remove filter">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            initIcons();
        }

        function addFilterRule() {
            const view = getCurrentView();
            const schema = getCurrentTable().schema;
            
            if (!view.filters) view.filters = [];
            
            view.filters.push({
                field: schema[0].id,
                operator: 'equals',
                value: ''
            });
            
            renderFilterBuilder();
        }

        function updateFilterField(index, fieldId) {
            const view = getCurrentView();
            view.filters[index].field = fieldId;
        }

        function updateFilterOperator(index, operator) {
            const view = getCurrentView();
            view.filters[index].operator = operator;
            renderFilterBuilder();
        }

        function updateFilterValue(index, value) {
            const view = getCurrentView();
            view.filters[index].value = value;
        }

        function removeFilter(index) {
            const view = getCurrentView();
            view.filters.splice(index, 1);
            renderFilterBuilder();
        }

        function applyFilters() {
            const view = getCurrentView();
            const table = getCurrentTable();
            
            createEvent('Update', {
                type: 'View',
                viewId: view.id,
                filters: view.filters
            }, `Updated filters for view "${view.name}"`);
            
            closeModal('filterModal');
            renderCurrentView();
            showToast('‚úì Filters applied');
        }

        function clearFilters() {
            const view = getCurrentView();
            view.filters = [];
            renderFilterBuilder();
        }

        // ============================================================================
        // MODAL MANAGEMENT
        // ============================================================================
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            state.modalStack.push(modalId);
            
            setTimeout(() => {
                const firstInput = modal.querySelector('input[type="text"], select');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            state.modalStack = state.modalStack.filter(id => id !== modalId);
        }

        function closeTopModal() {
            if (state.modalStack.length > 0) {
                const topModal = state.modalStack[state.modalStack.length - 1];
                closeModal(topModal);
            }
        }

        // ============================================================================
        // KEYBOARD SHORTCUTS
        // ============================================================================
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    if (state.modalStack.length > 0) {
                        closeTopModal();
                    } else if (document.getElementById('historyPanel').classList.contains('open')) {
                        document.getElementById('historyPanel').classList.remove('open');
                    }
                }
                
                if ((e.metaKey || e.ctrlKey) && e.key === 'h') {
                    e.preventDefault();
                    document.getElementById('historyPanel').classList.toggle('open');
                    if (document.getElementById('historyPanel').classList.contains('open')) {
                        renderHistory();
                    }
                }
                
                if ((e.metaKey || e.ctrlKey) && e.key === 'n' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('addRecordBtn').click();
                }
                
                if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'N') {
                    e.preventDefault();
                    document.getElementById('addTableBtn').click();
                }
                
                if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('filterBtn').click();
                }
            });
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================
        
        function formatPropertyName(key) {
            return key
                .replace(/([A-Z])/g, ' $1')
                .replace(/_/g, ' ')
                .replace(/^./, str => str.toUpperCase());
        }

        function formatPropertyValue(value) {
            if (typeof value === 'boolean') return value ? '‚úì Yes' : '‚úó No';
            if (typeof value === 'number' && value > 1000) return `$${value.toLocaleString()}`;
            if (value && typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                return new Date(value).toLocaleDateString();
            }
            return value;
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function initIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function exportJSON() {
            const data = {
                tables: Array.from(state.tables.entries()).map(([id, table]) => ({
                    id,
                    ...table,
                    records: Array.from(table.records.values()),
                    views: Array.from(table.views.values())
                })),
                eventStream: state.eventStream
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workbase-export.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('‚úì Exported data');
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        
        function setupEventListeners() {
            document.getElementById('addRecordBtn').addEventListener('click', () => {
                const table = getCurrentTable();
                const newRecord = { id: `rec_${Date.now()}` };
                table.schema.forEach(field => {
                    newRecord[field.id] = FIELD_TYPES[field.type].defaultValue;
                });
                table.records.set(newRecord.id, newRecord);
                
                createEvent('Create', {
                    type: 'Record',
                    tableId: table.id,
                    recordId: newRecord.id
                }, `Created new record in ${table.name}`);
                
                renderCurrentView();
                showToast('‚úì Added record');
            });
            
            document.getElementById('addFieldBtn').addEventListener('click', openAddFieldModal);
            document.getElementById('addTableBtn').addEventListener('click', () => openModal('addTableModal'));
            document.getElementById('exportBtn').addEventListener('click', exportJSON);
            document.getElementById('historyBtn').addEventListener('click', () => {
                document.getElementById('historyPanel').classList.add('open');
                renderHistory();
            });
            document.getElementById('filterBtn').addEventListener('click', openFilterModal);
            document.getElementById('addViewBtn').addEventListener('click', () => openModal('addViewModal'));
            
            document.getElementById('closeHistoryBtn').addEventListener('click', () => {
                document.getElementById('historyPanel').classList.remove('open');
            });
            
            document.getElementById('closeExpandedRecordBtn').addEventListener('click', () => closeModal('expandedRecordModal'));
            document.getElementById('closeRelationshipEditorBtn').addEventListener('click', () => closeModal('relationshipEditorModal'));
            document.getElementById('cancelRelationshipBtn').addEventListener('click', () => closeModal('relationshipEditorModal'));
            document.getElementById('saveRelationshipBtn').addEventListener('click', saveRelationship);
            
            document.getElementById('closeAddFieldBtn').addEventListener('click', () => closeModal('addFieldModal'));
            document.getElementById('cancelAddFieldBtn').addEventListener('click', () => closeModal('addFieldModal'));
            document.getElementById('saveAddFieldBtn').addEventListener('click', saveNewField);
            
            document.getElementById('historySearch').addEventListener('input', (e) => {
                state.historySearch = e.target.value;
                renderHistory();
            });
            
            document.getElementById('historyFilter').addEventListener('change', (e) => {
                state.historyFilter = e.target.value;
                renderHistory();
            });
            
            document.getElementById('closeFilterBtn').addEventListener('click', () => closeModal('filterModal'));
            document.getElementById('addFilterRuleBtn').addEventListener('click', addFilterRule);
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            document.getElementById('closeAddViewBtn').addEventListener('click', () => closeModal('addViewModal'));
            document.getElementById('cancelAddViewBtn').addEventListener('click', () => closeModal('addViewModal'));
            document.getElementById('saveAddViewBtn').addEventListener('click', () => {
                const name = document.getElementById('newViewName').value.trim();
                if (!name) {
                    alert('Please enter a view name');
                    return;
                }
                
                createView(state.currentTableId, name, {});
                closeModal('addViewModal');
                document.getElementById('newViewName').value = '';
                renderViewTabs();
                showToast(`‚úì Created view: ${name}`);
            });
            
            document.getElementById('closeAddTableBtn').addEventListener('click', () => closeModal('addTableModal'));
            document.getElementById('cancelAddTableBtn').addEventListener('click', () => closeModal('addTableModal'));
            document.getElementById('saveAddTableBtn').addEventListener('click', () => {
                const name = document.getElementById('newTableName').value.trim();
                const icon = document.getElementById('newTableIcon').value.trim() || 'üìä';
                
                if (!name) {
                    alert('Please enter a table name');
                    return;
                }
                
                const tableId = createTable(name, icon);
                closeModal('addTableModal');
                document.getElementById('newTableName').value = '';
                document.getElementById('newTableIcon').value = '';
                
                renderTableTabs();
                switchTable(tableId);
                showToast(`‚úì Created table: ${name}`);
            });
        }

        // ============================================================================
        // INITIALIZE APP
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
