<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workbase - Enhanced Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 64px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            background: #f7f8fa;
            color: #1f2937;
        }
        
        /* LAYOUT */
        .app-container {
            display: grid;
            grid-template-areas: "sidebar header" "sidebar main";
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease;
            background: #f7f8fa;
        }
        .app-container.sidebar-collapsed { grid-template-columns: var(--sidebar-collapsed-width) 1fr; }
        .app-sidebar {
            grid-area: sidebar;
            background: #1a1d24;
            color: white;
            border-right: 1px solid #2a2e38;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .app-header {
            grid-area: header;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            z-index: 10;
        }
        .app-main { grid-area: main; overflow: auto; background: #f7f8fa; }
        
        /* SIDEBAR */
        .sidebar-header {
            padding: 18px 16px 18px 20px;
            border-bottom: 1px solid #2a2e38;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .sidebar-collapsed .sidebar-header { padding: 18px 10px; justify-content: center; }
        .sidebar-brand { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; transition: opacity 0.2s; }
        .sidebar-collapsed .sidebar-brand { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-toggle {
            background: #252931;
            border: 1px solid #2f343d;
            color: #9ca3af;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-toggle:hover { background: #2f343d; color: #e5e7eb; }
        .sidebar-section { padding: 16px 12px 12px 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
            padding: 8px 12px 6px;
            margin-bottom: 6px;
            transition: opacity 0.2s;
        }
        .sidebar-collapsed .sidebar-section-title { opacity: 0; height: 0; overflow: hidden; margin: 0; }
        
        .set-item {
            margin-bottom: 4px;
        }
        
        .set-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            color: #9ca3af;
        }
        .set-header:hover { background: #252931; color: #e5e7eb; }
        .set-header.active { background: #2563eb; color: #ffffff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35); }
        .set-icon { font-size: 18px; flex-shrink: 0; }
        .set-name { flex: 1; transition: opacity 0.2s; font-weight: 600; letter-spacing: -0.01em; }
        .set-expand-icon { 
            font-size: 12px; 
            transition: transform 0.2s;
            opacity: 0.7;
        }
        .set-item.expanded .set-expand-icon { transform: rotate(90deg); }
        .sidebar-collapsed .set-name { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-collapsed .set-expand-icon { display: none; }
        .sidebar-collapsed .set-header { justify-content: center; padding: 10px; }
        
        .views-list {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            margin-left: 32px;
            margin-top: 6px;
        }
        .set-item.expanded .views-list {
            max-height: 500px;
            opacity: 1;
        }
        .sidebar-collapsed .views-list { display: none; }
        
        .view-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
        }
        .view-item:hover { background: #252931; color: #e5e7eb; }
        .view-item.active { background: #2f343d; color: #ffffff; font-weight: 600; }
        .view-item-icon { font-size: 12px; opacity: 0.8; }
        
        .add-view-btn {
            padding: 6px 12px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
            margin-top: 6px;
        }
        .add-view-btn:hover { background: #252931; color: #e5e7eb; }

        .new-set-btn {
            margin-top: auto;
            padding: 14px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: color 0.15s ease;
        }
        .new-set-btn:hover { color: #9ca3af; }
        
        /* TOOLBAR */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .view-type-switcher {
            display: flex;
            gap: 8px;
        }

        .view-type-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .view-type-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }
        .view-type-btn.active { background: #f3f4f6; color: #1f2937; border-color: #d1d5db; }
        
        /* CELLS */
        .cell-editable {
            min-height: 36px;
            padding: 12px 16px;
            cursor: text;
            border-right: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            position: relative;
        }
        .cell-editable:hover {
            background: linear-gradient(to right, transparent, rgba(59, 130, 246, 0.03), transparent);
            border-left: 2px solid rgba(59, 130, 246, 0.2);
        }
        .cell-editable:focus {
            outline: none;
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            border-radius: 4px;
        }
        .cell-recently-changed { animation: flash-yellow 0.5s ease-out; }
        @keyframes flash-yellow { 0% { background-color: #fef3c7; } 100% { background-color: transparent; } }
        
        /* TABLE HEADERS */
        .column-header {
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
            padding: 12px 16px;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #e8e8e8;
            cursor: pointer;
            transition: background 0.15s;
            user-select: none;
            position: relative;
        }
        .column-header:hover { background: linear-gradient(180deg, #f5f5f5 0%, #eeeeee 100%); }
        .column-header[data-type="TEXT"] { border-top: 3px solid #3b82f6; }
        .column-header[data-type="NUMBER"] { border-top: 3px solid #10b981; }
        .column-header[data-type="CURRENCY"] { border-top: 3px solid #059669; }
        .column-header[data-type="DATE"] { border-top: 3px solid #ec4899; }
        .column-header[data-type="EMAIL"] { border-top: 3px solid #6366f1; }
        .column-header[data-type="URL"] { border-top: 3px solid #8b5cf6; }
        .column-header[data-type="SINGLE_SELECT"] { border-top: 3px solid #f59e0b; }
        .column-header[data-type="CHECKBOX"] { border-top: 3px solid #8b5cf6; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
            min-width: 140px;
            white-space: nowrap;
        }
        tbody tr { border-bottom: 1px solid #f3f4f6; transition: background-color 0.1s ease; }
        tbody tr:hover { background: #f9fafb; }
        tbody tr:last-child { border-bottom: none; }
        td {
            padding: 16px;
            font-size: 14px;
            color: #1f2937;
            vertical-align: middle;
            min-width: 140px;
            white-space: nowrap;
        }
        td:first-child {
            color: #9ca3af;
            font-weight: 600;
            font-size: 13px;
            min-width: 60px;
        }
        tr:hover { background-color: #fafafa; }
        tr:hover .row-number { background: #3b82f6; color: white; cursor: pointer; }
        .row-number { transition: all 0.2s ease; }

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* CARD VIEW */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #3b82f6;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .card-field {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .card-field-label {
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .card-field-value {
            color: #111827;
        }
        
        /* KANBAN VIEW */
        .kanban-board {
            display: flex;
            gap: 16px;
            padding: 20px;
            overflow-x: auto;
            min-height: calc(100vh - 200px);
        }
        
        .kanban-column {
            min-width: 300px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }
        
        .kanban-column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e5e7eb;
        }
        
        .kanban-column-title {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }
        
        .kanban-column-count {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .kanban-cards {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 100px;
        }
        
        .kanban-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            cursor: move;
            transition: all 0.15s ease;
        }
        
        .kanban-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .kanban-column.drag-over {
            background: #e0f2fe;
        }
        
        .kanban-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-size: 14px;
        }
        
        /* CONTEXT MENU */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }
        .context-menu-item {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover { background: #f3f4f6; }
        .context-menu-item.danger:hover { background: #fee2e2; color: #dc2626; }
        .context-menu-separator { height: 1px; background: #e5e7eb; margin: 4px 0; }
        
        /* MODALS */
        .modal-overlay { backdrop-filter: blur(2px); animation: fadeIn 0.2s ease; }
        .modal-container { border-radius: 12px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 24px 24px 16px 24px; border-bottom: 1px solid #f0f0f0; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f0f0f0; background: #fafafa; }
        .config-section { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease; margin-top: 0; }
        .config-section.visible { max-height: 500px; opacity: 1; margin-top: 16px; }
        
        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
        .btn-secondary { background: white; border: 1px solid #e5e7eb; color: #374151; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02); }
        .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-green { background-color: #d1fae5; color: #065f46; }
        .badge-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-red { background-color: #fee2e2; color: #991b1b; }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-purple { background-color: #e9d5ff; color: #6b21a8; }
        .badge-gray { background-color: #f3f4f6; color: #374151; }
        .badge-cyan { background-color: #cffafe; color: #155e75; }
        .badge-pink { background-color: #fce7f3; color: #9f1239; }
        
        /* FIELD TYPE GRID */
        .field-type-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 400px; overflow-y: auto; }
        .field-type-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
        }
        .field-type-option:hover { border-color: #3b82f6; background: #f0f9ff; }
        .field-type-option.selected { border-color: #3b82f6; background: #dbeafe; }
        .field-type-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 6px;
            flex-shrink: 0;
            font-size: 18px;
        }
        .field-type-option.selected .field-type-icon { background: #3b82f6; color: white; }
        
        /* FILTER BUILDER */
        .filter-group { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .filter-group-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .filter-operator-toggle { display: flex; background: white; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; }
        .filter-operator-toggle button {
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-operator-toggle button.active { background: #3b82f6; color: white; }
        .filter-rule { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px; }
        
        /* UTILITIES */
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-hint { font-size: 12px; color: #6b7280; margin-top: 6px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="url"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.15s ease;
            background: white;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            animation: slideInToast 0.3s ease;
        }
        @keyframes slideInToast { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 420px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .side-panel.open { transform: translateX(0); }
        
        .option-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .option-row input { flex: 1; }
        .color-picker { display: flex; gap: 4px; flex-wrap: wrap; }
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #1e293b; }
        
        .field-editor { border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; transition: all 0.15s; }
        .field-editor:hover { border-color: #d1d5db; background: #fafafa; }
        .field-editor:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .field-editor input, .field-editor textarea, .field-editor select { width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 14px; }
        
        .record-tabs { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 24px; background: #fafafa; }
        .record-tab {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }
        .record-tab:hover { color: #374151; }
        .record-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        
        .json-tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            background: transparent;
            border: none;
            transition: all 0.15s ease;
        }
        .json-tab:hover { color: #374151; background: #f9fafb; }
        .json-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        
        .json-key { color: #b45309; font-weight: 600; }
        .json-string { color: #15803d; }
        .json-number { color: #1e40af; }
        .json-boolean { color: #7c2d12; }
        .json-null { color: #991b1b; font-style: italic; }
        
        #jsonContent {
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .profile-selector { display: flex; gap: 8px; padding: 12px 0; overflow-x: auto; }
        .profile-tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid #e5e7eb;
            background: white;
            white-space: nowrap;
        }
        .profile-tab:hover { background: #f3f4f6; }
        .profile-tab.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        
        .history-entry {
            border-left: 3px solid #e5e7eb;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.15s ease;
            cursor: pointer;
            border-radius: 4px;
        }
        .history-entry:hover { border-left-color: #3b82f6; background-color: #f9fafb; }

        .mobile-sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 30;
        }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 240px; }
            .app-container { grid-template-areas: "header" "main"; grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .app-sidebar {
                position: fixed;
                inset: 0 auto 0 0;
                width: var(--sidebar-width);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 40;
            }
            .mobile-sidebar-overlay { display: none; }
            .mobile-layout.sidebar-open-mobile .app-sidebar { transform: translateX(0); box-shadow: 8px 0 24px rgba(0,0,0,0.18); }
            .mobile-layout.sidebar-open-mobile .mobile-sidebar-overlay { display: block; }
            .app-header { position: sticky; top: 0; z-index: 20; }
            .toolbar { flex-direction: column; align-items: flex-start; gap: 12px; }
            .toolbar .view-type-switcher { width: 100%; overflow-x: auto; padding-bottom: 4px; }
            .toolbar-actions { width: 100%; flex-wrap: wrap; }
            .toolbar-actions button { flex: 1 1 calc(50% - 8px); min-width: 140px; }
            .cards-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
            .kanban-board { min-height: auto; }
        }

        @media (max-width: 640px) {
            .toolbar-actions button { flex: 1 1 100%; }
            .cards-grid { grid-template-columns: 1fr; }
            .kanban-column { min-width: 260px; }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">Workbase</div>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Sets</div>
                <div id="setsList"></div>
                <button onclick="openAddSetModal()" class="new-set-btn">
                    <span class="set-icon">‚ûï</span>
                    <span class="set-name">New Set</span>
                </button>
            </div>
        </div>

        <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay" onclick="closeMobileSidebar()"></div>

        <!-- Header -->
        <div class="app-header">
            <div class="toolbar">
                <div class="flex items-center gap-3">
                    <div class="view-type-switcher">
                        <button class="view-type-btn active" data-type="grid" onclick="switchViewType('grid')">
                            üî≤ Grid
                        </button>
                        <button class="view-type-btn" data-type="card" onclick="switchViewType('card')">
                            üÉè Card
                        </button>
                        <button class="view-type-btn" data-type="kanban" onclick="switchViewType('kanban')">
                            üìä Kanban
                        </button>
                    </div>
                    <button id="filterBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Filter
                    </button>
                    <button id="historyBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        History
                    </button>
                </div>
                <div class="flex items-center gap-2 toolbar-actions">
                    <button id="addRecordBtn" class="btn btn-primary btn-sm">+ Add Record</button>
                    <button id="addFieldBtn" class="btn btn-secondary btn-sm">+ Add Field</button>
                    <button id="viewJsonBtn" class="btn btn-secondary btn-sm">View JSON</button>
                    <button id="exportBtn" class="btn btn-secondary btn-sm">Export</button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="app-main">
            <div id="viewContainer"></div>
        </div>
    </div>

    <!-- All Modals from previous version -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Confirm Action</h2>
            </div>
            <div class="modal-body">
                <p class="text-gray-700" id="confirmMessage"></p>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmOkBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="expandedRecordModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-4 flex-1">
                    <h2 class="text-2xl font-bold text-gray-900" id="expandedRecordTitle">Record Details</h2>
                    <div class="profile-selector" id="recordProfileSelector"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="toggleHistorySidebarBtn" class="btn btn-secondary btn-sm">Hide History</button>
                    <button id="closeExpandedRecordBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    <div id="expandedRecordMainWrapper" class="md:col-span-2 p-6 overflow-y-auto border-r border-gray-200">
                        <div id="expandedRecordMain"></div>
                    </div>
                    <div id="expandedRecordHistoryColumn" class="overflow-hidden bg-gray-50 flex flex-col">
                        <div class="record-tabs">
                            <div class="record-tab active" data-tab="history" onclick="switchRecordTab('history')">History</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6" id="expandedRecordSidebar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Filter View</h2>
                    <p class="text-sm text-gray-500 mt-1">Create advanced filter conditions</p>
                </div>
                <button id="closeFilterBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body">
                <div id="filterGroupsContainer"></div>
                <button id="addFilterGroupBtn" class="btn btn-secondary btn-sm mt-4">+ Add Filter Group</button>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="clearFiltersBtn" class="btn btn-secondary">Clear All</button>
                <button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button>
            </div>
        </div>
    </div>

    <div id="addFieldModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Add Field</h2>
                    <p class="text-sm text-gray-500 mt-1">Create a new field for your set</p>
                </div>
                <button id="closeAddFieldBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto modal-body space-y-5">
                <div>
                    <label class="form-label">Field Name</label>
                    <input type="text" id="newFieldName" placeholder="e.g., Status, Amount, Contact Person" autofocus>
                    <p class="form-hint">A descriptive name for your field</p>
                </div>
                <div>
                    <label class="form-label">Field Type</label>
                    <div id="fieldTypeGrid" class="field-type-grid"></div>
                    <input type="hidden" id="newFieldType" value="TEXT">
                </div>
                <div id="singleSelectConfig" class="config-section">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <label class="form-label">Options</label>
                        <div id="selectOptionsList" class="space-y-2 mb-3"></div>
                        <button onclick="addSelectOption()" class="btn btn-secondary btn-sm">+ Add Option</button>
                    </div>
                </div>
                <div id="linkToRecordConfig" class="config-section">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <label class="form-label">Link to Set</label>
                        <select id="linkToSet"></select>
                        <p class="form-hint">Select which set to link to</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddFieldBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddFieldBtn" class="btn btn-primary">Add Field</button>
            </div>
        </div>
    </div>

    <div id="addSetModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Create Set</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">Set Name</label>
                    <input type="text" id="newSetName" placeholder="e.g., Projects, Contacts">
                </div>
                <div>
                    <label class="form-label">Icon (emoji)</label>
                    <input type="text" id="newSetIcon" placeholder="üìä" maxlength="2">
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddSetBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddSetBtn" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <div id="addViewModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Create View</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">View Name</label>
                    <input type="text" id="newViewName" placeholder="e.g., Active Items">
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelAddViewBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveAddViewBtn" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <div id="kanbanConfigModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-md">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Configure Kanban</h2>
            </div>
            <div class="modal-body space-y-4">
                <div>
                    <label class="form-label">Group By Field</label>
                    <select id="kanbanGroupField"></select>
                    <p class="form-hint">Select a single-select field to group records by</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-2">
                <button id="cancelKanbanConfigBtn" class="btn btn-secondary">Cancel</button>
                <button id="saveKanbanConfigBtn" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <div id="historyPanel" class="side-panel">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold">Edit History</h3>
                    <p class="text-sm opacity-90 mt-1">Full audit trail</p>
                </div>
                <button id="closeHistoryBtn" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <input type="text" id="historySearch" class="w-full text-gray-900 rounded-lg" placeholder="Search history...">
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="historyContent"></div>
    </div>

    <!-- JSON Viewer Modal -->
    <div id="jsonViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50">
        <div class="modal-container bg-white w-full max-w-6xl h-[90vh] max-h-[90vh] overflow-hidden flex flex-col">
            <div class="modal-header flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">JSON Data</h2>
                    <p class="text-sm text-gray-500 mt-1">View the complete data structure</p>
                </div>
                <button id="closeJsonViewerBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex border-b border-gray-200">
                <button class="json-tab active" data-tab="all" onclick="switchJsonTab('all')">All Data</button>
                <button class="json-tab" data-tab="sets" onclick="switchJsonTab('sets')">Sets</button>
                <button class="json-tab" data-tab="current" onclick="switchJsonTab('current')">Current Set</button>
                <button class="json-tab" data-tab="events" onclick="switchJsonTab('events')">Event Stream</button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <pre id="jsonContent" class="p-6 overflow-auto h-full text-sm bg-gray-50 font-mono"></pre>
                <button id="copyJsonBtn" class="absolute top-4 right-4 btn btn-secondary btn-sm">
                    üìã Copy
                </button>
            </div>
        </div>
    </div>

    <script>
        // STATE
        const state = {
            sets: new Map(),
            currentSetId: null,
            currentViewId: null,
            currentProfileId: 'default',
            eventStream: [],
            eventIdCounter: 1,
            currentUser: { type: 'Person', id: 'user_1', name: 'User' },
            operatorSet: {},
            interpretationRules: [],
            sidebarCollapsed: false,
            sidebarOpenMobile: false,
            modalStack: [],
            currentRecordTab: 'history',
            recordHistoryVisible: true,
            confirmCallback: null,
            selectOptions: [{ value: 'Option 1', color: 'blue' }],
            expandedSets: new Set(),
            draggedRecord: null
        };

        const FIELD_TYPES = {
            TEXT: { id: 'TEXT', name: 'Single Line Text', defaultValue: '', icon: 'üìù' },
            LONG_TEXT: { id: 'LONG_TEXT', name: 'Long Text', defaultValue: '', icon: 'üìÑ' },
            NUMBER: { id: 'NUMBER', name: 'Number', defaultValue: 0, icon: '#Ô∏è‚É£' },
            CURRENCY: { id: 'CURRENCY', name: 'Currency', defaultValue: 0, icon: 'üíµ' },
            DATE: { id: 'DATE', name: 'Date', defaultValue: '', icon: 'üìÖ' },
            EMAIL: { id: 'EMAIL', name: 'Email', defaultValue: '', icon: 'üìß' },
            URL: { id: 'URL', name: 'URL', defaultValue: '', icon: 'üîó' },
            PHONE: { id: 'PHONE', name: 'Phone', defaultValue: '', icon: 'üìû' },
            SINGLE_SELECT: { id: 'SINGLE_SELECT', name: 'Single Select', defaultValue: '', icon: 'üéØ', needsConfig: true },
            CHECKBOX: { id: 'CHECKBOX', name: 'Checkbox', defaultValue: false, icon: '‚òëÔ∏è' },
            CONNECTION: { id: 'CONNECTION', name: 'Connection', defaultValue: [], icon: 'ü™¢', needsConfig: true }
        };

        const EO_OPERATOR_SET = {
            INS: { id: 'INS', name: 'Instantiate', description: 'Create a new object that did not exist before.' },
            DES: { id: 'DES', name: 'Designate', description: 'Assign a name, ID, label, alias, or classification.' },
            SEG: { id: 'SEG', name: 'Segment', description: 'Change boundaries, structure, or partition membership.' },
            CON: { id: 'CON', name: 'Connect', description: 'Create or remove a connection between objects.' },
            ALT: { id: 'ALT', name: 'Alternate', description: 'Toggle or switch between mutually exclusive states.' },
            SYN: { id: 'SYN', name: 'Synthesize', description: 'Combine two or more objects into a new unified whole.' },
            SUP: { id: 'SUP', name: 'Superposition', description: 'Hold contradictory states as simultaneously true without resolving them.' },
            REC: { id: 'REC', name: 'Recurse', description: 'Introduce a new layer of logic, rules, or self-reference.' },
            NUL: { id: 'NUL', name: 'Nullify', description: 'Declare absence, deletion, or erasure.' }
        };

        // INITIALIZATION
        function initializeApp() {
            state.operatorSet = EO_OPERATOR_SET;
            initializeOperatorRules();
            createSampleData();
            renderSidebar();
            if (state.currentSetId) switchSet(state.currentSetId, state.currentViewId);
            setupEventListeners();
            setupKeyboardShortcuts();
            applyResponsiveLayout();
            window.addEventListener('resize', applyResponsiveLayout);
        }

        function applyResponsiveLayout() {
            const appContainer = document.getElementById('appContainer');
            const isMobile = window.matchMedia('(max-width: 1024px)').matches;

            if (isMobile) {
                appContainer.classList.add('mobile-layout');
                appContainer.classList.toggle('sidebar-open-mobile', state.sidebarOpenMobile);
                appContainer.classList.remove('sidebar-collapsed');
            } else {
                appContainer.classList.remove('mobile-layout');
                appContainer.classList.remove('sidebar-open-mobile');
                appContainer.classList.toggle('sidebar-collapsed', state.sidebarCollapsed);
            }
        }

        function initializeOperatorRules() {
            const defaultRules = [
                {
                    rule_id: 'rule_ins_requires_object',
                    applies_to_op: 'INS',
                    description: 'Instantiation must target an identifiable object.',
                    effect: 'require_object_id'
                },
                {
                    rule_id: 'rule_events_require_actor',
                    description: 'All events must be attributable to an actor.',
                    effect: 'require_actor'
                },
                {
                    rule_id: 'rule_nullify_marks_deleted',
                    applies_to_op: 'NUL',
                    description: 'Nullify operations explicitly mark the object as deleted in the payload.',
                    effect: 'mark_deleted'
                }
            ];

            defaultRules.forEach(rule => registerInterpretationRule(rule, { skipEvent: true }));
        }

        function createSampleData() {
            const projectsId = createSet('Projects', 'üìä');
            const projectsSet = state.sets.get(projectsId);
            
            projectsSet.schema = [
                { id: 'name', name: 'Project Name', type: 'TEXT', width: '200px' },
                { id: 'status', name: 'Status', type: 'SINGLE_SELECT', width: '130px', config: {
                    options: ['Planning', 'In Progress', 'On Hold', 'Completed'],
                    colors: { 'Planning': 'gray', 'In Progress': 'blue', 'On Hold': 'yellow', 'Completed': 'green' }
                }},
                { id: 'budget', name: 'Budget', type: 'CURRENCY', width: '120px' },
                { id: 'start_date', name: 'Start Date', type: 'DATE', width: '120px' },
                { id: 'priority', name: 'Priority', type: 'SINGLE_SELECT', width: '100px', config: {
                    options: ['Low', 'Medium', 'High', 'Critical'],
                    colors: { 'Low': 'gray', 'Medium': 'blue', 'High': 'yellow', 'Critical': 'red' }
                }},
                { id: 'notes', name: 'Notes', type: 'LONG_TEXT', width: '300px' }
            ];
            
            projectsSet.profiles = new Map([
                ['default', { id: 'default', name: 'All Fields', visibleFields: [] }]
            ]);
            
            addRecord(projectsId, {
                name: 'Website Redesign',
                status: 'In Progress',
                budget: 50000,
                start_date: '2024-01-15',
                priority: 'High',
                notes: 'Complete overhaul of company website'
            });
            
            addRecord(projectsId, {
                name: 'Mobile App',
                status: 'Planning',
                budget: 120000,
                start_date: '2024-06-01',
                priority: 'Critical',
                notes: 'iOS and Android native apps'
            });
            
            addRecord(projectsId, {
                name: 'Database Migration',
                status: 'Completed',
                budget: 30000,
                start_date: '2023-11-01',
                priority: 'High',
                notes: 'Migrate to new cloud infrastructure'
            });
            
            createView(projectsId, 'All Projects', { type: 'grid' });
            createView(projectsId, 'By Status', { type: 'kanban' });
            createView(projectsId, 'Card View', { type: 'card' });
            
            state.currentSetId = projectsId;
            state.currentViewId = Array.from(projectsSet.views.keys())[0];
            state.expandedSets.add(projectsId);
        }

        // SET MANAGEMENT
        function createSet(name, icon = 'üìä') {
            const setId = 'set_' + Date.now();
            state.sets.set(setId, {
                id: setId,
                name: name,
                icon: icon,
                schema: [],
                records: new Map(),
                views: new Map(),
                profiles: new Map([['default', { id: 'default', name: 'All Fields', visibleFields: [] }]]),
                connections: new Map()
            });
            createEvent(
                'Create Set',
                'INS',
                { type: 'Set', id: setId },
                { name },
                { summary: `Created set "${name}"`, scale: 'collection' }
            );
            return setId;
        }

        function createView(setId, name, config = {}) {
            const viewId = 'view_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const set = state.sets.get(setId);
            set.views.set(viewId, {
                id: viewId,
                name: name,
                type: config.type || 'grid',
                filters: config.filters || [],
                hiddenFields: config.hiddenFields || [],
                kanbanGroupField: config.kanbanGroupField || null,
                cardFields: config.cardFields || []
            });
            return viewId;
        }

        function addRecord(setId, data) {
            const set = state.sets.get(setId);
            const recordId = 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const record = { id: recordId, ...data };
            set.schema.forEach(field => {
                if (field.type === 'CONNECTION') {
                    record[field.id] = Array.isArray(record[field.id]) ? record[field.id] : [];
                    if (!set.connections.has(field.id)) {
                        set.connections.set(field.id, { fieldId: field.id, config: field.config || {}, edges: [] });
                    }
                }
            });
            set.records.set(recordId, record);
            createEvent(
                'Create Record',
                'INS',
                { type: 'Record', id: recordId, setId },
                { setId, recordId, data, summary: 'Created record' }
            );
            return recordId;
        }

        function getConnectionDefinition(set, fieldId) {
            if (!set.connections) set.connections = new Map();
            if (!set.connections.has(fieldId)) {
                const field = set.schema.find(f => f.id === fieldId) || {};
                set.connections.set(fieldId, { fieldId, config: field.config || {}, edges: [] });
            }
            return set.connections.get(fieldId);
        }

        function recomputeConnectionValues(set, fieldId) {
            const connection = getConnectionDefinition(set, fieldId);
            set.records.forEach(record => {
                record[fieldId] = connection.edges.filter(e => e.sourceId === record.id);
            });
        }

        function recomputeLookupsForConnection(set, connection) {
            if (!connection.config?.lookups || connection.config.lookups.length === 0) return;
            const targetSet = state.sets.get(connection.config.targetSetId);
            if (!targetSet) return;

            set.records.forEach(record => {
                const edges = connection.edges.filter(e => e.sourceId === record.id);
                const targets = edges.map(e => targetSet.records.get(e.targetId)).filter(Boolean);
                connection.config.lookups.forEach(lookup => {
                    const values = targets.map(t => t?.[lookup.fromField]);
                    let derivedValue = null;
                    switch(lookup.aggregate) {
                        case 'sum':
                            derivedValue = values.reduce((sum, v) => sum + (parseFloat(v) || 0), 0);
                            break;
                        case 'avg':
                            derivedValue = values.length ? values.reduce((sum, v) => sum + (parseFloat(v) || 0), 0) / values.length : 0;
                            break;
                        case 'count':
                            derivedValue = values.filter(v => v !== undefined && v !== null).length;
                            break;
                        case 'first':
                            derivedValue = values[0] || null;
                            break;
                        default:
                            derivedValue = values.filter(v => v !== undefined && v !== null).join(', ');
                    }
                    record[lookup.intoField] = derivedValue;
                });
            });
        }

        function recomputeAllLookupsForSet(set) {
            if (!set.connections) return;
            set.connections.forEach(connection => {
                recomputeConnectionValues(set, connection.fieldId);
                recomputeLookupsForConnection(set, connection);
            });
        }

        function recomputeLookupsForTarget(targetSetId, targetRecordId) {
            state.sets.forEach(set => {
                set.connections?.forEach(connection => {
                    const touchesTarget = connection.config?.targetSetId === targetSetId && connection.edges.some(e => e.targetId === targetRecordId);
                    if (touchesTarget) {
                        recomputeAllLookupsForSet(set);
                    }
                });
            });
            renderCurrentView();
        }

        function addConnectionEdge(setId, fieldId, sourceId, targetId, edgeData = {}) {
            const set = state.sets.get(setId);
            if (!set) return;
            const connection = getConnectionDefinition(set, fieldId);
            if (!connection.config?.targetSetId) { showToast('‚ö†Ô∏è Connection missing target set'); return; }

            if (connection.config.cardinality === 'single') {
                connection.edges = connection.edges.filter(e => e.sourceId !== sourceId);
            }

            const existing = connection.edges.find(e => e.sourceId === sourceId && e.targetId === targetId);
            const edgeId = existing?.edgeId || `edge_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
            if (existing) {
                existing.edgeData = edgeData;
            } else {
                connection.edges.push({ edgeId, sourceId, targetId, edgeData });
            }

            recomputeConnectionValues(set, fieldId);
            recomputeLookupsForConnection(set, connection);
            createEvent('Connect Records', 'CON', { type: 'Record', id: sourceId, setId }, { sourceId, targetId, fieldId, edgeId, edgeData, summary: 'Created connection' });
            renderCurrentView();
            showToast('‚úì Connection saved');
        }

        function removeConnectionEdge(setId, fieldId, edgeId, event) {
            if (event) event.stopPropagation();
            const set = state.sets.get(setId);
            if (!set) return;
            const connection = getConnectionDefinition(set, fieldId);
            const removed = connection.edges.find(e => e.edgeId === edgeId);
            connection.edges = connection.edges.filter(e => e.edgeId !== edgeId);
            recomputeConnectionValues(set, fieldId);
            recomputeLookupsForConnection(set, connection);
            if (removed) {
                createEvent('Remove Connection', 'NUL', { type: 'Record', id: removed.sourceId, setId }, { fieldId, edgeId, targetId: removed.targetId, summary: 'Removed connection' });
            }
            renderCurrentView();
        }

        // SIDEBAR
        function toggleSidebar() {
            const isMobile = window.matchMedia('(max-width: 1024px)').matches;
            if (isMobile) {
                state.sidebarOpenMobile = !state.sidebarOpenMobile;
            } else {
                state.sidebarCollapsed = !state.sidebarCollapsed;
            }
            applyResponsiveLayout();
        }

        function closeMobileSidebar() {
            if (!state.sidebarOpenMobile) return;
            state.sidebarOpenMobile = false;
            applyResponsiveLayout();
        }

        function toggleSetExpansion(setId) {
            if (state.expandedSets.has(setId)) {
                state.expandedSets.delete(setId);
            } else {
                state.expandedSets.add(setId);
            }
            renderSidebar();
        }

        function renderSidebar() {
            const container = document.getElementById('setsList');
            container.innerHTML = '';
            
            state.sets.forEach((set, setId) => {
                const isExpanded = state.expandedSets.has(setId);
                const isActive = setId === state.currentSetId;
                
                const setItem = document.createElement('div');
                setItem.className = `set-item ${isExpanded ? 'expanded' : ''}`;
                
                const setHeader = document.createElement('div');
                setHeader.className = `set-header ${isActive && !state.currentViewId ? 'active' : ''}`;
                setHeader.innerHTML = `
                    <span class="set-icon">${set.icon}</span>
                    <span class="set-name">${set.name}</span>
                    <span class="set-expand-icon">‚ñ∂</span>
                `;
                setHeader.onclick = () => toggleSetExpansion(setId);
                setItem.appendChild(setHeader);
                
                if (isExpanded) {
                    const viewsList = document.createElement('div');
                    viewsList.className = 'views-list';
                    
                    set.views.forEach((view, viewId) => {
                        const viewItem = document.createElement('div');
                        viewItem.className = `view-item ${viewId === state.currentViewId ? 'active' : ''}`;
                        const icons = { grid: 'üî≤', card: 'üÉè', kanban: 'üìä' };
                        viewItem.innerHTML = `
                            <span class="view-item-icon">${icons[view.type] || 'üìã'}</span>
                            <span>${view.name}</span>
                        `;
                        viewItem.onclick = (e) => {
                            e.stopPropagation();
                            switchSet(setId, viewId);
                        };
                        viewsList.appendChild(viewItem);
                    });
                    
                    const addViewBtn = document.createElement('div');
                    addViewBtn.className = 'add-view-btn';
                    addViewBtn.textContent = '+ Add View';
                    addViewBtn.onclick = (e) => {
                        e.stopPropagation();
                        state.currentSetId = setId;
                        openModal('addViewModal');
                    };
                    viewsList.appendChild(addViewBtn);
                    
                    setItem.appendChild(viewsList);
                }
                
                container.appendChild(setItem);
            });
        }

        function switchSet(setId, viewId) {
            state.currentSetId = setId;
            state.currentViewId = viewId;
            const set = state.sets.get(setId);
            if (!viewId && set.views.size > 0) {
                state.currentViewId = Array.from(set.views.keys())[0];
            }
            closeMobileSidebar();
            renderSidebar();
            renderCurrentView();
        }

        function getCurrentSet() { return state.sets.get(state.currentSetId); }
        function getCurrentView() { const set = getCurrentSet(); return set?.views.get(state.currentViewId); }
        function getCurrentProfile() { const set = getCurrentSet(); return set?.profiles.get(state.currentProfileId); }

        // VIEW SWITCHING
        function switchViewType(type) {
            const view = getCurrentView();
            if (!view) return;
            view.type = type;
            
            // Update button states
            document.querySelectorAll('.view-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) btn.classList.add('active');
            });
            
            renderCurrentView();
        }

        function renderCurrentView() {
            const view = getCurrentView();
            if (!view) return;
            
            // Update view type buttons
            document.querySelectorAll('.view-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === view.type) btn.classList.add('active');
            });
            
            switch(view.type) {
                case 'grid':
                    renderGridView();
                    break;
                case 'card':
                    renderCardView();
                    break;
                case 'kanban':
                    renderKanbanView();
                    break;
            }
        }

        // GRID VIEW
        function renderGridView() {
            const set = getCurrentSet();
            if (!set) return;
            
            const view = getCurrentView();
            const profile = getCurrentProfile();
            const schema = set.schema.filter(f => 
                !profile || profile.visibleFields.length === 0 || profile.visibleFields.includes(f.id)
            );
            
            let records = Array.from(set.records.values());
            if (view && view.filters.length > 0) records = applyFilterGroups(records, view.filters, schema);
            
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="max-w-full px-6 py-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="table-scroll">
                            <table id="dataTable" class="w-full border-collapse">
                                <thead><tr id="tableHeader"><th class="column-header" style="width: 50px;">#</th></tr></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const headerRow = document.getElementById('tableHeader');
            schema.forEach(field => {
                const th = document.createElement('th');
                th.className = 'column-header';
                th.dataset.type = field.type;
                th.dataset.fieldId = field.id;
                th.style.width = field.width || '150px';
                th.innerHTML = `<span>${field.name}</span>`;
                th.oncontextmenu = (e) => { e.preventDefault(); showColumnMenu(e, field); };
                headerRow.appendChild(th);
            });

            const table = document.getElementById('dataTable');
            const minimumTableWidth = Math.max(schema.length * 170 + 80, 600);
            table.style.minWidth = `${minimumTableWidth}px`;

            const tbody = document.getElementById('tableBody');
            records.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.dataset.recordId = record.id;
                tr.onclick = (e) => {
                    if (e.target === tr || e.target.closest('.row-number')) openExpandedRecord(record.id);
                };
                
                const tdNum = document.createElement('td');
                tdNum.className = 'row-number cell-editable text-center bg-gray-50 font-medium text-gray-500';
                tdNum.textContent = index + 1;
                tdNum.oncontextmenu = (e) => { e.preventDefault(); showRowMenu(e, record.id); };
                tr.appendChild(tdNum);
                
                schema.forEach(field => {
                    const td = document.createElement('td');
                    td.className = 'cell-editable';
                    td.dataset.recordId = record.id;
                    td.dataset.fieldId = field.id;
                    const value = record[field.id];
                    td.innerHTML = renderCellValue(value, field);
                    if (field.type === 'CHECKBOX') {
                        td.onclick = (e) => { e.stopPropagation(); toggleCheckbox(record.id, field.id); };
                    } else {
                        td.onclick = (e) => { e.stopPropagation(); makeEditable(td, record.id, field); };
                    }
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
        }

        function renderCellValue(value, field) {
            switch(field.type) {
                case 'TEXT': case 'LONG_TEXT': case 'EMAIL': case 'URL': case 'PHONE':
                    return value || '';
                case 'NUMBER':
                    return value ? Number(value).toLocaleString() : '';
                case 'CURRENCY':
                    return value ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value) : '';
                case 'DATE':
                    return value ? new Date(value).toLocaleDateString() : '';
                case 'CHECKBOX':
                    return value ? '‚úÖ' : '‚¨ú';
                case 'SINGLE_SELECT':
                    if (!value) return '';
                    const color = field.config?.colors?.[value] || 'gray';
                    return `<span class="badge badge-${color}">${value}</span>`;
                case 'CONNECTION':
                    if (!value || value.length === 0) return '';
                    const currentSet = getCurrentSet();
                    const connectionDef = currentSet?.connections?.get(field.id);
                    return value.map(edge => {
                        const targetSet = connectionDef ? state.sets.get(connectionDef.config?.targetSetId) : null;
                        const targetRecord = targetSet?.records.get(edge.targetId);
                        const label = targetRecord?.name || targetRecord?.id || 'Untitled';
                        const edgeMeta = edge.edgeData && Object.keys(edge.edgeData).length > 0
                            ? ` <span class="text-[10px] text-gray-600">${Object.entries(edge.edgeData).map(([k,v]) => `${k}: ${v}`).join(', ')}</span>`
                            : '';
                        return `<span class="badge badge-blue inline-flex items-center gap-1">${label}${edgeMeta} <button class="text-[10px] ml-1" onclick="removeConnectionEdge('${currentSet?.id}', '${field.id}', '${edge.edgeId}', event)">‚úï</button></span>`;
                    }).join(' ');
                default:
                    return value || '';
            }
        }

        // CARD VIEW
        function renderCardView() {
            const set = getCurrentSet();
            if (!set) return;
            
            const view = getCurrentView();
            let records = Array.from(set.records.values());
            if (view && view.filters.length > 0) records = applyFilterGroups(records, view.filters, set.schema);
            
            const container = document.getElementById('viewContainer');
            container.innerHTML = '<div class="cards-grid" id="cardsGrid"></div>';
            
            const grid = document.getElementById('cardsGrid');
            records.forEach(record => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openExpandedRecord(record.id);
                
                const primaryField = set.schema[0];
                const displayFields = set.schema.slice(1, 6);
                
                card.innerHTML = `
                    <div class="card-title">${record[primaryField.id] || 'Untitled'}</div>
                    ${displayFields.map(field => {
                        const value = record[field.id];
                        if (!value && value !== 0 && value !== false) return '';
                        return `
                            <div class="card-field">
                                <div class="card-field-label">${field.name}</div>
                                <div class="card-field-value">${renderCellValue(value, field)}</div>
                            </div>
                        `;
                    }).join('')}
                `;

                const connectBtn = document.createElement('button');
                connectBtn.className = 'btn btn-secondary btn-sm mt-3';
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = (e) => { e.stopPropagation(); openConnectionPicker(record.id); };
                card.appendChild(connectBtn);

                grid.appendChild(card);
            });
        }

        // KANBAN VIEW
        function renderKanbanView() {
            const set = getCurrentSet();
            const view = getCurrentView();
            if (!set || !view) return;
            
            if (!view.kanbanGroupField) {
                const container = document.getElementById('viewContainer');
                container.innerHTML = `
                    <div class="kanban-empty-state">
                        <div class="text-4xl mb-4">üìä</div>
                        <p class="text-lg font-semibold mb-2">Configure Kanban Board</p>
                        <p class="mb-4">Select a single-select field to group your records</p>
                        <button onclick="openKanbanConfig()" class="btn btn-primary">Configure Kanban</button>
                    </div>
                `;
                return;
            }
            
            const groupField = set.schema.find(f => f.id === view.kanbanGroupField);
            if (!groupField || groupField.type !== 'SINGLE_SELECT') {
                showToast('‚ö†Ô∏è Invalid kanban configuration');
                return;
            }
            
            let records = Array.from(set.records.values());
            if (view.filters.length > 0) records = applyFilterGroups(records, view.filters, set.schema);
            
            const container = document.getElementById('viewContainer');
            container.innerHTML = '<div class="kanban-board" id="kanbanBoard"></div>';
            
            const board = document.getElementById('kanbanBoard');
            const options = groupField.config.options || [];
            
            options.forEach(option => {
                const columnRecords = records.filter(r => r[groupField.id] === option);
                const column = createKanbanColumn(option, columnRecords, groupField);
                board.appendChild(column);
            });
            
            // Uncategorized column
            const uncategorized = records.filter(r => !r[groupField.id]);
            if (uncategorized.length > 0) {
                const column = createKanbanColumn('Uncategorized', uncategorized, groupField);
                board.appendChild(column);
            }
        }

        function createKanbanColumn(title, records, groupField) {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.value = title;
            
            const color = groupField.config?.colors?.[title] || 'gray';
            
            column.innerHTML = `
                <div class="kanban-column-header">
                    <div class="kanban-column-title">
                        <span class="badge badge-${color}">${title}</span>
                    </div>
                    <span class="kanban-column-count">${records.length}</span>
                </div>
                <div class="kanban-cards" data-column="${title}"></div>
            `;
            
            const cardsContainer = column.querySelector('.kanban-cards');
            
            // Enable drop
            cardsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            
            cardsContainer.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });
            
            cardsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                column.classList.remove('drag-over');
                
                if (state.draggedRecord) {
                    const newValue = title === 'Uncategorized' ? '' : title;
                    updateRecord(state.draggedRecord.id, groupField.id, newValue, state.draggedRecord[groupField.id]);
                    state.draggedRecord = null;
                    renderKanbanView();
                }
            });
            
            records.forEach(record => {
                const card = createKanbanCard(record);
                cardsContainer.appendChild(card);
            });
            
            return column;
        }

        function createKanbanCard(record) {
            const set = getCurrentSet();
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.recordId = record.id;
            
            const primaryField = set.schema[0];
            const displayFields = set.schema.slice(1, 4);
            
            card.innerHTML = `
                <div class="font-semibold mb-2">${record[primaryField.id] || 'Untitled'}</div>
                ${displayFields.map(field => {
                    const value = record[field.id];
                    if (!value && value !== 0 && value !== false) return '';
                    return `<div class="text-sm text-gray-600 mb-1">${renderCellValue(value, field)}</div>`;
                }).join('')}
            `;
            
            card.addEventListener('dragstart', (e) => {
                state.draggedRecord = record;
                card.classList.add('dragging');
            });
            
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });
            
            card.onclick = (e) => {
                if (!card.classList.contains('dragging')) {
                    openExpandedRecord(record.id);
                }
            };
            
            return card;
        }

        function openKanbanConfig() {
            const set = getCurrentSet();
            const select = document.getElementById('kanbanGroupField');
            select.innerHTML = '<option value="">Select a field...</option>';
            
            set.schema.forEach(field => {
                if (field.type === 'SINGLE_SELECT') {
                    select.innerHTML += `<option value="${field.id}">${field.name}</option>`;
                }
            });
            
            const view = getCurrentView();
            if (view.kanbanGroupField) {
                select.value = view.kanbanGroupField;
            }
            
            openModal('kanbanConfigModal');
        }

        function saveKanbanConfig() {
            const fieldId = document.getElementById('kanbanGroupField').value;
            if (!fieldId) {
                showConfirm('Please select a field to group by', () => {});
                return;
            }
            
            const view = getCurrentView();
            view.kanbanGroupField = fieldId;
            
            closeModal('kanbanConfigModal');
            renderKanbanView();
            showToast('‚úì Kanban configured');
        }

        // CELL EDITING
        function makeEditable(cell, recordId, field) {
            if (field.type === 'DATE') { showDatePicker(cell, recordId, field); return; }
            if (field.type === 'SINGLE_SELECT') { showSelectDropdown(cell, recordId, field); return; }
            
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            cell.contentEditable = true;
            cell.textContent = currentValue || '';
            cell.focus();
            
            const finishEdit = () => {
                cell.contentEditable = false;
                let newValue = cell.textContent.trim();
                if (field.type === 'NUMBER' || field.type === 'CURRENCY') newValue = parseFloat(newValue) || 0;
                if (String(newValue) !== String(currentValue)) updateRecord(recordId, field.id, newValue, currentValue);
                renderCurrentView();
            };
            
            cell.onblur = finishEdit;
            cell.onkeydown = (e) => {
                if (e.key === 'Enter' && field.type !== 'LONG_TEXT') { e.preventDefault(); finishEdit(); }
            };
        }

        function toggleCheckbox(recordId, fieldId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[fieldId];
            updateRecord(recordId, fieldId, !currentValue, currentValue);
        }

        function showDatePicker(cell, recordId, field) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentValue || '';
            input.className = 'w-full px-2 py-1';
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.onblur = () => {
                const newValue = input.value;
                if (newValue !== currentValue) updateRecord(recordId, field.id, newValue, currentValue);
                renderCurrentView();
            };
        }

        function showSelectDropdown(cell, recordId, field) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const currentValue = record[field.id];
            
            const rect = cell.getBoundingClientRect();
            const dropdown = document.createElement('div');
            dropdown.className = 'context-menu';
            dropdown.style.top = `${rect.bottom + 4}px`;
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.minWidth = '200px';
            
            field.config.options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'context-menu-item';
                const color = field.config.colors[option] || 'gray';
                item.innerHTML = `<span class="badge badge-${color}">${option}</span>`;
                item.onclick = () => {
                    if (option !== currentValue) updateRecord(recordId, field.id, option, currentValue);
                    dropdown.remove();
                    renderCurrentView();
                };
                dropdown.appendChild(item);
            });
            
            document.body.appendChild(dropdown);
            setTimeout(() => {
                document.addEventListener('click', function close(e) {
                    if (!dropdown.contains(e.target)) { dropdown.remove(); document.removeEventListener('click', close); }
                });
            }, 0);
        }

        function openConnectionPicker(recordId) {
            const set = getCurrentSet();
            const connectionFields = set.schema.filter(f => f.type === 'CONNECTION');
            if (connectionFields.length === 0) { showToast('‚ö†Ô∏è Add a connection field first'); return; }

            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-20 modal-overlay flex items-center justify-center p-6 z-50';
            overlay.innerHTML = `
                <div class="modal-container bg-white w-full max-w-lg">
                    <div class="modal-header flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Connect Record</h2>
                            <p class="text-sm text-gray-500">Create a connection to another record</p>
                        </div>
                        <button class="text-gray-400 hover:text-gray-600 transition p-2" id="closeConnectionPicker">‚úï</button>
                    </div>
                    <div class="modal-body space-y-4">
                        <div>
                            <label class="form-label">Connection Field</label>
                            <select id="connectionFieldSelect" class="w-full"></select>
                        </div>
                        <div>
                            <label class="form-label">Target Record</label>
                            <select id="connectionTargetSelect" class="w-full"></select>
                        </div>
                        <div id="edgeAttributes"></div>
                        <div>
                            <label class="form-label">Existing Connections</label>
                            <div id="existingConnections" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="modal-footer flex justify-end gap-2">
                        <button class="btn btn-secondary" id="cancelConnectionPicker">Cancel</button>
                        <button class="btn btn-primary" id="saveConnectionPicker">Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const fieldSelect = overlay.querySelector('#connectionFieldSelect');
            const targetSelect = overlay.querySelector('#connectionTargetSelect');
            const edgeAttributes = overlay.querySelector('#edgeAttributes');
            const existingContainer = overlay.querySelector('#existingConnections');

            connectionFields.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                fieldSelect.appendChild(option);
            });

            function renderTargets(fieldId) {
                const connection = getConnectionDefinition(set, fieldId);
                const targetSet = state.sets.get(connection.config.targetSetId);
                targetSelect.innerHTML = '';
                if (!targetSet) { targetSelect.innerHTML = '<option value="">No target set</option>'; return; }
                targetSet.records.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = r.name || r.id;
                    targetSelect.appendChild(option);
                });
            }

            function renderEdgeSchema(fieldId) {
                const connection = getConnectionDefinition(set, fieldId);
                edgeAttributes.innerHTML = '';
                if (!connection.config?.edgeSchema || connection.config.edgeSchema.length === 0) return;
                connection.config.edgeSchema.forEach(field => {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `
                        <label class="form-label">${field.name || field.id}</label>
                        <input type="text" data-edge-field="${field.id}" class="w-full" placeholder="Enter ${field.name || field.id}">
                    `;
                    edgeAttributes.appendChild(wrapper);
                });
            }

            function renderExisting(fieldId) {
                const connection = getConnectionDefinition(set, fieldId);
                const edges = connection.edges.filter(e => e.sourceId === recordId);
                if (edges.length === 0) { existingContainer.innerHTML = '<p class="text-sm text-gray-500">No connections yet</p>'; return; }
                const targetSet = state.sets.get(connection.config.targetSetId);
                existingContainer.innerHTML = edges.map(edge => {
                    const targetRecord = targetSet?.records.get(edge.targetId);
                    const label = targetRecord?.name || edge.targetId;
                    return `<div class="flex items-center justify-between bg-gray-50 rounded-md px-3 py-2 text-sm">
                        <span>${label}</span>
                        <button class="text-red-600" onclick="removeConnectionEdge('${set.id}', '${fieldId}', '${edge.edgeId}')">Remove</button>
                    </div>`;
                }).join('');
            }

            function syncUI() {
                const fieldId = fieldSelect.value;
                renderTargets(fieldId);
                renderEdgeSchema(fieldId);
                renderExisting(fieldId);
            }

            fieldSelect.onchange = syncUI;
            syncUI();

            overlay.querySelector('#saveConnectionPicker').onclick = () => {
                const fieldId = fieldSelect.value;
                const targetId = targetSelect.value;
                const edgeData = {};
                edgeAttributes.querySelectorAll('[data-edge-field]').forEach(input => {
                    edgeData[input.dataset.edgeField] = input.value;
                });
                if (fieldId && targetId) {
                    addConnectionEdge(set.id, fieldId, recordId, targetId, edgeData);
                }
                document.body.removeChild(overlay);
            };
            const close = () => document.body.contains(overlay) && document.body.removeChild(overlay);
            overlay.querySelector('#cancelConnectionPicker').onclick = close;
            overlay.querySelector('#closeConnectionPicker').onclick = close;
        }

        function updateRecord(recordId, fieldId, newValue, oldValue) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const field = set.schema.find(f => f.id === fieldId);
            record[fieldId] = newValue;
            createEvent(
                'Update Cell',
                'SEG',
                { type: 'Record', id: recordId, setId: set.id },
                {
                    fieldId: fieldId,
                    fieldName: field.name,
                    oldValue: oldValue,
                    newValue: newValue,
                    setId: set.id,
                    recordId: recordId,
                    summary: `Updated ${field.name}`
                }
            );
            recomputeAllLookupsForSet(set);
            recomputeLookupsForTarget(set.id, recordId);
            renderCurrentView();
            showToast(`‚úì Updated ${field.name}`);
        }

        // FIELD MANAGEMENT
        function openAddFieldModal() {
            state.selectOptions = [{ value: 'Option 1', color: 'blue' }];
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldType').value = 'TEXT';
            renderFieldTypeGrid('TEXT');
            updateFieldConfig('TEXT');
            
            const linkSelect = document.getElementById('linkToSet');
            linkSelect.innerHTML = '';
            state.sets.forEach((set, setId) => {
                if (setId !== state.currentSetId) {
                    linkSelect.innerHTML += `<option value="${setId}">${set.name}</option>`;
                }
            });
            
            openModal('addFieldModal');
        }

        function renderFieldTypeGrid(selectedType) {
            const grid = document.getElementById('fieldTypeGrid');
            grid.innerHTML = '';
            Object.values(FIELD_TYPES).forEach(fieldType => {
                const option = document.createElement('div');
                option.className = `field-type-option ${fieldType.id === selectedType ? 'selected' : ''}`;
                option.onclick = () => selectFieldType(fieldType.id);
                option.innerHTML = `
                    <div class="field-type-icon">${fieldType.icon}</div>
                    <div class="flex-1"><div class="font-medium text-sm">${fieldType.name}</div></div>
                `;
                grid.appendChild(option);
            });
        }

        function selectFieldType(typeId) {
            document.getElementById('newFieldType').value = typeId;
            document.querySelectorAll('.field-type-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updateFieldConfig(typeId);
        }

        function updateFieldConfig(typeId) {
            document.getElementById('singleSelectConfig').classList.remove('visible');
            document.getElementById('linkToRecordConfig').classList.remove('visible');
            if (typeId === 'SINGLE_SELECT') {
                document.getElementById('singleSelectConfig').classList.add('visible');
                renderSelectOptions();
            } else if (typeId === 'CONNECTION') {
                document.getElementById('linkToRecordConfig').classList.add('visible');
            }
        }

        function renderSelectOptions() {
            const container = document.getElementById('selectOptionsList');
            container.innerHTML = state.selectOptions.map((opt, i) => `
                <div class="option-row">
                    <input type="text" value="${opt.value}" onchange="updateSelectOption(${i}, this.value, '${opt.color}')" placeholder="Option ${i + 1}">
                    <div class="color-picker">
                        ${['blue', 'green', 'yellow', 'red', 'purple', 'gray'].map(c => `
                            <div class="color-option badge-${c} ${opt.color === c ? 'selected' : ''}" 
                                 onclick="updateSelectOption(${i}, '${opt.value}', '${c}')"></div>
                        `).join('')}
                    </div>
                    ${state.selectOptions.length > 1 ? `<button onclick="removeSelectOption(${i})" class="btn btn-secondary btn-sm">‚úï</button>` : ''}
                </div>
            `).join('');
        }

        function addSelectOption() {
            state.selectOptions.push({ value: `Option ${state.selectOptions.length + 1}`, color: 'blue' });
            renderSelectOptions();
        }

        function updateSelectOption(index, value, color) {
            state.selectOptions[index] = { value, color };
            renderSelectOptions();
        }

        function removeSelectOption(index) {
            state.selectOptions.splice(index, 1);
            renderSelectOptions();
        }

        function saveField() {
            const name = document.getElementById('newFieldName').value.trim();
            const type = document.getElementById('newFieldType').value;
            if (!name) { showConfirm('Please enter a field name', () => {}); return; }
            
            const set = getCurrentSet();
            const fieldId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (set.schema.find(f => f.id === fieldId)) {
                showConfirm('A field with this name already exists', () => {});
                return;
            }
            
            const newField = { id: fieldId, name: name, type: type, width: '150px', config: {} };

            if (type === 'SINGLE_SELECT') {
                newField.config = {
                    options: state.selectOptions.map(o => o.value),
                    colors: Object.fromEntries(state.selectOptions.map(o => [o.value, o.color]))
                };
            } else if (type === 'CONNECTION') {
                const targetSetId = document.getElementById('linkToSet').value || state.currentSetId;
                newField.config = { targetSetId, cardinality: 'many', edgeSchema: [], lookups: [] };
            }

            set.schema.push(newField);
            set.records.forEach(r => r[fieldId] = Array.isArray(FIELD_TYPES[type].defaultValue) ? [] : FIELD_TYPES[type].defaultValue);
            if (type === 'CONNECTION') {
                set.connections.set(fieldId, { fieldId, config: newField.config, edges: [] });
            }
            
            closeModal('addFieldModal');
            renderCurrentView();
            
            // Scroll to new field
            setTimeout(() => {
                const header = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (header) {
                    header.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
                    header.style.animation = 'flash-yellow 0.5s ease-out';
                }
            }, 100);
            
            showToast('‚úì Field added');
        }

        // FILTERING (simplified for space)
        function openFilterModal() {
            renderFilterBuilder();
            openModal('filterModal');
        }

        function renderFilterBuilder() {
            const view = getCurrentView();
            const container = document.getElementById('filterGroupsContainer');
            if (!view.filters || view.filters.length === 0) view.filters = [[{ field: '', operator: 'equals', value: '' }]];
            container.innerHTML = view.filters.map((group, groupIndex) => `
                <div class="filter-group">
                    <div class="filter-group-header">
                        <div class="filter-operator-toggle">
                            <button class="${group.operator !== 'OR' ? 'active' : ''}" onclick="setGroupOperator(${groupIndex}, 'AND')">AND</button>
                            <button class="${group.operator === 'OR' ? 'active' : ''}" onclick="setGroupOperator(${groupIndex}, 'OR')">OR</button>
                        </div>
                        <button onclick="removeFilterGroup(${groupIndex})" class="text-red-600 text-sm">Remove Group</button>
                    </div>
                    ${group.map((rule, ruleIndex) => renderFilterRule(groupIndex, ruleIndex, rule)).join('')}
                    <button onclick="addFilterRule(${groupIndex})" class="btn btn-secondary btn-sm mt-2">+ Add Rule</button>
                </div>
            `).join('');
        }

        function renderFilterRule(groupIndex, ruleIndex, rule) {
            const schema = getCurrentSet().schema;
            return `
                <div class="filter-rule">
                    <select onchange="updateFilterField(${groupIndex}, ${ruleIndex}, this.value)">
                        <option value="">Select field...</option>
                        ${schema.map(f => `<option value="${f.id}" ${f.id === rule.field ? 'selected' : ''}>${f.name}</option>`).join('')}
                    </select>
                    <select><option>equals</option></select>
                    <input type="text" value="${rule.value || ''}" onchange="updateFilterValue(${groupIndex}, ${ruleIndex}, this.value)">
                    <button onclick="removeFilterRule(${groupIndex}, ${ruleIndex})" class="text-red-600">‚úï</button>
                </div>
            `;
        }

        function applyFilterGroups(records, filterGroups, schema) {
            const toComparable = (value) => {
                if (Array.isArray(value)) {
                    return value.map(v => typeof v === 'object' ? (v.targetId || JSON.stringify(v)) : v).join(', ');
                }
                return value;
            };
            return records.filter(record => {
                return filterGroups.some(group => {
                    const operator = group.operator || 'AND';
                    const rules = group.filter(r => r.field);
                    if (operator === 'AND') return rules.every(rule => toComparable(record[rule.field]) === rule.value);
                    else return rules.some(rule => toComparable(record[rule.field]) === rule.value);
                });
            });
        }

        function setGroupOperator(groupIndex, operator) {
            const view = getCurrentView();
            view.filters[groupIndex].operator = operator;
            renderFilterBuilder();
        }

        function addFilterRule(groupIndex) {
            const view = getCurrentView();
            view.filters[groupIndex].push({ field: '', operator: 'equals', value: '' });
            renderFilterBuilder();
        }

        function removeFilterRule(groupIndex, ruleIndex) {
            const view = getCurrentView();
            view.filters[groupIndex].splice(ruleIndex, 1);
            if (view.filters[groupIndex].length === 0) view.filters.splice(groupIndex, 1);
            renderFilterBuilder();
        }

        function addFilterGroup() {
            const view = getCurrentView();
            view.filters.push([{ field: '', operator: 'equals', value: '' }]);
            renderFilterBuilder();
        }

        function removeFilterGroup(groupIndex) {
            const view = getCurrentView();
            view.filters.splice(groupIndex, 1);
            renderFilterBuilder();
        }

        function updateFilterField(groupIndex, ruleIndex, fieldId) {
            const view = getCurrentView();
            view.filters[groupIndex][ruleIndex].field = fieldId;
            renderFilterBuilder();
        }

        function updateFilterValue(groupIndex, ruleIndex, value) {
            const view = getCurrentView();
            view.filters[groupIndex][ruleIndex].value = value;
        }

        function applyFilters() {
            closeModal('filterModal');
            renderCurrentView();
            showToast('‚úì Filters applied');
        }

        function clearFilters() {
            const view = getCurrentView();
            view.filters = [[{ field: '', operator: 'equals', value: '' }]];
            renderFilterBuilder();
        }

        // EXPANDED RECORD
        function openExpandedRecord(recordId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            state.currentRecordTab = 'history';
            state.recordHistoryVisible = true;
            document.getElementById('expandedRecordTitle').textContent = record.name || record.id;
            renderExpandedRecordMain(recordId);
            renderRecordSidebar(recordId);
            updateRecordHistoryVisibility();
            openModal('expandedRecordModal');
        }

        function renderExpandedRecordMain(recordId) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const container = document.getElementById('expandedRecordMain');
            container.dataset.recordId = recordId;
            container.innerHTML = `
                <div class="space-y-4">
                    ${set.schema.map(field => `
                        <div class="field-editor">
                            <label class="form-label">${field.name}</label>
                            ${renderFieldEditor(recordId, field, record[field.id])}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFieldEditor(recordId, field, value) {
            switch(field.type) {
                case 'TEXT': case 'EMAIL': case 'URL': case 'PHONE':
                    return `<input type="text" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
                case 'LONG_TEXT':
                    return `<textarea rows="4" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">${value || ''}</textarea>`;
                case 'NUMBER': case 'CURRENCY':
                    return `<input type="number" value="${value || 0}" onchange="updateRecordField('${recordId}', '${field.id}', parseFloat(this.value))">`;
                case 'DATE':
                    return `<input type="date" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
                case 'CHECKBOX':
                    return `<input type="checkbox" ${value ? 'checked' : ''} onchange="updateRecordField('${recordId}', '${field.id}', this.checked)">`;
                case 'SINGLE_SELECT':
                    return `<select onchange="updateRecordField('${recordId}', '${field.id}', this.value)">
                        <option value="">Select...</option>
                        ${field.config.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>`;
                default:
                    return `<input type="text" value="${value || ''}" onchange="updateRecordField('${recordId}', '${field.id}', this.value)">`;
            }
        }

        function updateRecordField(recordId, fieldId, value) {
            const set = getCurrentSet();
            const record = set.records.get(recordId);
            const oldValue = record[fieldId];
            updateRecord(recordId, fieldId, value, oldValue);
            renderExpandedRecordMain(recordId);
        }

        function switchRecordTab(tab) {
            state.currentRecordTab = tab;
            document.querySelectorAll('.record-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.record-tab[data-tab="${tab}"]`).classList.add('active');
            const recordId = document.getElementById('expandedRecordMain').dataset.recordId;
            renderRecordSidebar(recordId);
        }

        function renderRecordSidebar(recordId) {
            const container = document.getElementById('expandedRecordSidebar');
            const history = state.eventStream.filter(e => e.object?.id === recordId && e.op === 'SEG');
            container.innerHTML = `
                <h3 class="font-semibold mb-4">Change History</h3>
                ${history.length === 0 ? '<p class="text-gray-500">No changes yet</p>' : ''}
                ${history.map(e => `
                    <div class="history-entry">
                        <div class="font-medium">${e.data?.fieldName || 'Field change'}</div>
                        <div class="text-sm text-gray-500">${getTimeAgo(e.published)}</div>
                        <div class="text-sm mt-1">
                            <span class="text-red-600">${e.data?.oldValue}</span> ‚Üí
                            <span class="text-green-600">${e.data?.newValue}</span>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function updateRecordHistoryVisibility() {
            const historyColumn = document.getElementById('expandedRecordHistoryColumn');
            const mainWrapper = document.getElementById('expandedRecordMainWrapper');
            const toggleBtn = document.getElementById('toggleHistorySidebarBtn');
            const isVisible = state.recordHistoryVisible;

            if (historyColumn) historyColumn.classList.toggle('hidden', !isVisible);
            if (mainWrapper) {
                mainWrapper.classList.toggle('md:col-span-3', !isVisible);
                mainWrapper.classList.toggle('md:col-span-2', isVisible);
                mainWrapper.classList.toggle('border-r', isVisible);
            }
            if (toggleBtn) toggleBtn.textContent = isVisible ? 'Hide History' : 'Show History';
        }

        function toggleRecordHistoryVisibility() {
            state.recordHistoryVisible = !state.recordHistoryVisible;
            updateRecordHistoryVisibility();
        }

        // CONTEXT MENUS
        function showColumnMenu(e, field) {
            showContextMenu(e, [
                { label: 'Hide Field', action: () => hideField(field.id) },
                { label: 'Delete Field', action: () => confirmDelete('field', field.id), danger: true }
            ]);
        }

        function showRowMenu(e, recordId) {
            showContextMenu(e, [
                { label: 'Connect...', action: () => openConnectionPicker(recordId) },
                { label: 'Delete Record', action: () => confirmDelete('record', recordId), danger: true }
            ]);
        }

        function showContextMenu(e, items) {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.innerHTML = items.map(item => `<div class="context-menu-item ${item.danger ? 'danger' : ''}">${item.label}</div>`).join('');
            menu.querySelectorAll('.context-menu-item').forEach((el, i) => {
                el.onclick = () => { items[i].action(); menu.remove(); };
            });
            document.body.appendChild(menu);
            setTimeout(() => {
                document.addEventListener('click', function close() { menu.remove(); document.removeEventListener('click', close); });
            }, 0);
        }

        function confirmDelete(type, id) {
            const messages = {
                field: 'Delete this field? This will remove data from all records.',
                record: 'Delete this record? This cannot be undone.'
            };
            showConfirm(messages[type], () => {
                if (type === 'field') deleteField(id);
                if (type === 'record') deleteRecord(id);
            });
        }

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            state.confirmCallback = callback;
            openModal('confirmModal');
        }

        function registerInterpretationRule(rule, options = {}) {
            const normalizedRule = {
                rule_id: rule.rule_id || `rule_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                applies_to_op: rule.applies_to_op || null,
                description: rule.description || '',
                effect: rule.effect || 'none',
                frame: rule.frame || 'system',
                scale: rule.scale || 'system'
            };

            state.interpretationRules.push(normalizedRule);

            if (!options.skipEvent) {
                createEvent(
                    'Define Rule',
                    'REC',
                    { type: 'InterpretationRule', id: normalizedRule.rule_id },
                    { rule: normalizedRule, summary: normalizedRule.description },
                    { frame: normalizedRule.frame, scale: normalizedRule.scale }
                );
            }

            return normalizedRule;
        }

        function hideField(fieldId) {
            const view = getCurrentView();
            if (!view.hiddenFields.includes(fieldId)) view.hiddenFields.push(fieldId);
            renderCurrentView();
            showToast('‚úì Field hidden');
        }

        function deleteField(fieldId) {
            const set = getCurrentSet();
            const fieldIndex = set.schema.findIndex(f => f.id === fieldId);
            if (fieldIndex === -1) return;
            const [field] = set.schema.splice(fieldIndex, 1);
            set.records.forEach(record => delete record[fieldId]);
            createEvent(
                'Delete Field',
                'NUL',
                { type: 'Field', id: fieldId, setId: set.id },
                { setId: set.id, fieldId, fieldName: field?.name, summary: `Deleted field ${field?.name || fieldId}` },
                { frame: 'schema', scale: 'collection' }
            );
            renderCurrentView();
            showToast('‚úì Field deleted');
        }

        function deleteRecord(recordId) {
            const set = getCurrentSet();
            set.records.delete(recordId);
            createEvent(
                'Delete Record',
                'NUL',
                { type: 'Record', id: recordId, setId: set.id },
                { setId: set.id, recordId, summary: 'Record deleted' }
            );
            renderCurrentView();
            showToast('‚úì Record deleted');
        }

        // UTILITIES
        function applyInterpretationRules(event) {
            const appliedRules = [];

            state.interpretationRules.forEach(rule => {
                if (rule.applies_to_op && rule.applies_to_op !== event.op) return;

                switch (rule.effect) {
                    case 'require_actor':
                        if (!event.actor || !event.actor.id) throw new Error('Events require an actor');
                        appliedRules.push(rule.rule_id);
                        break;
                    case 'require_object_id':
                        if (!event.object || !event.object.id) throw new Error('Instantiation requires an object reference with an id');
                        appliedRules.push(rule.rule_id);
                        break;
                    case 'mark_deleted':
                        event.data = { ...event.data, deleted: true };
                        appliedRules.push(rule.rule_id);
                        break;
                    default:
                        break;
                }
            });

            return { ...event, appliedRules };
        }

        function createEvent(verb, op, object, data = {}, options = {}) {
            if (!state.operatorSet[op]) {
                throw new Error(`Invalid operator ${op}. Expected one of ${Object.keys(state.operatorSet).join(', ')}`);
            }

            const eventData = { ...data };

            if (options.summary && !eventData.summary) {
                eventData.summary = options.summary;
            }

            const event = {
                id: `event-${state.eventIdCounter++}`,
                verb: verb,
                op: op,
                frame: options.frame || 'ui',
                scale: options.scale || 'object',
                published: new Date().toISOString(),
                actor: { type: state.currentUser.type, id: state.currentUser.id },
                object: object,
                data: eventData
            };

            const interpretedEvent = applyInterpretationRules(event);
            state.eventStream.unshift(interpretedEvent);
            return interpretedEvent;
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            state.modalStack.push(modalId);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            state.modalStack = state.modalStack.filter(id => id !== modalId);
        }

        function exportJSON() {
            const data = {
                sets: Array.from(state.sets.values()).map(s => ({
                    ...s,
                    records: Array.from(s.records.values()),
                    views: Array.from(s.views.values()),
                    profiles: Array.from(s.profiles.values()),
                    connections: Array.from(s.connections?.values() || [])
                })),
                eventStream: state.eventStream
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workbase-export.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('‚úì Exported data');
        }

        function renderHistory() {
            const container = document.getElementById('historyContent');
            container.innerHTML = state.eventStream.map(e => `
                <div class="history-entry">
                    <div class="font-medium">${e.verb} <span class="text-xs text-gray-500">(${e.op})</span></div>
                    <div class="text-sm text-gray-500">${getTimeAgo(e.published)} ‚Ä¢ Frame: ${e.frame} ‚Ä¢ Scale: ${e.scale}</div>
                    <div class="text-sm">${e.data?.summary || e.verb}</div>
                    ${e.appliedRules?.length ? `<div class="text-xs text-gray-400">Rules: ${e.appliedRules.join(', ')}</div>` : ''}
                </div>
            `).join('');
        }

        // EVENT LISTENERS
        function setupEventListeners() {
            document.getElementById('addRecordBtn').onclick = () => {
                const set = getCurrentSet();
                const record = { id: `rec_${Date.now()}` };
                set.schema.forEach(f => {
                    const defaultValue = FIELD_TYPES[f.type].defaultValue;
                    record[f.id] = Array.isArray(defaultValue) ? [...defaultValue] : defaultValue;
                    if (f.type === 'CONNECTION' && !set.connections.has(f.id)) {
                        set.connections.set(f.id, { fieldId: f.id, config: f.config || {}, edges: [] });
                    }
                });
                set.records.set(record.id, record);
                renderCurrentView();
                showToast('‚úì Record added');
            };
            document.getElementById('addFieldBtn').onclick = openAddFieldModal;
            document.getElementById('filterBtn').onclick = openFilterModal;
            document.getElementById('historyBtn').onclick = () => {
                document.getElementById('historyPanel').classList.add('open');
                renderHistory();
            };
            document.getElementById('viewJsonBtn').onclick = openJsonViewer;
            document.getElementById('exportBtn').onclick = exportJSON;
            document.getElementById('closeHistoryBtn').onclick = () => document.getElementById('historyPanel').classList.remove('open');
            document.getElementById('toggleHistorySidebarBtn').onclick = toggleRecordHistoryVisibility;
            document.getElementById('closeExpandedRecordBtn').onclick = () => closeModal('expandedRecordModal');
            document.getElementById('closeFilterBtn').onclick = () => closeModal('filterModal');
            document.getElementById('applyFiltersBtn').onclick = applyFilters;
            document.getElementById('clearFiltersBtn').onclick = clearFilters;
            document.getElementById('addFilterGroupBtn').onclick = addFilterGroup;
            document.getElementById('confirmCancelBtn').onclick = () => {
                state.confirmCallback = null;
                closeModal('confirmModal');
            };
            document.getElementById('confirmOkBtn').onclick = () => {
                if (state.confirmCallback) state.confirmCallback();
                state.confirmCallback = null;
                closeModal('confirmModal');
            };
            document.getElementById('saveAddFieldBtn').onclick = saveField;
            document.getElementById('cancelAddFieldBtn').onclick = () => closeModal('addFieldModal');
            document.getElementById('closeAddFieldBtn').onclick = () => closeModal('addFieldModal');
            document.getElementById('saveAddSetBtn').onclick = () => {
                const name = document.getElementById('newSetName').value.trim();
                const icon = document.getElementById('newSetIcon').value.trim() || 'üìä';
                if (!name) { showConfirm('Please enter a set name', () => {}); return; }
                const setId = createSet(name, icon);
                closeModal('addSetModal');
                document.getElementById('newSetName').value = '';
                document.getElementById('newSetIcon').value = '';
                createView(setId, 'All ' + name, { type: 'grid' });
                state.expandedSets.add(setId);
                renderSidebar();
                switchSet(setId, null);
                showToast('‚úì Set created');
            };
            document.getElementById('cancelAddSetBtn').onclick = () => closeModal('addSetModal');
            document.getElementById('saveAddViewBtn').onclick = () => {
                const name = document.getElementById('newViewName').value.trim();
                if (!name) { showConfirm('Please enter a view name', () => {}); return; }
                const viewId = createView(state.currentSetId, name, { type: 'grid' });
                closeModal('addViewModal');
                document.getElementById('newViewName').value = '';
                renderSidebar();
                switchSet(state.currentSetId, viewId);
                showToast('‚úì View created');
            };
            document.getElementById('cancelAddViewBtn').onclick = () => closeModal('addViewModal');
            document.getElementById('saveKanbanConfigBtn').onclick = saveKanbanConfig;
            document.getElementById('cancelKanbanConfigBtn').onclick = () => closeModal('kanbanConfigModal');
            document.getElementById('closeJsonViewerBtn').onclick = () => closeModal('jsonViewerModal');
            document.getElementById('copyJsonBtn').onclick = copyJsonToClipboard;
        }

        // JSON VIEWER
        let currentJsonTab = 'all';
        
        function openJsonViewer() {
            currentJsonTab = 'all';
            renderJsonContent();
            openModal('jsonViewerModal');
        }
        
        function switchJsonTab(tab) {
            currentJsonTab = tab;
            document.querySelectorAll('.json-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.json-tab[data-tab="${tab}"]`).classList.add('active');
            renderJsonContent();
        }
        
        function renderJsonContent() {
            let data;
            
            switch(currentJsonTab) {
                case 'all':
                    data = {
                        sets: Array.from(state.sets.values()).map(s => ({
                            ...s,
                            records: Array.from(s.records.values()),
                            views: Array.from(s.views.values()),
                            profiles: Array.from(s.profiles.values()),
                            connections: Array.from(s.connections?.values() || [])
                        })),
                        eventStream: state.eventStream,
                        operatorSet: state.operatorSet,
                        interpretationRules: state.interpretationRules,
                        currentSetId: state.currentSetId,
                        currentViewId: state.currentViewId
                    };
                    break;
                case 'sets':
                    data = Array.from(state.sets.values()).map(s => ({
                        id: s.id,
                        name: s.name,
                        icon: s.icon,
                        schema: s.schema,
                        recordCount: s.records.size,
                        viewCount: s.views.size,
                        records: Array.from(s.records.values()),
                        views: Array.from(s.views.values()),
                        connections: Array.from(s.connections?.values() || [])
                    }));
                    break;
                case 'current':
                    const set = getCurrentSet();
                    data = set ? {
                        id: set.id,
                        name: set.name,
                        icon: set.icon,
                        schema: set.schema,
                        records: Array.from(set.records.values()),
                        views: Array.from(set.views.values()),
                        profiles: Array.from(set.profiles.values()),
                        connections: Array.from(set.connections?.values() || [])
                    } : null;
                    break;
                case 'events':
                    data = state.eventStream;
                    break;
            }
            
            const jsonString = JSON.stringify(data, null, 2);
            const highlighted = syntaxHighlight(jsonString);
            document.getElementById('jsonContent').innerHTML = highlighted;
        }
        
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function copyJsonToClipboard() {
            const content = document.getElementById('jsonContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyJsonBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }, 2000);
            }).catch(err => {
                showToast('‚ö†Ô∏è Failed to copy');
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && state.modalStack.length > 0) {
                    closeModal(state.modalStack[state.modalStack.length - 1]);
                }
            });
        }

        function openAddSetModal() {
            openModal('addSetModal');
        }

        // INITIALIZE
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
